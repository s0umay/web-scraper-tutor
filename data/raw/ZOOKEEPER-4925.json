{"expand": "operations,versionedRepresentations,editmeta,changelog,renderedFields", "id": "13616749", "self": "https://issues.apache.org/jira/rest/api/2/issue/13616749", "key": "ZOOKEEPER-4925", "fields": {"fixVersions": [{"self": "https://issues.apache.org/jira/rest/api/2/version/12353481", "id": "12353481", "name": "3.10.0", "archived": false, "released": false}, {"self": "https://issues.apache.org/jira/rest/api/2/version/12355230", "id": "12355230", "description": "", "name": "3.9.4", "archived": false, "released": true, "releaseDate": "2025-08-29"}], "resolution": {"self": "https://issues.apache.org/jira/rest/api/2/resolution/1", "id": "1", "description": "A fix for this issue is checked into the tree and tested.", "name": "Fixed"}, "customfield_12312322": null, "customfield_12312323": null, "customfield_12310420": "9223372036854775807", "customfield_12312320": null, "customfield_12312321": null, "customfield_12312328": null, "customfield_12312329": null, "customfield_12312326": null, "customfield_12310300": null, "customfield_12312327": null, "customfield_12312324": null, "customfield_12312720": null, "customfield_12312325": null, "lastViewed": null, "priority": {"self": "https://issues.apache.org/jira/rest/api/2/priority/2", "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/critical.svg", "name": "Critical", "id": "2"}, "labels": ["data-loss", "pull-request-available"], "customfield_12312333": null, "customfield_12312334": null, "customfield_12313422": "false", "customfield_12310310": "0.0", "customfield_12312331": null, "customfield_12312332": null, "aggregatetimeoriginalestimate": null, "timeestimate": 0, "customfield_12312330": null, "versions": [{"self": "https://issues.apache.org/jira/rest/api/2/version/12354432", "id": "12354432", "description": "", "name": "3.9.3", "archived": false, "released": true, "releaseDate": "2024-10-24"}], "customfield_12311120": null, "customfield_12313826": null, "issuelinks": [{"id": "12702066", "self": "https://issues.apache.org/jira/rest/api/2/issueLink/12702066", "type": {"id": "12310560", "name": "Problem/Incident", "inward": "is caused by", "outward": "causes", "self": "https://issues.apache.org/jira/rest/api/2/issueLinkType/12310560"}, "inwardIssue": {"id": "13405756", "key": "ZOOKEEPER-4394", "self": "https://issues.apache.org/jira/rest/api/2/issue/13405756", "fields": {"summary": "Learner.syncWithLeader got NullPointerException", "status": {"self": "https://issues.apache.org/jira/rest/api/2/status/6", "description": "The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.", "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/closed.png", "name": "Closed", "id": "6", "statusCategory": {"self": "https://issues.apache.org/jira/rest/api/2/statuscategory/3", "id": 3, "key": "done", "colorName": "green", "name": "Done"}}, "priority": {"self": "https://issues.apache.org/jira/rest/api/2/priority/3", "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/major.svg", "name": "Major", "id": "3"}, "issuetype": {"self": "https://issues.apache.org/jira/rest/api/2/issuetype/1", "id": "1", "description": "A problem which impairs or prevents the functions of the product.", "iconUrl": "https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype", "name": "Bug", "subtask": false, "avatarId": 21133}}}}, {"id": "12702067", "self": "https://issues.apache.org/jira/rest/api/2/issueLink/12702067", "type": {"id": "10030", "name": "Reference", "inward": "is related to", "outward": "relates to", "self": "https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"}, "outwardIssue": {"id": "13248440", "key": "ZOOKEEPER-3484", "self": "https://issues.apache.org/jira/rest/api/2/issue/13248440", "fields": {"summary": "Improve the throughput by optimizing the synchronization around outstandingChanges", "status": {"self": "https://issues.apache.org/jira/rest/api/2/status/5", "description": "A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.", "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/resolved.png", "name": "Resolved", "id": "5", "statusCategory": {"self": "https://issues.apache.org/jira/rest/api/2/statuscategory/3", "id": 3, "key": "done", "colorName": "green", "name": "Done"}}, "priority": {"self": "https://issues.apache.org/jira/rest/api/2/priority/3", "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/major.svg", "name": "Major", "id": "3"}, "issuetype": {"self": "https://issues.apache.org/jira/rest/api/2/issuetype/4", "id": "4", "description": "An improvement or enhancement to an existing feature or task.", "iconUrl": "https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21140&avatarType=issuetype", "name": "Improvement", "subtask": false, "avatarId": 21140}}}}], "customfield_12312339": null, "customfield_12313825": null, "assignee": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=kezhuw", "name": "kezhuw", "key": "kezhuw", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=kezhuw&avatarId=37929", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kezhuw&avatarId=37929", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kezhuw&avatarId=37929", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kezhuw&avatarId=37929"}, "displayName": "Kezhu Wang", "active": true, "timeZone": "Etc/GMT-8"}, "customfield_12312337": null, "customfield_12313823": null, "customfield_12312338": null, "customfield_12311920": null, "customfield_12313822": null, "customfield_12312335": null, "customfield_12313821": null, "customfield_12312336": null, "customfield_12313820": null, "status": {"self": "https://issues.apache.org/jira/rest/api/2/status/6", "description": "The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.", "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/closed.png", "name": "Closed", "id": "6", "statusCategory": {"self": "https://issues.apache.org/jira/rest/api/2/statuscategory/3", "id": 3, "key": "done", "colorName": "green", "name": "Done"}}, "components": [{"self": "https://issues.apache.org/jira/rest/api/2/component/12312382", "id": "12312382", "name": "server", "description": "General issues with the ZooKeeper server."}], "archiveddate": null, "customfield_12312026": null, "customfield_12312023": null, "customfield_12312024": null, "aggregatetimeestimate": 0, "customfield_12312022": null, "customfield_12310921": null, "customfield_12310920": "9223372036854775807", "customfield_12312823": null, "creator": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=kezhuw", "name": "kezhuw", "key": "kezhuw", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=kezhuw&avatarId=37929", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kezhuw&avatarId=37929", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kezhuw&avatarId=37929", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kezhuw&avatarId=37929"}, "displayName": "Kezhu Wang", "active": true, "timeZone": "Etc/GMT-8"}, "subtasks": [], "reporter": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=kezhuw", "name": "kezhuw", "key": "kezhuw", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=kezhuw&avatarId=37929", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kezhuw&avatarId=37929", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kezhuw&avatarId=37929", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kezhuw&avatarId=37929"}, "displayName": "Kezhu Wang", "active": true, "timeZone": "Etc/GMT-8"}, "aggregateprogress": {"progress": 15000, "total": 15000, "percent": 100}, "customfield_12313520": null, "customfield_12310250": null, "progress": {"progress": 15000, "total": 15000, "percent": 100}, "customfield_12313924": null, "votes": {"self": "https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-4925/votes", "votes": 0, "hasVoted": false}, "worklog": {"startAt": 0, "maxResults": 20, "total": 25, "worklogs": [{"self": "https://issues.apache.org/jira/rest/api/2/issue/13616749/worklog/968455", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "comment": "kezhuw opened a new pull request, #2254:\nURL: https://github.com/apache/zookeeper/pull/2254\n\n   There are two variants of `ZooKeeperServer::processTxn`. Those two variants diverge significantly since ZOOKEEPER-3484. `processTxn(Request request)` pops outstanding change from `outstandingChanges` and adds txn to `committedLog` for follower to sync in addition to what `processTxn(TxnHeader hdr, Record txn)` does. The `Learner` uses `processTxn(TxnHeader hdr, Record txn)` to commit txn to memory after ZOOKEEPER-4394, which means it leaves `committedLog` untouched in `SYNCHRONIZATION` phase.\r\n   \r\n   This way, a stale follower will have hole in its `committedLog` after joining cluster. The stale follower will propagate the in memory hole to other stale nodes after becoming leader. This causes data loss.\r\n   \r\n   The test case fails on master and 3.9.3, and passes on 3.9.2. So only 3.9.3 is affected.\r\n   \r\n   This commit drops `processTxn(TxnHeader hdr, Record txn)` as `processTxn(Request request)` is capable in `SYNCHRONIZATION` phase too.\r\n   \r\n   Also, this commit rejects discontinuous proposals in `syncWithLeader` and `committedLog`, so to avoid possible data loss.\r\n   \r\n   Refs: ZOOKEEPER-4925, ZOOKEEPER-4394, ZOOKEEPER-3484\n\n\n", "created": "2025-05-04T12:27:41.930+0000", "updated": "2025-05-04T12:27:41.930+0000", "started": "2025-05-04T12:27:41.929+0000", "timeSpent": "10m", "timeSpentSeconds": 600, "id": "968455", "issueId": "13616749"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13616749/worklog/971539", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "comment": "li4wang commented on code in PR #2254:\nURL: https://github.com/apache/zookeeper/pull/2254#discussion_r2121930956\n\n\n##########\nzookeeper-server/src/test/java/org/apache/zookeeper/server/quorum/QuorumSyncTest.java:\n##########\n@@ -0,0 +1,100 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.zookeeper.server.quorum;\n+\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+import java.util.Comparator;\n+import org.apache.zookeeper.CreateMode;\n+import org.apache.zookeeper.ZKTestCase;\n+import org.apache.zookeeper.ZooDefs;\n+import org.apache.zookeeper.ZooKeeper;\n+import org.apache.zookeeper.test.ClientBase;\n+import org.apache.zookeeper.test.QuorumUtil;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.Test;\n+\n+public class QuorumSyncTest extends ZKTestCase {\n+    private QuorumUtil qu;\n+\n+    @AfterEach\n+    public void tearDown() throws Exception {\n+        if (qu != null) {\n+            qu.shutdownAll();\n+        }\n+    }\n+\n+    @Test\n+    public void testStaleDiffSync() throws Exception {\n+        qu = new QuorumUtil(2);\n+        qu.startAll();\n+\n+        int[] followerIds = qu.getFollowerQuorumPeers()\n+            .stream()\n+            .sorted(Comparator.comparingLong(QuorumPeer::getMyId).reversed())\n+            .mapToInt(peer -> (int) peer.getMyId()).toArray();\n+\n+        int follower1 = followerIds[0];\n+        int follower2 = followerIds[1];\n+\n+        String leaderConnectString = qu.getConnectString(qu.getLeaderQuorumPeer());\n+        try (ZooKeeper zk = ClientBase.createZKClient(leaderConnectString)) {\n+            qu.shutdown(follower2);\n+\n+            for (int i = 0; i < 10; i++) {\n+                zk.create(\"/foo\" + i, null, ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);\n+            }\n+\n+            qu.shutdown(follower1);\n+\n+            for (int i = 0; i < 10; i++) {\n+                zk.create(\"/bar\" + i, null, ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);\n+            }\n+\n+            qu.restart(follower1);\n+        }\n+\n+        try (ZooKeeper zk = ClientBase.createZKClient(qu.getConnectionStringForServer(follower1))) {\n+            for (int i = 0; i < 10; i++) {\n+                String path = \"/foo\" + i;\n+                assertNotNull(zk.exists(path, false), path + \" not found\");\n+            }\n+\n+            for (int i = 0; i < 10; i++) {\n\nReview Comment:\n   How about adding the JIRA ticket to help people understand the issue and fix? Basically all the /boo related txns are  synced via DIFF and added to the committed logs with the fix.\n\n\n\n", "created": "2025-06-02T18:55:29.634+0000", "updated": "2025-06-02T18:55:29.634+0000", "started": "2025-06-02T18:55:29.633+0000", "timeSpent": "10m", "timeSpentSeconds": 600, "id": "971539", "issueId": "13616749"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13616749/worklog/971544", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "comment": "li4wang commented on code in PR #2254:\nURL: https://github.com/apache/zookeeper/pull/2254#discussion_r2121953646\n\n\n##########\nzookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/Learner.java:\n##########\n@@ -780,8 +803,8 @@ protected void syncWithLeader(long newLeaderZxid) throws Exception {\n                                 continue;\n                             }\n                             packetsNotLogged.removeFirst();\n-                            fzk.appendRequest(pif.hdr, pif.rec, pif.digest);\n-                            fzk.processTxn(pif.hdr, pif.rec);\n+                            fzk.appendRequest(pif.toRequest());\n+                            fzk.processTxn(pif.toRequest());\n\nReview Comment:\n   nitpick\r\n   \r\n   \r\n   \r\n   ```suggestion\r\n   Request request = pif.toRequest()\r\n   fzk.appendRequest(request)\r\n   fzk.processTxn（request)\r\n   ```\r\n   \r\n   \n\n\n\n", "created": "2025-06-02T19:09:40.966+0000", "updated": "2025-06-02T19:09:40.966+0000", "started": "2025-06-02T19:09:40.966+0000", "timeSpent": "10m", "timeSpentSeconds": 600, "id": "971544", "issueId": "13616749"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13616749/worklog/971545", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "comment": "li4wang commented on code in PR #2254:\nURL: https://github.com/apache/zookeeper/pull/2254#discussion_r2121953646\n\n\n##########\nzookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/Learner.java:\n##########\n@@ -780,8 +803,8 @@ protected void syncWithLeader(long newLeaderZxid) throws Exception {\n                                 continue;\n                             }\n                             packetsNotLogged.removeFirst();\n-                            fzk.appendRequest(pif.hdr, pif.rec, pif.digest);\n-                            fzk.processTxn(pif.hdr, pif.rec);\n+                            fzk.appendRequest(pif.toRequest());\n+                            fzk.processTxn(pif.toRequest());\n\nReview Comment:\n   nitpick\r\n   \r\n   How about create the request object and reuse it instead of converting twice?\r\n   \r\n   ```\r\n   Request request = pif.toRequest()\r\n   fzk.appendRequest(request)\r\n   fzk.processTxn（request)\r\n   \r\n   ```\n\n\n\n", "created": "2025-06-02T19:11:05.102+0000", "updated": "2025-06-02T19:11:05.102+0000", "started": "2025-06-02T19:11:05.102+0000", "timeSpent": "10m", "timeSpentSeconds": 600, "id": "971545", "issueId": "13616749"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13616749/worklog/971547", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "comment": "li4wang commented on code in PR #2254:\nURL: https://github.com/apache/zookeeper/pull/2254#discussion_r2121976783\n\n\n##########\nzookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/Learner.java:\n##########\n@@ -696,18 +710,27 @@ protected void syncWithLeader(long newLeaderZxid) throws Exception {\n                         packet.rec = logEntry.getTxn();\n                         packet.hdr = logEntry.getHeader();\n                         packet.digest = logEntry.getDigest();\n-                        // Log warning message if txn comes out-of-order\n-                        if (packet.hdr.getZxid() != lastQueued + 1) {\n-                            LOG.warn(\n-                                \"Got zxid 0x{} expected 0x{}\",\n-                                Long.toHexString(packet.hdr.getZxid()),\n-                                Long.toHexString(lastQueued + 1));\n+                        if (lastQueued == 0) {\n+                            LOG.info(\"DIFF sync got first proposal 0x{}\", Long.toHexString(packet.hdr.getZxid()));\n+                        } else if (packet.hdr.getZxid() != lastQueued + 1) {\n+                            if (ZxidUtils.getEpochFromZxid(packet.hdr.getZxid()) <= ZxidUtils.getEpochFromZxid(lastQueued)) {\n+                                String msg = String.format(\"DIFF sync got proposal 0x%s which is not next of last proposal 0x%s\",\n+                                    Long.toHexString(packet.hdr.getZxid()),\n+                                    Long.toHexString(lastQueued));\n+                                LOG.error(msg);\n+                                throw new Exception(msg);\n+                            }\n+                            // We can't tell whether it is a data loss. Given that new epoch is rare,\n+                            // log at warn should not be too verbose.\n+                            LOG.warn(\"DIFF sync got new epoch proposal 0x{}, last proposal 0x{}\",\n+                                    Long.toHexString(packet.hdr.getZxid()),\n+                                    Long.toHexString(lastQueued));\n\nReview Comment:\n   This is the same code as line 637-651. How about creating a common method to check if proposal is out of order so it can be used in both places?\n\n\n\n", "created": "2025-06-02T19:23:12.313+0000", "updated": "2025-06-02T19:23:12.313+0000", "started": "2025-06-02T19:23:12.313+0000", "timeSpent": "10m", "timeSpentSeconds": 600, "id": "971547", "issueId": "13616749"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13616749/worklog/971550", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "comment": "li4wang commented on code in PR #2254:\nURL: https://github.com/apache/zookeeper/pull/2254#discussion_r2121999705\n\n\n##########\nzookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/Learner.java:\n##########\n@@ -630,11 +634,21 @@ protected void syncWithLeader(long newLeaderZxid) throws Exception {\n                     pif.hdr = logEntry.getHeader();\n                     pif.rec = logEntry.getTxn();\n                     pif.digest = logEntry.getDigest();\n-                    if (pif.hdr.getZxid() != lastQueued + 1) {\n-                        LOG.warn(\n-                            \"Got zxid 0x{} expected 0x{}\",\n+                    if (lastQueued == 0) {\n+                        LOG.info(\"DIFF sync got first proposal 0x{}\", Long.toHexString(pif.hdr.getZxid()));\n+                    } else if (pif.hdr.getZxid() != lastQueued + 1) {\n+                        if (ZxidUtils.getEpochFromZxid(pif.hdr.getZxid()) <= ZxidUtils.getEpochFromZxid(lastQueued)) {\n+                            String msg = String.format(\"DIFF sync got proposal 0x%s which is not next of last proposal 0x%s\",\n+                                Long.toHexString(pif.hdr.getZxid()),\n+                                Long.toHexString(lastQueued));\n+                            LOG.error(msg);\n+                            throw new Exception(msg);\n+                        }\n+                        // We can't tell whether it is a data loss. Given that new epoch is rare,\n+                        // log at warn should not be too verbose.\n+                        LOG.warn(\"DIFF sync got new epoch proposal 0x{}, last proposal 0x{}\",\n\nReview Comment:\n   How about  keeping the original WARN statement, so it's very clear what is the actual, what is the expected?\n\n\n\n", "created": "2025-06-02T19:34:51.106+0000", "updated": "2025-06-02T19:34:51.106+0000", "started": "2025-06-02T19:34:51.105+0000", "timeSpent": "10m", "timeSpentSeconds": 600, "id": "971550", "issueId": "13616749"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13616749/worklog/971551", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "comment": "li4wang commented on code in PR #2254:\nURL: https://github.com/apache/zookeeper/pull/2254#discussion_r2121999705\n\n\n##########\nzookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/Learner.java:\n##########\n@@ -630,11 +634,21 @@ protected void syncWithLeader(long newLeaderZxid) throws Exception {\n                     pif.hdr = logEntry.getHeader();\n                     pif.rec = logEntry.getTxn();\n                     pif.digest = logEntry.getDigest();\n-                    if (pif.hdr.getZxid() != lastQueued + 1) {\n-                        LOG.warn(\n-                            \"Got zxid 0x{} expected 0x{}\",\n+                    if (lastQueued == 0) {\n+                        LOG.info(\"DIFF sync got first proposal 0x{}\", Long.toHexString(pif.hdr.getZxid()));\n+                    } else if (pif.hdr.getZxid() != lastQueued + 1) {\n+                        if (ZxidUtils.getEpochFromZxid(pif.hdr.getZxid()) <= ZxidUtils.getEpochFromZxid(lastQueued)) {\n+                            String msg = String.format(\"DIFF sync got proposal 0x%s which is not next of last proposal 0x%s\",\n+                                Long.toHexString(pif.hdr.getZxid()),\n+                                Long.toHexString(lastQueued));\n+                            LOG.error(msg);\n+                            throw new Exception(msg);\n+                        }\n+                        // We can't tell whether it is a data loss. Given that new epoch is rare,\n+                        // log at warn should not be too verbose.\n+                        LOG.warn(\"DIFF sync got new epoch proposal 0x{}, last proposal 0x{}\",\n\nReview Comment:\n   How about  keeping the original WARN statement, so it's very clear what is the actual and what is the expected?\n\n\n\n", "created": "2025-06-02T19:35:08.426+0000", "updated": "2025-06-02T19:35:08.426+0000", "started": "2025-06-02T19:35:08.425+0000", "timeSpent": "10m", "timeSpentSeconds": 600, "id": "971551", "issueId": "13616749"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13616749/worklog/971559", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "comment": "li4wang commented on code in PR #2254:\nURL: https://github.com/apache/zookeeper/pull/2254#discussion_r2122040634\n\n\n##########\nzookeeper-server/src/main/java/org/apache/zookeeper/server/ZKDatabase.java:\n##########\n@@ -320,17 +323,30 @@ public void addCommittedProposal(Request request) {\n         WriteLock wl = logLock.writeLock();\n         try {\n             wl.lock();\n-            if (committedLog.size() > commitLogCount) {\n-                committedLog.remove();\n-                minCommittedLog = committedLog.peek().getZxid();\n-            }\n             if (committedLog.isEmpty()) {\n                 minCommittedLog = request.zxid;\n                 maxCommittedLog = request.zxid;\n+            } else if (request.zxid <= maxCommittedLog) {\n+                // This could happen if lastProcessedZxid is rewinded and database is re-synced.\n+                // Currently, it only happens in test codes, but it should also be safe for production path.\n+                return;\n+            } else if (!allowDiscontinuousProposals\n+                    && request.zxid != maxCommittedLog + 1\n+                    && ZxidUtils.getEpochFromZxid(request.zxid) <= ZxidUtils.getEpochFromZxid(maxCommittedLog)) {\n+                String msg = String.format(\n+                    \"Committed proposal cached out of order: 0x%s is not the next proposal of 0x%s\",\n+                    ZxidUtils.zxidToString(request.zxid),\n+                    ZxidUtils.zxidToString(maxCommittedLog));\n+                LOG.error(msg);\n+                throw new IllegalStateException(msg);\n\nReview Comment:\n   Do we have a test case for it?\n\n\n\n", "created": "2025-06-02T19:59:29.715+0000", "updated": "2025-06-02T19:59:29.715+0000", "started": "2025-06-02T19:59:29.714+0000", "timeSpent": "10m", "timeSpentSeconds": 600, "id": "971559", "issueId": "13616749"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13616749/worklog/971564", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "comment": "li4wang commented on code in PR #2254:\nURL: https://github.com/apache/zookeeper/pull/2254#discussion_r2122042468\n\n\n##########\nzookeeper-server/src/main/java/org/apache/zookeeper/server/ZKDatabase.java:\n##########\n@@ -320,17 +323,30 @@ public void addCommittedProposal(Request request) {\n         WriteLock wl = logLock.writeLock();\n         try {\n             wl.lock();\n-            if (committedLog.size() > commitLogCount) {\n-                committedLog.remove();\n-                minCommittedLog = committedLog.peek().getZxid();\n-            }\n             if (committedLog.isEmpty()) {\n                 minCommittedLog = request.zxid;\n                 maxCommittedLog = request.zxid;\n+            } else if (request.zxid <= maxCommittedLog) {\n+                // This could happen if lastProcessedZxid is rewinded and database is re-synced.\n+                // Currently, it only happens in test codes, but it should also be safe for production path.\n\nReview Comment:\n   Adding a test case for the scenario?\n\n\n\n", "created": "2025-06-02T20:00:39.807+0000", "updated": "2025-06-02T20:00:39.807+0000", "started": "2025-06-02T20:00:39.807+0000", "timeSpent": "10m", "timeSpentSeconds": 600, "id": "971564", "issueId": "13616749"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13616749/worklog/971565", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "comment": "li4wang commented on code in PR #2254:\nURL: https://github.com/apache/zookeeper/pull/2254#discussion_r2122042468\n\n\n##########\nzookeeper-server/src/main/java/org/apache/zookeeper/server/ZKDatabase.java:\n##########\n@@ -320,17 +323,30 @@ public void addCommittedProposal(Request request) {\n         WriteLock wl = logLock.writeLock();\n         try {\n             wl.lock();\n-            if (committedLog.size() > commitLogCount) {\n-                committedLog.remove();\n-                minCommittedLog = committedLog.peek().getZxid();\n-            }\n             if (committedLog.isEmpty()) {\n                 minCommittedLog = request.zxid;\n                 maxCommittedLog = request.zxid;\n+            } else if (request.zxid <= maxCommittedLog) {\n+                // This could happen if lastProcessedZxid is rewinded and database is re-synced.\n+                // Currently, it only happens in test codes, but it should also be safe for production path.\n\nReview Comment:\n   How about adding a test case for the scenario?\n\n\n\n", "created": "2025-06-02T20:04:17.747+0000", "updated": "2025-06-02T20:04:17.747+0000", "started": "2025-06-02T20:04:17.746+0000", "timeSpent": "10m", "timeSpentSeconds": 600, "id": "971565", "issueId": "13616749"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13616749/worklog/971570", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "comment": "li4wang commented on PR #2254:\nURL: https://github.com/apache/zookeeper/pull/2254#issuecomment-2932370939\n\n   The changes for fixing the data loss issue looks good. It's a very critical issue. Thanks for fixing it.\r\n   \r\n   The changes for blocking proposal and commit requests being out of order looks good in general, but please make sure it doesn't introduce any unexpected issue.\n\n\n", "created": "2025-06-02T20:27:54.445+0000", "updated": "2025-06-02T20:27:54.445+0000", "started": "2025-06-02T20:27:54.444+0000", "timeSpent": "10m", "timeSpentSeconds": 600, "id": "971570", "issueId": "13616749"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13616749/worklog/971581", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "comment": "kezhuw commented on code in PR #2254:\nURL: https://github.com/apache/zookeeper/pull/2254#discussion_r2122561575\n\n\n##########\nzookeeper-server/src/main/java/org/apache/zookeeper/server/ZKDatabase.java:\n##########\n@@ -320,17 +323,30 @@ public void addCommittedProposal(Request request) {\n         WriteLock wl = logLock.writeLock();\n         try {\n             wl.lock();\n-            if (committedLog.size() > commitLogCount) {\n-                committedLog.remove();\n-                minCommittedLog = committedLog.peek().getZxid();\n-            }\n             if (committedLog.isEmpty()) {\n                 minCommittedLog = request.zxid;\n                 maxCommittedLog = request.zxid;\n+            } else if (request.zxid <= maxCommittedLog) {\n+                // This could happen if lastProcessedZxid is rewinded and database is re-synced.\n+                // Currently, it only happens in test codes, but it should also be safe for production path.\n\nReview Comment:\n   `LoadFromLogTest::testRestore` fails without this. Here is the javadoc of the test.\r\n   \r\n   ```java\r\n       /**\r\n        * Test we can restore the snapshot that has data ahead of the zxid\r\n        * of the snapshot file.\r\n        */\r\n   ```\r\n   \r\n   https://github.com/apache/zookeeper/blob/aeadf574c0463e7e3db092b588033d8347989d4c/zookeeper-server/src/test/java/org/apache/zookeeper/test/LoadFromLogTest.java#L178-L182\n\n\n\n", "created": "2025-06-03T03:28:21.963+0000", "updated": "2025-06-03T03:28:21.963+0000", "started": "2025-06-03T03:28:21.962+0000", "timeSpent": "10m", "timeSpentSeconds": 600, "id": "971581", "issueId": "13616749"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13616749/worklog/971584", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "comment": "kezhuw commented on code in PR #2254:\nURL: https://github.com/apache/zookeeper/pull/2254#discussion_r2122595721\n\n\n##########\nzookeeper-server/src/main/java/org/apache/zookeeper/server/ZKDatabase.java:\n##########\n@@ -320,17 +323,30 @@ public void addCommittedProposal(Request request) {\n         WriteLock wl = logLock.writeLock();\n         try {\n             wl.lock();\n-            if (committedLog.size() > commitLogCount) {\n-                committedLog.remove();\n-                minCommittedLog = committedLog.peek().getZxid();\n-            }\n             if (committedLog.isEmpty()) {\n                 minCommittedLog = request.zxid;\n                 maxCommittedLog = request.zxid;\n+            } else if (request.zxid <= maxCommittedLog) {\n+                // This could happen if lastProcessedZxid is rewinded and database is re-synced.\n+                // Currently, it only happens in test codes, but it should also be safe for production path.\n+                return;\n+            } else if (!allowDiscontinuousProposals\n+                    && request.zxid != maxCommittedLog + 1\n+                    && ZxidUtils.getEpochFromZxid(request.zxid) <= ZxidUtils.getEpochFromZxid(maxCommittedLog)) {\n+                String msg = String.format(\n+                    \"Committed proposal cached out of order: 0x%s is not the next proposal of 0x%s\",\n+                    ZxidUtils.zxidToString(request.zxid),\n+                    ZxidUtils.zxidToString(maxCommittedLog));\n+                LOG.error(msg);\n+                throw new IllegalStateException(msg);\n\nReview Comment:\n   I think it is already covered by existing tests. `allowDiscontinuousProposals`(used by `ZxidRolloverTest`, `TxnLogDigestTest`, both introduce discontinuous proposals on purpose) was introduced to bypass this restriction.\r\n   \r\n   Also this path will fail newly introduced test if we rollback changes involed in sync phase.\r\n   \r\n   ```bash\r\n   git checkout HEAD^ ", "created": "2025-06-03T03:58:34.869+0000", "updated": "2025-06-03T03:58:34.869+0000", "started": "2025-06-03T03:58:34.868+0000", "timeSpent": "10m", "timeSpentSeconds": 600, "id": "971584", "issueId": "13616749"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13616749/worklog/971585", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "comment": "kezhuw commented on code in PR #2254:\nURL: https://github.com/apache/zookeeper/pull/2254#discussion_r2122629733\n\n\n##########\nzookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/Learner.java:\n##########\n@@ -630,11 +634,21 @@ protected void syncWithLeader(long newLeaderZxid) throws Exception {\n                     pif.hdr = logEntry.getHeader();\n                     pif.rec = logEntry.getTxn();\n                     pif.digest = logEntry.getDigest();\n-                    if (pif.hdr.getZxid() != lastQueued + 1) {\n-                        LOG.warn(\n-                            \"Got zxid 0x{} expected 0x{}\",\n+                    if (lastQueued == 0) {\n+                        LOG.info(\"DIFF sync got first proposal 0x{}\", Long.toHexString(pif.hdr.getZxid()));\n+                    } else if (pif.hdr.getZxid() != lastQueued + 1) {\n+                        if (ZxidUtils.getEpochFromZxid(pif.hdr.getZxid()) <= ZxidUtils.getEpochFromZxid(lastQueued)) {\n+                            String msg = String.format(\"DIFF sync got proposal 0x%s which is not next of last proposal 0x%s\",\n+                                Long.toHexString(pif.hdr.getZxid()),\n+                                Long.toHexString(lastQueued));\n+                            LOG.error(msg);\n+                            throw new Exception(msg);\n+                        }\n+                        // We can't tell whether it is a data loss. Given that new epoch is rare,\n+                        // log at warn should not be too verbose.\n+                        LOG.warn(\"DIFF sync got new epoch proposal 0x{}, last proposal 0x{}\",\n\nReview Comment:\n   Add expected zxid in newly introduced method `enforceContinuousProposal`.\n\n\n\n", "created": "2025-06-03T04:31:57.738+0000", "updated": "2025-06-03T04:31:57.738+0000", "started": "2025-06-03T04:31:57.738+0000", "timeSpent": "10m", "timeSpentSeconds": 600, "id": "971585", "issueId": "13616749"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13616749/worklog/971586", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "comment": "kezhuw commented on code in PR #2254:\nURL: https://github.com/apache/zookeeper/pull/2254#discussion_r2122631097\n\n\n##########\nzookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/Learner.java:\n##########\n@@ -696,18 +710,27 @@ protected void syncWithLeader(long newLeaderZxid) throws Exception {\n                         packet.rec = logEntry.getTxn();\n                         packet.hdr = logEntry.getHeader();\n                         packet.digest = logEntry.getDigest();\n-                        // Log warning message if txn comes out-of-order\n-                        if (packet.hdr.getZxid() != lastQueued + 1) {\n-                            LOG.warn(\n-                                \"Got zxid 0x{} expected 0x{}\",\n-                                Long.toHexString(packet.hdr.getZxid()),\n-                                Long.toHexString(lastQueued + 1));\n+                        if (lastQueued == 0) {\n+                            LOG.info(\"DIFF sync got first proposal 0x{}\", Long.toHexString(packet.hdr.getZxid()));\n+                        } else if (packet.hdr.getZxid() != lastQueued + 1) {\n+                            if (ZxidUtils.getEpochFromZxid(packet.hdr.getZxid()) <= ZxidUtils.getEpochFromZxid(lastQueued)) {\n+                                String msg = String.format(\"DIFF sync got proposal 0x%s which is not next of last proposal 0x%s\",\n+                                    Long.toHexString(packet.hdr.getZxid()),\n+                                    Long.toHexString(lastQueued));\n+                                LOG.error(msg);\n+                                throw new Exception(msg);\n+                            }\n+                            // We can't tell whether it is a data loss. Given that new epoch is rare,\n+                            // log at warn should not be too verbose.\n+                            LOG.warn(\"DIFF sync got new epoch proposal 0x{}, last proposal 0x{}\",\n+                                    Long.toHexString(packet.hdr.getZxid()),\n+                                    Long.toHexString(lastQueued));\n\nReview Comment:\n   Move them to `enforceContinuousProposal`.\n\n\n\n", "created": "2025-06-03T04:32:22.796+0000", "updated": "2025-06-03T04:32:22.796+0000", "started": "2025-06-03T04:32:22.795+0000", "timeSpent": "10m", "timeSpentSeconds": 600, "id": "971586", "issueId": "13616749"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13616749/worklog/971587", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "comment": "kezhuw commented on code in PR #2254:\nURL: https://github.com/apache/zookeeper/pull/2254#discussion_r2122631643\n\n\n##########\nzookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/Learner.java:\n##########\n@@ -780,8 +803,8 @@ protected void syncWithLeader(long newLeaderZxid) throws Exception {\n                                 continue;\n                             }\n                             packetsNotLogged.removeFirst();\n-                            fzk.appendRequest(pif.hdr, pif.rec, pif.digest);\n-                            fzk.processTxn(pif.hdr, pif.rec);\n+                            fzk.appendRequest(pif.toRequest());\n+                            fzk.processTxn(pif.toRequest());\n\nReview Comment:\n   Done.\n\n\n\n", "created": "2025-06-03T04:32:43.218+0000", "updated": "2025-06-03T04:32:43.218+0000", "started": "2025-06-03T04:32:43.217+0000", "timeSpent": "10m", "timeSpentSeconds": 600, "id": "971587", "issueId": "13616749"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13616749/worklog/971588", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "comment": "kezhuw commented on code in PR #2254:\nURL: https://github.com/apache/zookeeper/pull/2254#discussion_r2122632370\n\n\n##########\nzookeeper-server/src/test/java/org/apache/zookeeper/server/quorum/QuorumSyncTest.java:\n##########\n@@ -0,0 +1,100 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.zookeeper.server.quorum;\n+\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+import java.util.Comparator;\n+import org.apache.zookeeper.CreateMode;\n+import org.apache.zookeeper.ZKTestCase;\n+import org.apache.zookeeper.ZooDefs;\n+import org.apache.zookeeper.ZooKeeper;\n+import org.apache.zookeeper.test.ClientBase;\n+import org.apache.zookeeper.test.QuorumUtil;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.Test;\n+\n+public class QuorumSyncTest extends ZKTestCase {\n+    private QuorumUtil qu;\n+\n+    @AfterEach\n+    public void tearDown() throws Exception {\n+        if (qu != null) {\n+            qu.shutdownAll();\n+        }\n+    }\n+\n+    @Test\n+    public void testStaleDiffSync() throws Exception {\n+        qu = new QuorumUtil(2);\n+        qu.startAll();\n+\n+        int[] followerIds = qu.getFollowerQuorumPeers()\n+            .stream()\n+            .sorted(Comparator.comparingLong(QuorumPeer::getMyId).reversed())\n+            .mapToInt(peer -> (int) peer.getMyId()).toArray();\n+\n+        int follower1 = followerIds[0];\n+        int follower2 = followerIds[1];\n+\n+        String leaderConnectString = qu.getConnectString(qu.getLeaderQuorumPeer());\n+        try (ZooKeeper zk = ClientBase.createZKClient(leaderConnectString)) {\n+            qu.shutdown(follower2);\n+\n+            for (int i = 0; i < 10; i++) {\n+                zk.create(\"/foo\" + i, null, ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);\n+            }\n+\n+            qu.shutdown(follower1);\n+\n+            for (int i = 0; i < 10; i++) {\n+                zk.create(\"/bar\" + i, null, ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);\n+            }\n+\n+            qu.restart(follower1);\n+        }\n+\n+        try (ZooKeeper zk = ClientBase.createZKClient(qu.getConnectionStringForServer(follower1))) {\n+            for (int i = 0; i < 10; i++) {\n+                String path = \"/foo\" + i;\n+                assertNotNull(zk.exists(path, false), path + \" not found\");\n+            }\n+\n+            for (int i = 0; i < 10; i++) {\n\nReview Comment:\n   ZOOKEEPER-4925 ?\n\n\n\n", "created": "2025-06-03T04:33:27.889+0000", "updated": "2025-06-03T04:33:27.889+0000", "started": "2025-06-03T04:33:27.888+0000", "timeSpent": "10m", "timeSpentSeconds": 600, "id": "971588", "issueId": "13616749"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13616749/worklog/971589", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "comment": "kezhuw commented on PR #2254:\nURL: https://github.com/apache/zookeeper/pull/2254#issuecomment-2933376784\n\n   Hi @li4wang, thank for for reviewing this! I have pushed a new commit. Please take another to look and let me know whether it solves your concerns.\n\n\n", "created": "2025-06-03T04:35:25.222+0000", "updated": "2025-06-03T04:35:25.222+0000", "started": "2025-06-03T04:35:25.222+0000", "timeSpent": "10m", "timeSpentSeconds": 600, "id": "971589", "issueId": "13616749"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13616749/worklog/971713", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "comment": "li4wang commented on code in PR #2254:\nURL: https://github.com/apache/zookeeper/pull/2254#discussion_r2125310908\n\n\n##########\nzookeeper-server/src/test/java/org/apache/zookeeper/server/quorum/QuorumSyncTest.java:\n##########\n@@ -0,0 +1,100 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.zookeeper.server.quorum;\n+\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+import java.util.Comparator;\n+import org.apache.zookeeper.CreateMode;\n+import org.apache.zookeeper.ZKTestCase;\n+import org.apache.zookeeper.ZooDefs;\n+import org.apache.zookeeper.ZooKeeper;\n+import org.apache.zookeeper.test.ClientBase;\n+import org.apache.zookeeper.test.QuorumUtil;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.Test;\n+\n+public class QuorumSyncTest extends ZKTestCase {\n+    private QuorumUtil qu;\n+\n+    @AfterEach\n+    public void tearDown() throws Exception {\n+        if (qu != null) {\n+            qu.shutdownAll();\n+        }\n+    }\n+\n+    @Test\n+    public void testStaleDiffSync() throws Exception {\n+        qu = new QuorumUtil(2);\n+        qu.startAll();\n+\n+        int[] followerIds = qu.getFollowerQuorumPeers()\n+            .stream()\n+            .sorted(Comparator.comparingLong(QuorumPeer::getMyId).reversed())\n+            .mapToInt(peer -> (int) peer.getMyId()).toArray();\n+\n+        int follower1 = followerIds[0];\n+        int follower2 = followerIds[1];\n+\n+        String leaderConnectString = qu.getConnectString(qu.getLeaderQuorumPeer());\n+        try (ZooKeeper zk = ClientBase.createZKClient(leaderConnectString)) {\n+            qu.shutdown(follower2);\n+\n+            for (int i = 0; i < 10; i++) {\n+                zk.create(\"/foo\" + i, null, ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);\n+            }\n+\n+            qu.shutdown(follower1);\n+\n+            for (int i = 0; i < 10; i++) {\n+                zk.create(\"/bar\" + i, null, ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);\n+            }\n+\n+            qu.restart(follower1);\n+        }\n+\n+        try (ZooKeeper zk = ClientBase.createZKClient(qu.getConnectionStringForServer(follower1))) {\n+            for (int i = 0; i < 10; i++) {\n+                String path = \"/foo\" + i;\n+                assertNotNull(zk.exists(path, false), path + \" not found\");\n+            }\n+\n+            for (int i = 0; i < 10; i++) {\n\nReview Comment:\n   Yes\n\n\n\n", "created": "2025-06-04T02:07:51.439+0000", "updated": "2025-06-04T02:07:51.439+0000", "started": "2025-06-04T02:07:51.439+0000", "timeSpent": "10m", "timeSpentSeconds": 600, "id": "971713", "issueId": "13616749"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13616749/worklog/971893", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "comment": "kezhuw commented on PR #2254:\nURL: https://github.com/apache/zookeeper/pull/2254#issuecomment-2942413138\n\n   @cnauroth @anmolnar @eolivelli @tisonkun Would you like to take another look ? I plan to merge this in days to not block 3.9.4.\n\n\n", "created": "2025-06-05T01:34:35.780+0000", "updated": "2025-06-05T01:34:35.780+0000", "started": "2025-06-05T01:34:35.780+0000", "timeSpent": "10m", "timeSpentSeconds": 600, "id": "971893", "issueId": "13616749"}]}, "archivedby": null, "customfield_12313920": null, "issuetype": {"self": "https://issues.apache.org/jira/rest/api/2/issuetype/1", "id": "1", "description": "A problem which impairs or prevents the functions of the product.", "iconUrl": "https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype", "name": "Bug", "subtask": false, "avatarId": 21133}, "timespent": 15000, "customfield_12314020": "{summaryBean=com.atlassian.jira.plugin.devstatus.rest.SummaryBean@768fc0[summary={pullrequest=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@2eed4e75[overall=PullRequestOverallBean{stateCount=0, state='OPEN', details=PullRequestOverallDetails{openCount=0, mergedCount=0, declinedCount=0}},byInstanceType={}], build=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@131656[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BuildOverallBean@44496ec7[failedBuildCount=0,successfulBuildCount=0,unknownBuildCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], review=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@4c225f9a[overall=com.atlassian.jira.plugin.devstatus.summary.beans.ReviewsOverallBean@4792275[stateCount=0,state=<null>,dueDate=<null>,overDue=false,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], deployment-environment=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@1c40350a[overall=com.atlassian.jira.plugin.devstatus.summary.beans.DeploymentOverallBean@13f05f13[topEnvironments=[],showProjects=false,successfulCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], repository=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@4d701c78[overall=com.atlassian.jira.plugin.devstatus.summary.beans.CommitOverallBean@57e529[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], branch=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@1da2784c[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BranchOverallBean@cbba42c[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}]},errors=[],configErrors=[]], devSummaryJson={\"cachedValue\":{\"errors\":[],\"configErrors\":[],\"summary\":{\"pullrequest\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":\"OPEN\",\"details\":{\"openCount\":0,\"mergedCount\":0,\"declinedCount\":0,\"total\":0},\"open\":true},\"byInstanceType\":{}},\"build\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"failedBuildCount\":0,\"successfulBuildCount\":0,\"unknownBuildCount\":0},\"byInstanceType\":{}},\"review\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":null,\"dueDate\":null,\"overDue\":false,\"completed\":false},\"byInstanceType\":{}},\"deployment-environment\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"topEnvironments\":[],\"showProjects\":false,\"successfulCount\":0},\"byInstanceType\":{}},\"repository\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}},\"branch\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}}}},\"isStale\":false}}", "customfield_12314141": null, "customfield_12314140": null, "project": {"self": "https://issues.apache.org/jira/rest/api/2/project/12310801", "id": "12310801", "key": "ZOOKEEPER", "name": "ZooKeeper", "projectTypeKey": "software", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/projectavatar?pid=12310801&avatarId=10011", "24x24": "https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310801&avatarId=10011", "16x16": "https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310801&avatarId=10011", "32x32": "https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310801&avatarId=10011"}, "projectCategory": {"self": "https://issues.apache.org/jira/rest/api/2/projectCategory/10484", "id": "10484", "description": "Apache ZooKeeper related", "name": "ZooKeeper"}}, "aggregatetimespent": 15000, "customfield_12312520": null, "customfield_12312521": "Wed Apr 30 04:01:19 UTC 2025", "customfield_12314422": null, "customfield_12314421": null, "customfield_12314146": null, "customfield_12314420": null, "customfield_12314145": null, "customfield_12314144": null, "customfield_12314143": null, "resolutiondate": "2025-06-10T17:41:26.000+0000", "workratio": -1, "customfield_12312923": null, "customfield_12312920": null, "customfield_12312921": null, "watches": {"self": "https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-4925/watchers", "watchCount": 2, "isWatching": false}, "created": "2025-04-30T02:21:36.000+0000", "customfield_12310192": null, "customfield_12310191": null, "customfield_12310230": null, "updated": "2025-08-29T21:29:02.000+0000", "timeoriginalestimate": null, "description": "There are two variants of {{ZooKeeperServer::processTxn}}. Those two variants diverge in behavior since ZOOKEEPER-3484. {{processTxn(Request request)}} pops outstanding change from {{outstandingChanges}} and adds txn to {{committedLog}} for follower to sync in addition to what {{processTxn(TxnHeader hdr, Record txn)}} does. The {{Learner}} uses {{processTxn(TxnHeader hdr, Record txn)}} to commit txn to memory after ZOOKEEPER-4394, which means it leaves {{committedLog}} untouched in {{SYNCHRONIZATION}} phase.\r\n\r\nIn above case, a stale follower will have hole in its {{committedLog}} after joining cluster. The stale follower will propagate the in memory hole to other stale nodes after becoming leader. This causes data loss.\r\n", "customfield_10010": null, "timetracking": {"remainingEstimate": "0h", "timeSpent": "4h 10m", "remainingEstimateSeconds": 0, "timeSpentSeconds": 15000}, "customfield_12314523": null, "customfield_12314127": null, "customfield_12314522": null, "customfield_12314126": null, "customfield_12314521": null, "customfield_12314125": null, "customfield_12314520": null, "customfield_12314124": null, "customfield_12312340": null, "attachment": [], "customfield_12314123": null, "customfield_12312341": null, "customfield_12312220": null, "customfield_12314122": null, "customfield_12314121": null, "customfield_12314120": null, "customfield_12314129": null, "customfield_12314524": null, "customfield_12314128": null, "summary": "Diff sync introduce hole in stale follower's committedLog which cause data loss in leading", "customfield_12314130": null, "customfield_12310291": null, "customfield_12310290": null, "customfield_12311024": null, "customfield_12314138": null, "customfield_12314137": null, "environment": null, "customfield_12314136": null, "customfield_12314135": null, "customfield_12311020": null, "customfield_12314134": null, "duedate": null, "customfield_12314132": null, "customfield_12314131": null, "comment": {"comments": [{"self": "https://issues.apache.org/jira/rest/api/2/issue/13616749/comment/17948346", "id": "17948346", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=kezhuw", "name": "kezhuw", "key": "kezhuw", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=kezhuw&avatarId=37929", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kezhuw&avatarId=37929", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kezhuw&avatarId=37929", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kezhuw&avatarId=37929"}, "displayName": "Kezhu Wang", "active": true, "timeZone": "Etc/GMT-8"}, "body": "Added a test case for this: https://github.com/kezhuw/zookeeper/commit/c9e00b87bd0c952d382250d7b911896f52e92407. Only 3.9.3 is affected", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=kezhuw", "name": "kezhuw", "key": "kezhuw", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=kezhuw&avatarId=37929", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kezhuw&avatarId=37929", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kezhuw&avatarId=37929", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kezhuw&avatarId=37929"}, "displayName": "Kezhu Wang", "active": true, "timeZone": "Etc/GMT-8"}, "created": "2025-04-30T03:58:31.664+0000", "updated": "2025-04-30T03:58:31.664+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13616749/comment/17948348", "id": "17948348", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=kezhuw", "name": "kezhuw", "key": "kezhuw", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=kezhuw&avatarId=37929", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kezhuw&avatarId=37929", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kezhuw&avatarId=37929", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kezhuw&avatarId=37929"}, "displayName": "Kezhu Wang", "active": true, "timeZone": "Etc/GMT-8"}, "body": "Just in case, I found this in writing test cases for ZOOKEEPER-4882.", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=kezhuw", "name": "kezhuw", "key": "kezhuw", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=kezhuw&avatarId=37929", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kezhuw&avatarId=37929", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kezhuw&avatarId=37929", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kezhuw&avatarId=37929"}, "displayName": "Kezhu Wang", "active": true, "timeZone": "Etc/GMT-8"}, "created": "2025-04-30T04:01:19.510+0000", "updated": "2025-04-30T04:01:19.510+0000"}], "maxResults": 2, "total": 2, "startAt": 0}, "customfield_12311820": "0|z1vm8w:", "customfield_12314139": null}}