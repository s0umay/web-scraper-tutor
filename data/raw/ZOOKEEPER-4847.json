{"expand": "operations,versionedRepresentations,editmeta,changelog,renderedFields", "id": "13587293", "self": "https://issues.apache.org/jira/rest/api/2/issue/13587293", "key": "ZOOKEEPER-4847", "fields": {"fixVersions": [], "resolution": null, "customfield_12312322": null, "customfield_12312323": null, "customfield_12310420": "9223372036854775807", "customfield_12312320": null, "customfield_12312321": null, "customfield_12312328": null, "customfield_12312329": null, "customfield_12312326": null, "customfield_12310300": null, "customfield_12312327": null, "customfield_12312324": null, "customfield_12312720": null, "customfield_12312325": null, "lastViewed": null, "priority": {"self": "https://issues.apache.org/jira/rest/api/2/priority/3", "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/major.svg", "name": "Major", "id": "3"}, "labels": [], "customfield_12312333": null, "customfield_12312334": null, "customfield_12313422": "false", "customfield_12310310": "0.0", "customfield_12312331": null, "customfield_12312332": null, "aggregatetimeoriginalestimate": null, "timeestimate": null, "customfield_12312330": null, "versions": [{"self": "https://issues.apache.org/jira/rest/api/2/version/12343587", "id": "12343587", "name": "3.4.14", "archived": false, "released": true, "releaseDate": "2019-04-02"}, {"self": "https://issues.apache.org/jira/rest/api/2/version/12350076", "id": "12350076", "description": "Fix release against 3.6 branch", "name": "3.6.4", "archived": false, "released": true, "releaseDate": "2022-12-22"}, {"self": "https://issues.apache.org/jira/rest/api/2/version/12353694", "id": "12353694", "description": "", "name": "3.9.2", "archived": false, "released": true, "releaseDate": "2024-03-12"}], "customfield_12311120": null, "customfield_12313826": null, "issuelinks": [], "customfield_12312339": null, "customfield_12313825": null, "assignee": null, "customfield_12312337": null, "customfield_12313823": null, "customfield_12312338": null, "customfield_12311920": null, "customfield_12313822": null, "customfield_12312335": null, "customfield_12313821": null, "customfield_12312336": null, "customfield_12313820": null, "status": {"self": "https://issues.apache.org/jira/rest/api/2/status/1", "description": "The issue is open and ready for the assignee to start work on it.", "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/open.png", "name": "Open", "id": "1", "statusCategory": {"self": "https://issues.apache.org/jira/rest/api/2/statuscategory/2", "id": 2, "key": "new", "colorName": "blue-gray", "name": "To Do"}}, "components": [], "archiveddate": null, "customfield_12312026": null, "customfield_12312023": null, "customfield_12312024": null, "aggregatetimeestimate": null, "customfield_12312022": null, "customfield_12310921": null, "customfield_12310920": "9223372036854775807", "customfield_12312823": null, "creator": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=xinchen147", "name": "xinchen147", "key": "JIRAUSER298666", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=JIRAUSER298666&avatarId=52277", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=JIRAUSER298666&avatarId=52277", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=JIRAUSER298666&avatarId=52277", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=JIRAUSER298666&avatarId=52277"}, "displayName": "Xin Chen", "active": true, "timeZone": "Asia/Shanghai"}, "subtasks": [], "reporter": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=xinchen147", "name": "xinchen147", "key": "JIRAUSER298666", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=JIRAUSER298666&avatarId=52277", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=JIRAUSER298666&avatarId=52277", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=JIRAUSER298666&avatarId=52277", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=JIRAUSER298666&avatarId=52277"}, "displayName": "Xin Chen", "active": true, "timeZone": "Asia/Shanghai"}, "aggregateprogress": {"progress": 0, "total": 0}, "customfield_12313520": null, "customfield_12310250": null, "progress": {"progress": 0, "total": 0}, "customfield_12313924": null, "votes": {"self": "https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-4847/votes", "votes": 0, "hasVoted": false}, "worklog": {"startAt": 0, "maxResults": 20, "total": 0, "worklogs": []}, "archivedby": null, "customfield_12313920": null, "issuetype": {"self": "https://issues.apache.org/jira/rest/api/2/issuetype/1", "id": "1", "description": "A problem which impairs or prevents the functions of the product.", "iconUrl": "https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype", "name": "Bug", "subtask": false, "avatarId": 21133}, "timespent": null, "customfield_12314020": "{summaryBean=com.atlassian.jira.plugin.devstatus.rest.SummaryBean@65b5364a[summary={pullrequest=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@108b3b10[overall=PullRequestOverallBean{stateCount=0, state='OPEN', details=PullRequestOverallDetails{openCount=0, mergedCount=0, declinedCount=0}},byInstanceType={}], build=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@2d842aff[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BuildOverallBean@641ed7e4[failedBuildCount=0,successfulBuildCount=0,unknownBuildCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], review=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@6b98f2c9[overall=com.atlassian.jira.plugin.devstatus.summary.beans.ReviewsOverallBean@70738857[stateCount=0,state=<null>,dueDate=<null>,overDue=false,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], deployment-environment=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@7c2c9774[overall=com.atlassian.jira.plugin.devstatus.summary.beans.DeploymentOverallBean@6e1fcee2[topEnvironments=[],showProjects=false,successfulCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], repository=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@42bd6752[overall=com.atlassian.jira.plugin.devstatus.summary.beans.CommitOverallBean@2ee06e62[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], branch=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@366fcbfd[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BranchOverallBean@26177b0c[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}]},errors=[],configErrors=[]], devSummaryJson={\"cachedValue\":{\"errors\":[],\"configErrors\":[],\"summary\":{\"pullrequest\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":\"OPEN\",\"details\":{\"openCount\":0,\"mergedCount\":0,\"declinedCount\":0,\"total\":0},\"open\":true},\"byInstanceType\":{}},\"build\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"failedBuildCount\":0,\"successfulBuildCount\":0,\"unknownBuildCount\":0},\"byInstanceType\":{}},\"review\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":null,\"dueDate\":null,\"overDue\":false,\"completed\":false},\"byInstanceType\":{}},\"deployment-environment\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"topEnvironments\":[],\"showProjects\":false,\"successfulCount\":0},\"byInstanceType\":{}},\"repository\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}},\"branch\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}}}},\"isStale\":false}}", "customfield_12314141": null, "customfield_12314140": null, "project": {"self": "https://issues.apache.org/jira/rest/api/2/project/12310801", "id": "12310801", "key": "ZOOKEEPER", "name": "ZooKeeper", "projectTypeKey": "software", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/projectavatar?pid=12310801&avatarId=10011", "24x24": "https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310801&avatarId=10011", "16x16": "https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310801&avatarId=10011", "32x32": "https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310801&avatarId=10011"}, "projectCategory": {"self": "https://issues.apache.org/jira/rest/api/2/projectCategory/10484", "id": "10484", "description": "Apache ZooKeeper related", "name": "ZooKeeper"}}, "aggregatetimespent": null, "customfield_12312520": null, "customfield_12312521": "Tue Jul 30 09:58:59 UTC 2024", "customfield_12314422": null, "customfield_12314421": null, "customfield_12314146": null, "customfield_12314420": null, "customfield_12314145": null, "customfield_12314144": null, "customfield_12314143": null, "resolutiondate": null, "workratio": -1, "customfield_12312923": null, "customfield_12312920": null, "customfield_12312921": null, "watches": {"self": "https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-4847/watchers", "watchCount": 2, "isWatching": false}, "created": "2024-07-30T08:01:38.000+0000", "customfield_12310192": null, "customfield_12310191": null, "customfield_12310230": null, "updated": "2024-07-31T03:02:13.000+0000", "timeoriginalestimate": null, "description": "{code:java}\r\n2024-07-30 16:32:48,950 [myid:1] - ERROR [main:QuorumPeer@1148] - Unable to load database on disk\r\njava.io.IOException: Found od in /cloud/data/zookeeper/data/version-2/currentEpoch\r\n        at org.apache.zookeeper.server.quorum.QuorumPeer.readLongFromFile(QuorumPeer.java:2126)\r\n        at org.apache.zookeeper.server.quorum.QuorumPeer.loadDataBase(QuorumPeer.java:1100)\r\n        at org.apache.zookeeper.server.quorum.QuorumPeer.start(QuorumPeer.java:1079)\r\n        at org.apache.zookeeper.server.quorum.QuorumPeerMain.runFromConfig(QuorumPeerMain.java:227)\r\n        at org.apache.zookeeper.server.quorum.QuorumPeerMain.initializeAndRun(QuorumPeerMain.java:136)\r\n        at org.apache.zookeeper.server.quorum.QuorumPeerMain.main(QuorumPeerMain.java:90)\r\n2024-07-30 16:32:48,953 [myid:1] - ERROR [main:QuorumPeerMain@113] - Unexpected exception, exiting abnormally\r\njava.lang.RuntimeException: Unable to run quorum server\r\n        at org.apache.zookeeper.server.quorum.QuorumPeer.loadDataBase(QuorumPeer.java:1149)\r\n        at org.apache.zookeeper.server.quorum.QuorumPeer.start(QuorumPeer.java:1079)\r\n        at org.apache.zookeeper.server.quorum.QuorumPeerMain.runFromConfig(QuorumPeerMain.java:227)\r\n        at org.apache.zookeeper.server.quorum.QuorumPeerMain.initializeAndRun(QuorumPeerMain.java:136)\r\n        at org.apache.zookeeper.server.quorum.QuorumPeerMain.main(QuorumPeerMain.java:90)\r\nCaused by: java.io.IOException: Found od in /cloud/data/zookeeper/data/version-2/currentEpoch\r\n        at org.apache.zookeeper.server.quorum.QuorumPeer.readLongFromFile(QuorumPeer.java:2126)\r\n        at org.apache.zookeeper.server.quorum.QuorumPeer.loadDataBase(QuorumPeer.java:1100)\r\n        ... 4 more\r\n2024-07-30 16:32:48,954 [myid:1] - INFO  [main:ZKAuditProvider@42] - ZooKeeper audit is disabled.\r\n2024-07-30 16:32:48,955 [myid:1] - ERROR [main:ServiceUtils@48] - Exiting JVM with code 1\r\n {code}\r\nI accidentally encountered this error and found that the current Epoch file had been written with letters. Then, the zk process detected the contents of this file during restart and threw an exception before exiting the process. However, zk was unable to recover it.", "customfield_10010": null, "timetracking": {}, "customfield_12314523": null, "customfield_12314127": null, "customfield_12314522": null, "customfield_12314126": null, "customfield_12314521": null, "customfield_12314125": null, "customfield_12314520": null, "customfield_12314124": null, "customfield_12312340": null, "attachment": [], "customfield_12314123": null, "customfield_12312341": null, "customfield_12312220": null, "customfield_12314122": null, "customfield_12314121": null, "customfield_12314120": null, "customfield_12314129": null, "customfield_12314524": null, "customfield_12314128": null, "summary": "Found od in zookeeper/data/version-2/currentEpoch", "customfield_12314130": null, "customfield_12310291": null, "customfield_12310290": null, "customfield_12311024": null, "customfield_12314138": null, "customfield_12314137": null, "environment": null, "customfield_12314136": null, "customfield_12314135": null, "customfield_12311020": null, "customfield_12314134": null, "duedate": null, "customfield_12314132": null, "customfield_12314131": null, "comment": {"comments": [{"self": "https://issues.apache.org/jira/rest/api/2/issue/13587293/comment/17869585", "id": "17869585", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=xinchen147", "name": "xinchen147", "key": "JIRAUSER298666", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=JIRAUSER298666&avatarId=52277", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=JIRAUSER298666&avatarId=52277", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=JIRAUSER298666&avatarId=52277", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=JIRAUSER298666&avatarId=52277"}, "displayName": "Xin Chen", "active": true, "timeZone": "Asia/Shanghai"}, "body": "The code written into the contents of this file is as follows:\r\n{code:java}\r\n/**\r\n * Write a long value to disk atomically. Either succeeds or an exception\r\n * is thrown.\r\n * @param name file name to write the long to\r\n * @param value the long value to write to the named file\r\n * @throws IOException if the file cannot be written atomically\r\n */\r\n// visibleForTest\r\n void writeLongToFile(String name, final long value) throws IOException {\r\n    File file = new File(logFactory.getSnapDir(), name);\r\n    new AtomicFileWritingIdiom(file, new WriterStatement() {\r\n        @Override\r\n        public void write(Writer bw) throws IOException {\r\n            bw.write(Long.toString(value));\r\n        }\r\n    });\r\n} {code}\r\nAt the moment when the file was written with letters, there may have been a node power outage, disk failure, etc., but I feel that these should not have caused the writing of long numbers to become writing letters ‘od’.  Who has experience and insights in this area, please.\r\n\r\n ", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=xinchen147", "name": "xinchen147", "key": "JIRAUSER298666", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=JIRAUSER298666&avatarId=52277", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=JIRAUSER298666&avatarId=52277", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=JIRAUSER298666&avatarId=52277", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=JIRAUSER298666&avatarId=52277"}, "displayName": "Xin Chen", "active": true, "timeZone": "Asia/Shanghai"}, "created": "2024-07-30T09:28:13.839+0000", "updated": "2024-07-30T09:28:13.839+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13587293/comment/17869601", "id": "17869601", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=xinchen147", "name": "xinchen147", "key": "JIRAUSER298666", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=JIRAUSER298666&avatarId=52277", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=JIRAUSER298666&avatarId=52277", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=JIRAUSER298666&avatarId=52277", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=JIRAUSER298666&avatarId=52277"}, "displayName": "Xin Chen", "active": true, "timeZone": "Asia/Shanghai"}, "body": "The severity of this problem lies in the fact that once the ‘currentEpoch‘ content becomes letters, if zk restarts due to other factors, it will never be able to start successfully. I have proposed a solution to avoid and fix the issue, which allows the zk process to automatically recover when restarted. This involves a file deletion operation when incorrect file content is found during the startup process. This way, when zk is pulled up again, a new valid file can be created by default.\r\n\r\n \r\n{code:java}\r\nprivate long readLongFromFile(String name) throws IOException {\r\n    File file = new File(logFactory.getSnapDir(), name);\r\n    BufferedReader br = new BufferedReader(new FileReader(file));\r\n    String line = \"\";\r\n    try {\r\n        line = br.readLine();\r\n        return Long.parseLong(line);\r\n    } catch (NumberFormatException e) {\r\n// Delete the file and print a log when deletion fails                       \r\n    if (!file.delete()) {\r\n            LOG.error(\"Unable to delete wrong file {}\", file);\r\n        }\r\n        throw new IOException(\"Found \" + line + \" in \" + file);\r\n    } finally {\r\n        br.close();\r\n    }\r\n} {code}\r\n \r\n\r\nIf the file does not exist at startup, it will be created by default, which is an existing logic：\r\n{code:java}\r\nprivate void loadDataBase() {\r\n    try {\r\n        zkDb.loadDataBase();\r\n\r\n        // load the epochs\r\n        long lastProcessedZxid = zkDb.getDataTree().lastProcessedZxid;\r\n        long epochOfZxid = ZxidUtils.getEpochFromZxid(lastProcessedZxid);\r\n        try {\r\n            currentEpoch = readLongFromFile(CURRENT_EPOCH_FILENAME);\r\n        } catch (FileNotFoundException e) {\r\n            // pick a reasonable epoch number\r\n            // this should only happen once when moving to a\r\n            // new code version\r\n            currentEpoch = epochOfZxid;\r\n            LOG.info(\r\n                \"{} not found! Creating with a reasonable default of {}. \"\r\n                    + \"This should only happen when you are upgrading your installation\",\r\n                CURRENT_EPOCH_FILENAME,\r\n                currentEpoch);\r\n            writeLongToFile(CURRENT_EPOCH_FILENAME, currentEpoch);\r\n        } {code}\r\n ", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=xinchen147", "name": "xinchen147", "key": "JIRAUSER298666", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=JIRAUSER298666&avatarId=52277", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=JIRAUSER298666&avatarId=52277", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=JIRAUSER298666&avatarId=52277", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=JIRAUSER298666&avatarId=52277"}, "displayName": "Xin Chen", "active": true, "timeZone": "Asia/Shanghai"}, "created": "2024-07-30T09:58:59.614+0000", "updated": "2024-07-30T10:01:36.355+0000"}], "maxResults": 2, "total": 2, "startAt": 0}, "customfield_12311820": "0|z1qlfk:", "customfield_12314139": null}}