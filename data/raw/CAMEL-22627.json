{"expand": "operations,versionedRepresentations,editmeta,changelog,renderedFields", "id": "13632790", "self": "https://issues.apache.org/jira/rest/api/2/issue/13632790", "key": "CAMEL-22627", "fields": {"fixVersions": [{"self": "https://issues.apache.org/jira/rest/api/2/version/12356371", "id": "12356371", "description": "Jan 2026", "name": "4.17.0", "archived": false, "released": false}], "resolution": null, "customfield_12312322": null, "customfield_12312323": null, "customfield_12310420": "9223372036854775807", "customfield_12312320": null, "customfield_12312321": null, "customfield_12312328": null, "customfield_12312329": null, "customfield_12312326": null, "customfield_12310300": null, "customfield_12312327": null, "customfield_12312324": null, "customfield_12312720": null, "customfield_12312325": null, "lastViewed": null, "priority": {"self": "https://issues.apache.org/jira/rest/api/2/priority/4", "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/minor.svg", "name": "Minor", "id": "4"}, "labels": [], "customfield_12312333": null, "customfield_12312334": null, "customfield_12313422": "false", "customfield_12310310": "1.0", "customfield_12312331": null, "customfield_12312332": null, "aggregatetimeoriginalestimate": null, "timeestimate": null, "customfield_12312330": null, "versions": [{"self": "https://issues.apache.org/jira/rest/api/2/version/12356180", "id": "12356180", "description": "Oct 2025", "name": "4.15.0", "archived": false, "released": true, "releaseDate": "2025-10-07"}], "customfield_12311120": null, "customfield_12313826": null, "issuelinks": [], "customfield_12312339": null, "customfield_12313825": null, "assignee": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=davsclaus", "name": "davsclaus", "key": "davsclaus", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=davsclaus&avatarId=15835", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=davsclaus&avatarId=15835", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=davsclaus&avatarId=15835", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=davsclaus&avatarId=15835"}, "displayName": "Claus Ibsen", "active": true, "timeZone": "Europe/Berlin"}, "customfield_12312337": null, "customfield_12313823": null, "customfield_12312338": null, "customfield_12311920": null, "customfield_12313822": null, "customfield_12312335": null, "customfield_12313821": null, "customfield_12312336": null, "customfield_12313820": null, "status": {"self": "https://issues.apache.org/jira/rest/api/2/status/1", "description": "The issue is open and ready for the assignee to start work on it.", "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/open.png", "name": "Open", "id": "1", "statusCategory": {"self": "https://issues.apache.org/jira/rest/api/2/statuscategory/2", "id": 2, "key": "new", "colorName": "blue-gray", "name": "To Do"}}, "components": [{"self": "https://issues.apache.org/jira/rest/api/2/component/12313938", "id": "12313938", "name": "camel-core"}], "customfield_12310080": null, "archiveddate": null, "customfield_12312026": null, "customfield_12312023": null, "customfield_12312024": null, "aggregatetimeestimate": null, "customfield_12312022": null, "customfield_12310921": null, "customfield_12310920": "9223372036854775807", "customfield_12312823": null, "creator": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=dvine", "name": "dvine", "key": "JIRAUSER308825", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "dvine", "active": true, "timeZone": "Etc/UTC"}, "subtasks": [], "reporter": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=dvine", "name": "dvine", "key": "JIRAUSER308825", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "dvine", "active": true, "timeZone": "Etc/UTC"}, "aggregateprogress": {"progress": 0, "total": 0}, "customfield_12313520": null, "customfield_12310250": null, "progress": {"progress": 0, "total": 0}, "customfield_12313924": null, "votes": {"self": "https://issues.apache.org/jira/rest/api/2/issue/CAMEL-22627/votes", "votes": 0, "hasVoted": false}, "worklog": {"startAt": 0, "maxResults": 20, "total": 0, "worklogs": []}, "archivedby": null, "customfield_12313920": null, "issuetype": {"self": "https://issues.apache.org/jira/rest/api/2/issuetype/1", "id": "1", "description": "A problem which impairs or prevents the functions of the product.", "iconUrl": "https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype", "name": "Bug", "subtask": false, "avatarId": 21133}, "timespent": null, "customfield_12314020": "{summaryBean=com.atlassian.jira.plugin.devstatus.rest.SummaryBean@2c7d3045[summary={pullrequest=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@209974ab[overall=PullRequestOverallBean{stateCount=0, state='OPEN', details=PullRequestOverallDetails{openCount=0, mergedCount=0, declinedCount=0}},byInstanceType={}], build=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@305e0d30[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BuildOverallBean@5b091bbc[failedBuildCount=0,successfulBuildCount=0,unknownBuildCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], review=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@37f71bf3[overall=com.atlassian.jira.plugin.devstatus.summary.beans.ReviewsOverallBean@65e73330[stateCount=0,state=<null>,dueDate=<null>,overDue=false,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], deployment-environment=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@25108531[overall=com.atlassian.jira.plugin.devstatus.summary.beans.DeploymentOverallBean@36d7bed4[topEnvironments=[],showProjects=false,successfulCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], repository=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@39f0037e[overall=com.atlassian.jira.plugin.devstatus.summary.beans.CommitOverallBean@65d2d9c3[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], branch=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@44caf145[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BranchOverallBean@4fe0d616[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}]},errors=[],configErrors=[]], devSummaryJson={\"cachedValue\":{\"errors\":[],\"configErrors\":[],\"summary\":{\"pullrequest\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":\"OPEN\",\"details\":{\"openCount\":0,\"mergedCount\":0,\"declinedCount\":0,\"total\":0},\"open\":true},\"byInstanceType\":{}},\"build\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"failedBuildCount\":0,\"successfulBuildCount\":0,\"unknownBuildCount\":0},\"byInstanceType\":{}},\"review\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":null,\"dueDate\":null,\"overDue\":false,\"completed\":false},\"byInstanceType\":{}},\"deployment-environment\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"topEnvironments\":[],\"showProjects\":false,\"successfulCount\":0},\"byInstanceType\":{}},\"repository\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}},\"branch\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}}}},\"isStale\":false}}", "customfield_12314141": null, "customfield_12314140": null, "project": {"self": "https://issues.apache.org/jira/rest/api/2/project/12311211", "id": "12311211", "key": "CAMEL", "name": "Camel", "projectTypeKey": "software", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/projectavatar?pid=12311211&avatarId=10011", "24x24": "https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311211&avatarId=10011", "16x16": "https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311211&avatarId=10011", "32x32": "https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311211&avatarId=10011"}, "projectCategory": {"self": "https://issues.apache.org/jira/rest/api/2/projectCategory/10482", "id": "10482", "description": "", "name": "Camel"}}, "customfield_12310060": {"self": "https://issues.apache.org/jira/rest/api/2/customFieldOption/10060", "value": "Unknown", "id": "10060", "disabled": false}, "aggregatetimespent": null, "customfield_12312520": null, "customfield_12312521": "Sat Nov 01 17:35:01 UTC 2025", "customfield_12314422": null, "customfield_12314421": null, "customfield_12314146": null, "customfield_12314420": null, "customfield_12314145": null, "customfield_12314144": null, "customfield_12314143": null, "resolutiondate": null, "workratio": -1, "customfield_12312923": null, "customfield_12312920": null, "customfield_12312921": null, "watches": {"self": "https://issues.apache.org/jira/rest/api/2/issue/CAMEL-22627/watchers", "watchCount": 2, "isWatching": false}, "created": "2025-10-29T15:50:10.000+0000", "updated": "2025-11-01T17:35:01.000+0000", "timeoriginalestimate": null, "description": "We have long running tasks and set a large grace period during termination to clear these. What we see is errors like:\r\n\r\norg.apache.camel.component.kamelet.KameletConsumerNotAvailableException: No consumers available on endpoint: kamelet://<removed>?<removed>\r\n\r\nThe code around this is called from a wiretap:\r\n\r\n\r\n.wireTap( kamelet://<removed>?<removed>\") like so.  If I replace it with .toD then we do not see the issue.  \r\n\r\nDuring normal operation the logs show:\r\n\r\n\r\n[d #45 - WireTap] o.a.c.i.e.AbstractCamelContext           : kamelet://<redacted> converted to endpoint: kamelet://<redacted> by component: org.apache.camel.component.kamelet.KameletComponent@320aecd3\r\n[d #45 - WireTap] o.a.c.s.s.BaseService$Holder             : Starting service: kamelet://<redacted>\r\n[d #45 - WireTap] o.a.c.s.s.BaseService$Holder             : Started service: kamelet://<redacted>\r\n[d #45 - WireTap] o.a.c.s.c.ServicePool                    : Creating service from endpoint: kamelet://<redacted>\r\n\r\nIf camel is shutting down then it forgoese any starting service calls:\r\n\r\n[d #46 - WireTap] o.a.c.i.e.AbstractCamelContext           : kamelet://<redacted> converted to endpoint: kamelet://<redacted> by component: org.apache.camel.component.kamelet.KameletComponent@3d1cb317\r\n[d #46 - WireTap] o.a.c.s.c.ServicePool                    : Creating service from endpoint: kamelet://<redacted>\r\n\r\nAnd then leads later to the KameletConsumerNotAvailableException. \r\n\r\nWhich makes sense because the code around the starting only starts if camel is started and running from what I can see. However this means we cannot gracefully complete shutdown.\r\n\r\nI entered this as a bug because it seems to be a problem with wiretap/kamelets more specifically but advice regarding a work around for this would be appreciated.  I havent managed to repeat this with non kamelets.", "customfield_10010": null, "timetracking": {}, "customfield_12314523": null, "customfield_12314127": null, "customfield_12314522": null, "customfield_12314126": null, "customfield_12314521": null, "customfield_12314125": null, "customfield_12314520": null, "customfield_12314124": null, "customfield_12312340": null, "attachment": [{"self": "https://issues.apache.org/jira/rest/api/2/attachment/13079032", "id": "13079032", "filename": "camelerror.txt", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=dvine", "name": "dvine", "key": "JIRAUSER308825", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "dvine", "active": true, "timeZone": "Etc/UTC"}, "created": "2025-10-31T12:26:34.767+0000", "size": 1107, "mimeType": "text/plain", "content": "https://issues.apache.org/jira/secure/attachment/13079032/camelerror.txt"}], "customfield_12314123": null, "customfield_12312341": null, "customfield_12312220": null, "customfield_12314122": null, "customfield_12314121": null, "customfield_12310041": null, "customfield_12314120": null, "customfield_12314129": null, "customfield_12314524": null, "customfield_12314128": null, "summary": "Camel fails graceful shutdown with wiretap/kamelet", "customfield_12314130": null, "customfield_12310291": null, "customfield_12310290": null, "customfield_12311024": null, "customfield_12314138": null, "customfield_12314137": null, "environment": null, "customfield_12314136": null, "customfield_12314135": null, "customfield_12311020": null, "customfield_12314134": null, "duedate": null, "customfield_12314132": null, "customfield_12314131": null, "comment": {"comments": [{"self": "https://issues.apache.org/jira/rest/api/2/issue/13632790/comment/18033876", "id": "18033876", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=davsclaus", "name": "davsclaus", "key": "davsclaus", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=davsclaus&avatarId=15835", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=davsclaus&avatarId=15835", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=davsclaus&avatarId=15835", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=davsclaus&avatarId=15835"}, "displayName": "Claus Ibsen", "active": true, "timeZone": "Europe/Berlin"}, "body": "put together a sample project / code that reproduces this and attach here as .zip or put somewhere on github", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=davsclaus", "name": "davsclaus", "key": "davsclaus", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=davsclaus&avatarId=15835", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=davsclaus&avatarId=15835", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=davsclaus&avatarId=15835", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=davsclaus&avatarId=15835"}, "displayName": "Claus Ibsen", "active": true, "timeZone": "Europe/Berlin"}, "created": "2025-10-29T15:59:27.503+0000", "updated": "2025-10-29T15:59:27.503+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13632790/comment/18034388", "id": "18034388", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=dvine", "name": "dvine", "key": "JIRAUSER308825", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "dvine", "active": true, "timeZone": "Etc/UTC"}, "body": "Sorry for the delay:\r\n\r\nFinally managed to make a simplified example.  The problem seems is related to kamelets (I couldnt repeat with anything else), wiretap and also toD and dynamic paths.\r\n\r\nIf you run the attached, wait for the log \"You can now init shutdown\", close then you will see 1 item in flight. After the timer expires it will you will eventually see it leaps to 4 inflight and eventually \"org.apache.camel.component.kamelet.KameletConsumerNotAvailableException: No consumers available on endpoint: kamelet://testKamelet?dummy1=<UUID>. \" \r\n\r\nIf UUID remains the same and the route has run once then it occur, hence the new UUID each time to force the error and also simulates our use case closer.\r\n\r\nYou need to extend the shutdown grace period as well, we have 15 minutes to prevent forced shut down.\r\n\r\nRoute: [^camelerror.txt]", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=dvine", "name": "dvine", "key": "JIRAUSER308825", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "dvine", "active": true, "timeZone": "Etc/UTC"}, "created": "2025-10-31T12:26:59.080+0000", "updated": "2025-10-31T12:26:59.080+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13632790/comment/18034768", "id": "18034768", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=davsclaus", "name": "davsclaus", "key": "davsclaus", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=davsclaus&avatarId=15835", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=davsclaus&avatarId=15835", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=davsclaus&avatarId=15835", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=davsclaus&avatarId=15835"}, "displayName": "Claus Ibsen", "active": true, "timeZone": "Europe/Berlin"}, "body": "Thanks for the sample. This is a bit smaller\r\n{code:java}\r\n    from(\"timer:simpleTimer?period=10000\")\r\n      .routeId(\"simple-timer-route\")\r\n      .setHeader(\"dummy\", () -> UUID.randomUUID().toString())\r\n      .process(e -> {\r\n        log.info(\"You can now init shutdown\");\r\n        for (int i = 0; i < 3; i++) {\r\n          Thread.sleep(2000);\r\n          log.info(\"Waiting\", i);\r\n        }\r\n      })\r\n      .toD(\"kamelet:log-sink\");    // DOESNT WORK\r\n {code}", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=davsclaus", "name": "davsclaus", "key": "davsclaus", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=davsclaus&avatarId=15835", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=davsclaus&avatarId=15835", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=davsclaus&avatarId=15835", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=davsclaus&avatarId=15835"}, "displayName": "Claus Ibsen", "active": true, "timeZone": "Europe/Berlin"}, "created": "2025-11-01T17:35:01.401+0000", "updated": "2025-11-01T17:35:01.401+0000"}], "maxResults": 3, "total": 3, "startAt": 0}, "customfield_12311820": "0|z1ycw0:", "customfield_12314139": null}}