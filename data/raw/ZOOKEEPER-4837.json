{"expand": "operations,versionedRepresentations,editmeta,changelog,renderedFields", "id": "13581687", "self": "https://issues.apache.org/jira/rest/api/2/issue/13581687", "key": "ZOOKEEPER-4837", "fields": {"fixVersions": [], "resolution": null, "customfield_12312322": null, "customfield_12312323": null, "customfield_12310420": "9223372036854775807", "customfield_12312320": null, "customfield_12312321": null, "customfield_12312328": null, "customfield_12312329": null, "customfield_12312326": null, "customfield_12310300": null, "customfield_12312327": null, "customfield_12312324": null, "customfield_12312720": null, "customfield_12312325": null, "lastViewed": null, "priority": {"self": "https://issues.apache.org/jira/rest/api/2/priority/2", "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/critical.svg", "name": "Critical", "id": "2"}, "labels": ["pull-request-available"], "customfield_12312333": null, "customfield_12312334": null, "customfield_12313422": "false", "customfield_12310310": "0.0", "customfield_12312331": null, "customfield_12312332": null, "aggregatetimeoriginalestimate": null, "timeestimate": 0, "customfield_12312330": null, "versions": [{"self": "https://issues.apache.org/jira/rest/api/2/version/12353694", "id": "12353694", "description": "", "name": "3.9.2", "archived": false, "released": true, "releaseDate": "2024-03-12"}], "customfield_12311120": null, "customfield_12313826": null, "issuelinks": [], "customfield_12312339": null, "customfield_12313825": null, "assignee": null, "customfield_12312337": null, "customfield_12313823": null, "customfield_12312338": null, "customfield_12311920": null, "customfield_12313822": null, "customfield_12312335": null, "customfield_12313821": null, "customfield_12312336": null, "customfield_12313820": null, "status": {"self": "https://issues.apache.org/jira/rest/api/2/status/1", "description": "The issue is open and ready for the assignee to start work on it.", "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/open.png", "name": "Open", "id": "1", "statusCategory": {"self": "https://issues.apache.org/jira/rest/api/2/statuscategory/2", "id": 2, "key": "new", "colorName": "blue-gray", "name": "To Do"}}, "components": [{"self": "https://issues.apache.org/jira/rest/api/2/component/12312379", "id": "12312379", "name": "quorum", "description": "Quorum determination for ZooKeeper"}, {"self": "https://issues.apache.org/jira/rest/api/2/component/12312382", "id": "12312382", "name": "server", "description": "General issues with the ZooKeeper server."}], "archiveddate": null, "customfield_12312026": null, "customfield_12312023": null, "customfield_12312024": null, "aggregatetimeestimate": 0, "customfield_12312022": null, "customfield_12310921": null, "customfield_12310920": "9223372036854775807", "customfield_12312823": null, "creator": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=dparikesit", "name": "dparikesit", "key": "JIRAUSER305717", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34044", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34044", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34044", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34044"}, "displayName": "Dimas Shidqi Parikesit", "active": true, "timeZone": "Asia/Bangkok"}, "subtasks": [], "reporter": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=dparikesit", "name": "dparikesit", "key": "JIRAUSER305717", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34044", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34044", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34044", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34044"}, "displayName": "Dimas Shidqi Parikesit", "active": true, "timeZone": "Asia/Bangkok"}, "aggregateprogress": {"progress": 600, "total": 600, "percent": 100}, "customfield_12313520": null, "customfield_12310250": null, "progress": {"progress": 600, "total": 600, "percent": 100}, "customfield_12313924": null, "votes": {"self": "https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-4837/votes", "votes": 0, "hasVoted": false}, "worklog": {"startAt": 0, "maxResults": 20, "total": 1, "worklogs": [{"self": "https://issues.apache.org/jira/rest/api/2/issue/13581687/worklog/922232", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "comment": "dParikesit opened a new pull request, #2172:\nURL: https://github.com/apache/zookeeper/pull/2172\n\n   …he session expiration\r\n   \r\n   The core part of this fix is\r\n   ```\r\n   // if this snapshot has a higher zxid than the checkpoint zxid, skip and continue to the previous snapshot\r\n   if (snapZxid > zxid) {\r\n       continue;\r\n   }\r\n   ```\r\n   However, the zxid must be propagated from tuncateLog(), which is why I added another loadDatabase, deserialize, and restore with zxid as its additional parameter.\n\n\n", "created": "2024-06-05T17:19:00.654+0000", "updated": "2024-06-05T17:19:00.654+0000", "started": "2024-06-05T17:19:00.654+0000", "timeSpent": "10m", "timeSpentSeconds": 600, "id": "922232", "issueId": "13581687"}]}, "archivedby": null, "customfield_12313920": null, "issuetype": {"self": "https://issues.apache.org/jira/rest/api/2/issuetype/1", "id": "1", "description": "A problem which impairs or prevents the functions of the product.", "iconUrl": "https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype", "name": "Bug", "subtask": false, "avatarId": 21133}, "timespent": 600, "customfield_12314020": "{summaryBean=com.atlassian.jira.plugin.devstatus.rest.SummaryBean@5a014b27[summary={pullrequest=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@5314b4f6[overall=PullRequestOverallBean{stateCount=0, state='OPEN', details=PullRequestOverallDetails{openCount=0, mergedCount=0, declinedCount=0}},byInstanceType={}], build=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@1932e29d[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BuildOverallBean@6ff74649[failedBuildCount=0,successfulBuildCount=0,unknownBuildCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], review=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@5348ecdb[overall=com.atlassian.jira.plugin.devstatus.summary.beans.ReviewsOverallBean@4c6a7b7c[stateCount=0,state=<null>,dueDate=<null>,overDue=false,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], deployment-environment=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@42425e66[overall=com.atlassian.jira.plugin.devstatus.summary.beans.DeploymentOverallBean@17d29d69[topEnvironments=[],showProjects=false,successfulCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], repository=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@368857c[overall=com.atlassian.jira.plugin.devstatus.summary.beans.CommitOverallBean@1cc6bff6[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], branch=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@4c277366[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BranchOverallBean@4f9d865e[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}]},errors=[],configErrors=[]], devSummaryJson={\"cachedValue\":{\"errors\":[],\"configErrors\":[],\"summary\":{\"pullrequest\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":\"OPEN\",\"details\":{\"openCount\":0,\"mergedCount\":0,\"declinedCount\":0,\"total\":0},\"open\":true},\"byInstanceType\":{}},\"build\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"failedBuildCount\":0,\"successfulBuildCount\":0,\"unknownBuildCount\":0},\"byInstanceType\":{}},\"review\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":null,\"dueDate\":null,\"overDue\":false,\"completed\":false},\"byInstanceType\":{}},\"deployment-environment\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"topEnvironments\":[],\"showProjects\":false,\"successfulCount\":0},\"byInstanceType\":{}},\"repository\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}},\"branch\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}}}},\"isStale\":false}}", "customfield_12314141": null, "customfield_12314140": null, "project": {"self": "https://issues.apache.org/jira/rest/api/2/project/12310801", "id": "12310801", "key": "ZOOKEEPER", "name": "ZooKeeper", "projectTypeKey": "software", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/projectavatar?pid=12310801&avatarId=10011", "24x24": "https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310801&avatarId=10011", "16x16": "https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310801&avatarId=10011", "32x32": "https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310801&avatarId=10011"}, "projectCategory": {"self": "https://issues.apache.org/jira/rest/api/2/projectCategory/10484", "id": "10484", "description": "Apache ZooKeeper related", "name": "ZooKeeper"}}, "aggregatetimespent": 600, "customfield_12312520": null, "customfield_12312521": "Tue Aug 26 08:15:17 UTC 2025", "customfield_12314422": null, "customfield_12314421": null, "customfield_12314146": null, "customfield_12314420": null, "customfield_12314145": null, "customfield_12314144": null, "customfield_12314143": null, "resolutiondate": null, "workratio": -1, "customfield_12312923": null, "customfield_12312920": null, "customfield_12312921": null, "watches": {"self": "https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-4837/watchers", "watchCount": 4, "isWatching": false}, "created": "2024-06-05T16:45:32.000+0000", "customfield_12310192": null, "customfield_12310191": null, "customfield_12310230": null, "updated": "2025-08-26T08:15:17.000+0000", "timeoriginalestimate": null, "description": "In our testing cluster with the latest ZooKeeper version (66202cb), we observed that sometimes an ephemeral node never gets deleted if there is a network issue during the PROPOSAL request, even after the session expires. This bug is essentially related to ZOOKEEPER-2355, but the issue was not entirely fixed in the previous patch. We also tested on some related open PRs (e.g., [https://github.com/apache/zookeeper/pull/2152] and [https://github.com/apache/zookeeper/pull/1925] ), and confirmed the issue exists after the proposed fix.\r\n\r\n \r\n\r\nSteps to reproduce this bug:\r\n # Start a cluster with 3 servers, follower A, leader B, follower C\r\n # Open a zk client in server A\r\n # Create an ephemeral node in the client\r\n # Inject network issue in all server that causes SocketTimeoutException during readPacket if the packet is a PROPOSAL\r\n # Close the client\r\n # Wait until the cluster is stable (the leader will change between B and C several times)\r\n # Remove the network issue from all server\r\n # Check every server for ephemeral node existence. The ephemeral node will exist in server A. However, server B and C will not have the ephemeral node anymore.\r\n\r\n \r\n\r\nEssentially the bug is caused by loadDatabase loading a snapshot with a higher Zxid than the truncated log, causing fastForwardFromEdits to fail when trying to replay the transactions. For example, if one of the follower has a lastProcessedZxid of 0x200000001 and last snapshot snapshot.200000001, and the leader sends a TRUNC with a zxid of 100000002, truncateLog will truncate the follower's log to 100000002. However, loadDatabase will load snapshot.200000001. So when fastForwardFromEdits happens, it will set the data tree to 200000001 instead of 100000002.\r\n\r\n \r\n\r\nWe also attached a test case to reproduce this issue. Note that this test case is still pretty flaky at this moment.\r\n\r\n \r\n\r\nWe proposed to fix this case by loading the database from the last snapshot that happens before the last truncated-log entry during truncateLog. See our PR attached. Of course, this may not be the ideal solution and we welcome suggestions. Some other potential solutions include: \r\n\r\n(1) Disable fastForwardDatabase in shutdown\r\n\r\n(2) Run setLastProcessedZxid at the end of Learner's syncWithLeader function if the packet is Leader.DIFF \r\n\r\n \r\n\r\nYour insights are very much appreciated. We will continue following up this issue until it is resolved.", "customfield_10010": null, "timetracking": {"remainingEstimate": "0h", "timeSpent": "10m", "remainingEstimateSeconds": 0, "timeSpentSeconds": 600}, "customfield_12314523": null, "customfield_12314127": null, "customfield_12314522": null, "customfield_12314126": null, "customfield_12314521": null, "customfield_12314125": null, "customfield_12314520": null, "customfield_12314124": null, "customfield_12312340": null, "attachment": [], "customfield_12314123": null, "customfield_12312341": null, "customfield_12312220": null, "customfield_12314122": null, "customfield_12314121": null, "customfield_12314120": null, "customfield_12314129": null, "customfield_12314524": null, "customfield_12314128": null, "summary": "Network issue causes ephemeral node unremoved after the session expiration", "customfield_12314130": null, "customfield_12310291": null, "customfield_12310290": null, "customfield_12311024": null, "customfield_12314138": null, "customfield_12314137": null, "environment": null, "customfield_12314136": null, "customfield_12314135": null, "customfield_12311020": null, "customfield_12314134": null, "duedate": null, "customfield_12314132": null, "customfield_12314131": null, "comment": {"comments": [{"self": "https://issues.apache.org/jira/rest/api/2/issue/13581687/comment/17854495", "id": "17854495", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=chlou", "name": "chlou", "key": "chlou", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34050", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34050", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34050", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34050"}, "displayName": "Chang Lou", "active": true, "timeZone": "Etc/UTC"}, "body": "I can confirm that the failure is also reproducible on a different cluster. Hello [~lvfangmin]  and [~andor] , you were both incredibly helpful a few years ago when we reported a different bug (ZOOKEEPER-3531). If you have the time, could you please take a look at this issue as well? Thank you!\r\n \r\nI have also included [~jonmv]  for his insights, given his involvement in a related bug case ([#1925|https://github.com/apache/zookeeper/pull/1925]).", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=chlou", "name": "chlou", "key": "chlou", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34050", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34050", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34050", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34050"}, "displayName": "Chang Lou", "active": true, "timeZone": "Etc/UTC"}, "created": "2024-06-12T17:18:50.519+0000", "updated": "2024-06-12T17:18:50.519+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13581687/comment/18016228", "id": "18016228", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=Changrui+Lin", "name": "Changrui Lin", "key": "changrui lin", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34058", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34058", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34058", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34058"}, "displayName": "Lin Changrui", "active": true, "timeZone": "Asia/Shanghai"}, "body": "If the root cause is as reported, is that mean the sequence of all TRUNC is incorrect? Data of each servers after TRUNC are always inconsistent, such as some transcations of session expired truncated but still visible.\r\nWe have reproduced a issue like this in our cluster. The affected(network issus) follower has log 'Digests are not matching' after trunc. After a while, we reboot all server at same time. The affected server become leader after election, I guess because it has the highest zxid. We can see some ephemeral nodes which has been deleted some time before on the leader, and they are invisible on followers.\r\n\r\nI can't upload attachment, part of log is like this.\r\n{code:java}\r\nWARN (CommitProcessor:5,98) RateLogger,87 - Message:Digests are not matching. Value is Zxid. Value:51539607553\r\nDEBUG (CommitProcessor:5,98) DataTree,1809 - Digest in log: 364897877017, actual tree: 352915824196\r\nDEBUG (nioEventLoopGroup-4-3,59) NettyServerCnxnFactory$CnxnChannelHandler,318 - Received ReadEvent.ENABLE\r\nERROR (CommitProcessor:5,98) DataTree,1811 - First digest mismatch on txn: 360288272277504000,0,51539607553,1744568253693,-10\r\n, 9000\r\n, expected digest is 2,364897877017\r\n, actual digest is 352915824196,{code}", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=Changrui+Lin", "name": "Changrui Lin", "key": "changrui lin", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34058", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34058", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34058", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34058"}, "displayName": "Lin Changrui", "active": true, "timeZone": "Asia/Shanghai"}, "created": "2025-08-26T08:15:17.059+0000", "updated": "2025-08-26T08:15:17.059+0000"}], "maxResults": 2, "total": 2, "startAt": 0}, "customfield_12311820": "0|z1pmvk:", "customfield_12314139": null}}