{"expand": "operations,versionedRepresentations,editmeta,changelog,renderedFields", "id": "13591355", "self": "https://issues.apache.org/jira/rest/api/2/issue/13591355", "key": "ZOOKEEPER-4858", "fields": {"fixVersions": [{"self": "https://issues.apache.org/jira/rest/api/2/version/12353481", "id": "12353481", "name": "3.10.0", "archived": false, "released": false}, {"self": "https://issues.apache.org/jira/rest/api/2/version/12355230", "id": "12355230", "description": "", "name": "3.9.4", "archived": false, "released": true, "releaseDate": "2025-08-29"}], "resolution": {"self": "https://issues.apache.org/jira/rest/api/2/resolution/1", "id": "1", "description": "A fix for this issue is checked into the tree and tested.", "name": "Fixed"}, "customfield_12312322": null, "customfield_12312323": null, "customfield_12310420": "9223372036854775807", "customfield_12312320": null, "customfield_12312321": null, "customfield_12312328": null, "customfield_12312329": null, "customfield_12312326": null, "customfield_12310300": null, "customfield_12312327": null, "customfield_12312324": null, "customfield_12312720": null, "customfield_12312325": null, "lastViewed": null, "priority": {"self": "https://issues.apache.org/jira/rest/api/2/priority/3", "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/major.svg", "name": "Major", "id": "3"}, "labels": ["pull-request-available"], "customfield_12312333": null, "customfield_12312334": null, "customfield_12313422": "false", "customfield_12310310": "0.0", "customfield_12312331": null, "customfield_12312332": null, "aggregatetimeoriginalestimate": null, "timeestimate": 0, "customfield_12312330": null, "versions": [{"self": "https://issues.apache.org/jira/rest/api/2/version/12351304", "id": "12351304", "name": "3.9.0", "archived": false, "released": true, "releaseDate": "2023-08-03"}, {"self": "https://issues.apache.org/jira/rest/api/2/version/12353480", "id": "12353480", "name": "3.9.1", "archived": false, "released": true, "releaseDate": "2023-10-09"}, {"self": "https://issues.apache.org/jira/rest/api/2/version/12353694", "id": "12353694", "description": "", "name": "3.9.2", "archived": false, "released": true, "releaseDate": "2024-03-12"}, {"self": "https://issues.apache.org/jira/rest/api/2/version/12354432", "id": "12354432", "description": "", "name": "3.9.3", "archived": false, "released": true, "releaseDate": "2024-10-24"}], "customfield_12311120": null, "customfield_12313826": null, "issuelinks": [], "customfield_12312339": null, "customfield_12313825": null, "assignee": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=li4wang", "name": "li4wang", "key": "JIRAUSER299380", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Li Wang", "active": true, "timeZone": "America/Los_Angeles"}, "customfield_12312337": null, "customfield_12313823": null, "customfield_12312338": null, "customfield_12311920": null, "customfield_12313822": null, "customfield_12312335": null, "customfield_12313821": null, "customfield_12312336": null, "customfield_12313820": null, "status": {"self": "https://issues.apache.org/jira/rest/api/2/status/6", "description": "The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.", "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/closed.png", "name": "Closed", "id": "6", "statusCategory": {"self": "https://issues.apache.org/jira/rest/api/2/statuscategory/3", "id": 3, "key": "done", "colorName": "green", "name": "Done"}}, "components": [{"self": "https://issues.apache.org/jira/rest/api/2/component/12312382", "id": "12312382", "name": "server", "description": "General issues with the ZooKeeper server."}], "archiveddate": null, "customfield_12312026": null, "customfield_12312023": null, "customfield_12312024": null, "aggregatetimeestimate": 0, "customfield_12312022": null, "customfield_12310921": null, "customfield_12310920": "9223372036854775807", "customfield_12312823": null, "creator": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=li4wang", "name": "li4wang", "key": "JIRAUSER299380", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Li Wang", "active": true, "timeZone": "America/Los_Angeles"}, "subtasks": [], "reporter": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=li4wang", "name": "li4wang", "key": "JIRAUSER299380", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Li Wang", "active": true, "timeZone": "America/Los_Angeles"}, "aggregateprogress": {"progress": 11400, "total": 11400, "percent": 100}, "customfield_12313520": null, "customfield_12310250": null, "progress": {"progress": 11400, "total": 11400, "percent": 100}, "customfield_12313924": null, "votes": {"self": "https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-4858/votes", "votes": 0, "hasVoted": false}, "worklog": {"startAt": 0, "maxResults": 20, "total": 19, "worklogs": [{"self": "https://issues.apache.org/jira/rest/api/2/issue/13591355/worklog/933683", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "comment": "li4wang opened a new pull request, #2185:\nURL: https://github.com/apache/zookeeper/pull/2185\n\n   Author: Li Wang <liwang@apple.com>\n\n\n", "created": "2024-09-07T02:14:29.188+0000", "updated": "2024-09-07T02:14:29.188+0000", "started": "2024-09-07T02:14:29.187+0000", "timeSpent": "10m", "timeSpentSeconds": 600, "id": "933683", "issueId": "13591355"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13591355/worklog/934378", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "comment": "li4wang commented on PR #2185:\nURL: https://github.com/apache/zookeeper/pull/2185#issuecomment-2345059508\n\n   @eolivelli can I get a review for this? Thanks\n\n\n", "created": "2024-09-12T01:11:06.572+0000", "updated": "2024-09-12T01:11:06.572+0000", "started": "2024-09-12T01:11:06.572+0000", "timeSpent": "10m", "timeSpentSeconds": 600, "id": "934378", "issueId": "13591355"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13591355/worklog/938286", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "comment": "li4wang commented on PR #2185:\nURL: https://github.com/apache/zookeeper/pull/2185#issuecomment-2415607518\n\n   Thanks for reviewing it, @anmolnar.\r\n   \r\n   Yes, we would still want exclusive locking between snapshot and restore to make sure data tree is not replaced by restoring  operation while snapshotting is in progress.\r\n   \r\n   \n\n\n", "created": "2024-10-16T02:40:27.510+0000", "updated": "2024-10-16T02:40:27.510+0000", "started": "2024-10-16T02:40:27.509+0000", "timeSpent": "10m", "timeSpentSeconds": 600, "id": "938286", "issueId": "13591355"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13591355/worklog/938287", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "comment": "li4wang commented on PR #2185:\nURL: https://github.com/apache/zookeeper/pull/2185#issuecomment-2415612268\n\n   added a specific lock just for snapshot and restore operations. @anmolnar would you mind taking a look at it. Thanks.\n\n\n", "created": "2024-10-16T02:45:55.850+0000", "updated": "2024-10-16T02:45:55.850+0000", "started": "2024-10-16T02:45:55.849+0000", "timeSpent": "10m", "timeSpentSeconds": 600, "id": "938287", "issueId": "13591355"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13591355/worklog/939266", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "comment": "li4wang commented on PR #2185:\nURL: https://github.com/apache/zookeeper/pull/2185#issuecomment-2427279513\n\n   @anmolnar I've addressed your comment. Can you take a quick look at it? Thanks.\n\n\n", "created": "2024-10-21T17:08:41.382+0000", "updated": "2024-10-21T17:08:41.382+0000", "started": "2024-10-21T17:08:41.382+0000", "timeSpent": "10m", "timeSpentSeconds": 600, "id": "939266", "issueId": "13591355"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13591355/worklog/947403", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "comment": "anmolnar commented on PR #2185:\nURL: https://github.com/apache/zookeeper/pull/2185#issuecomment-2529146395\n\n   Are you sure that we don't need to synchronize between snapshotting and `sync()`?\n\n\n", "created": "2024-12-09T19:13:52.035+0000", "updated": "2024-12-09T19:13:52.035+0000", "started": "2024-12-09T19:13:52.034+0000", "timeSpent": "10m", "timeSpentSeconds": 600, "id": "947403", "issueId": "13591355"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13591355/worklog/947404", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "comment": "anmolnar commented on code in PR #2185:\nURL: https://github.com/apache/zookeeper/pull/2185#discussion_r1876538751\n\n\n##########\nzookeeper-server/src/main/java/org/apache/zookeeper/server/ZooKeeperServer.java:\n##########\n@@ -618,9 +622,10 @@ public synchronized long restoreFromSnapshot(final InputStream inputStream) thro\n         restoreLatch = new CountDownLatch(1);\n \n         try {\n-            // set to the new zkDatabase\n-            setZKDatabase(newZKDatabase);\n-\n+            synchronized (snapshotAndRestoreLock) {\n+                // set to the new zkDatabase\n+                setZKDatabase(newZKDatabase);\n+            }\n\nReview Comment:\n   I think you better extend the scope of sync block to `createSessionTracker()` call.\n\n\n\n", "created": "2024-12-09T19:14:44.600+0000", "updated": "2024-12-09T19:14:44.600+0000", "started": "2024-12-09T19:14:44.599+0000", "timeSpent": "10m", "timeSpentSeconds": 600, "id": "947404", "issueId": "13591355"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13591355/worklog/947405", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "comment": "anmolnar commented on PR #2185:\nURL: https://github.com/apache/zookeeper/pull/2185#issuecomment-2529152144\n\n   @kezhuw Thoughts?\n\n\n", "created": "2024-12-09T19:16:01.833+0000", "updated": "2024-12-09T19:16:01.833+0000", "started": "2024-12-09T19:16:01.833+0000", "timeSpent": "10m", "timeSpentSeconds": 600, "id": "947405", "issueId": "13591355"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13591355/worklog/947408", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "comment": "li4wang commented on code in PR #2185:\nURL: https://github.com/apache/zookeeper/pull/2185#discussion_r1876700215\n\n\n##########\nzookeeper-server/src/main/java/org/apache/zookeeper/server/ZooKeeperServer.java:\n##########\n@@ -618,9 +622,10 @@ public synchronized long restoreFromSnapshot(final InputStream inputStream) thro\n         restoreLatch = new CountDownLatch(1);\n \n         try {\n-            // set to the new zkDatabase\n-            setZKDatabase(newZKDatabase);\n-\n+            synchronized (snapshotAndRestoreLock) {\n+                // set to the new zkDatabase\n+                setZKDatabase(newZKDatabase);\n+            }\n\nReview Comment:\n   ```\r\n       protected void createSessionTracker() {\r\n           sessionTracker = new SessionTrackerImpl(this, zkDb.getSessionWithTimeOuts(), tickTime, createSessionTrackerServerId, getZooKeeperServerListener());\r\n       }\r\n   ```\r\n   \r\n   ```\r\n    public File takeSnapshot(boolean syncSnap, boolean isSevere) throws IOException {\r\n           try {\r\n               synchronized (snapshotAndRestoreLock) {\r\n                   snapFile = txnLogFactory.save(zkDb.getDataTree(), zkDb.getSessionWithTimeOuts(), syncSnap);\r\n               }\r\n           } catch (IOException e) {\r\n   ```\r\n   \r\n   ```\r\n     public ConcurrentHashMap<Long, Integer> getSessionWithTimeOuts() {\r\n           return sessionsWithTimeouts;\r\n       }\r\n   ```\r\n   \r\n   \r\n   `takeSapshot()` and `createSessionTracker() ` of `resore()` just read data from the sessionsWithTimeouts ConcurrentHashMap, any reason the sync block need to include it?\r\n   \n\n\n\n", "created": "2024-12-09T20:16:47.326+0000", "updated": "2024-12-09T20:16:47.326+0000", "started": "2024-12-09T20:16:47.326+0000", "timeSpent": "10m", "timeSpentSeconds": 600, "id": "947408", "issueId": "13591355"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13591355/worklog/947409", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "comment": "li4wang commented on code in PR #2185:\nURL: https://github.com/apache/zookeeper/pull/2185#discussion_r1876700215\n\n\n##########\nzookeeper-server/src/main/java/org/apache/zookeeper/server/ZooKeeperServer.java:\n##########\n@@ -618,9 +622,10 @@ public synchronized long restoreFromSnapshot(final InputStream inputStream) thro\n         restoreLatch = new CountDownLatch(1);\n \n         try {\n-            // set to the new zkDatabase\n-            setZKDatabase(newZKDatabase);\n-\n+            synchronized (snapshotAndRestoreLock) {\n+                // set to the new zkDatabase\n+                setZKDatabase(newZKDatabase);\n+            }\n\nReview Comment:\n   ```\r\n       protected void createSessionTracker() {\r\n           sessionTracker = new SessionTrackerImpl(this, zkDb.getSessionWithTimeOuts(), tickTime, createSessionTrackerServerId, getZooKeeperServerListener());\r\n       }\r\n   ```\r\n   \r\n   ```\r\n    public File takeSnapshot(boolean syncSnap, boolean isSevere) throws IOException {\r\n           try {\r\n               synchronized (snapshotAndRestoreLock) {\r\n                   snapFile = txnLogFactory.save(zkDb.getDataTree(), zkDb.getSessionWithTimeOuts(), syncSnap);\r\n               }\r\n           } catch (IOException e) {\r\n   ```\r\n   \r\n   ```\r\n     public ConcurrentHashMap<Long, Integer> getSessionWithTimeOuts() {\r\n           return sessionsWithTimeouts;\r\n       }\r\n   ```\r\n   \r\n   \r\n   `takeSapshot()` and `createSessionTracker() ` of `resore()` both read data from the sessionsWithTimeouts ConcurrentHashMap, any reason the sync block need to include it?\r\n   \n\n\n\n", "created": "2024-12-09T20:17:25.769+0000", "updated": "2024-12-09T20:17:25.769+0000", "started": "2024-12-09T20:17:25.768+0000", "timeSpent": "10m", "timeSpentSeconds": 600, "id": "947409", "issueId": "13591355"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13591355/worklog/947411", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "comment": "li4wang commented on code in PR #2185:\nURL: https://github.com/apache/zookeeper/pull/2185#discussion_r1876700215\n\n\n##########\nzookeeper-server/src/main/java/org/apache/zookeeper/server/ZooKeeperServer.java:\n##########\n@@ -618,9 +622,10 @@ public synchronized long restoreFromSnapshot(final InputStream inputStream) thro\n         restoreLatch = new CountDownLatch(1);\n \n         try {\n-            // set to the new zkDatabase\n-            setZKDatabase(newZKDatabase);\n-\n+            synchronized (snapshotAndRestoreLock) {\n+                // set to the new zkDatabase\n+                setZKDatabase(newZKDatabase);\n+            }\n\nReview Comment:\n   ```\r\n       protected void createSessionTracker() {\r\n           sessionTracker = new SessionTrackerImpl(this, zkDb.getSessionWithTimeOuts(), tickTime, createSessionTrackerServerId, getZooKeeperServerListener());\r\n       }\r\n   ```\r\n   \r\n   ```\r\n    public File takeSnapshot(boolean syncSnap, boolean isSevere) throws IOException {\r\n           try {\r\n               synchronized (snapshotAndRestoreLock) {\r\n                   snapFile = txnLogFactory.save(zkDb.getDataTree(), zkDb.getSessionWithTimeOuts(), syncSnap);\r\n               }\r\n           } catch (IOException e) {\r\n   ```\r\n   \r\n   ```\r\n     public ConcurrentHashMap<Long, Integer> getSessionWithTimeOuts() {\r\n           return sessionsWithTimeouts;\r\n       }\r\n   ```\r\n   \r\n   `takeSapshot()` and `createSessionTracker() ` of `resore()` both read data from the sessionsWithTimeouts ConcurrentHashMap, any reason the sync block need to include it? \r\n   \r\n   `createSessionTracker() ` is a post process after swapping the ZkDatabase object of a ZookeeperServer instance. `sessionsWithTimeouts` is part of `ZkDatabase` object and read/write sync is already covered by the sync block.\r\n   \n\n\n\n", "created": "2024-12-09T20:26:23.289+0000", "updated": "2024-12-09T20:26:23.289+0000", "started": "2024-12-09T20:26:23.289+0000", "timeSpent": "10m", "timeSpentSeconds": 600, "id": "947411", "issueId": "13591355"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13591355/worklog/947412", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "comment": "anmolnar commented on code in PR #2185:\nURL: https://github.com/apache/zookeeper/pull/2185#discussion_r1876716261\n\n\n##########\nzookeeper-server/src/main/java/org/apache/zookeeper/server/ZooKeeperServer.java:\n##########\n@@ -618,9 +622,10 @@ public synchronized long restoreFromSnapshot(final InputStream inputStream) thro\n         restoreLatch = new CountDownLatch(1);\n \n         try {\n-            // set to the new zkDatabase\n-            setZKDatabase(newZKDatabase);\n-\n+            synchronized (snapshotAndRestoreLock) {\n+                // set to the new zkDatabase\n+                setZKDatabase(newZKDatabase);\n+            }\n\nReview Comment:\n   To be on the safe side. `Learner` calls it within a sync block: https://github.com/apache/zookeeper/blob/master/zookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/Learner.java#L610\n\n\n\n", "created": "2024-12-09T20:31:56.282+0000", "updated": "2024-12-09T20:31:56.282+0000", "started": "2024-12-09T20:31:56.282+0000", "timeSpent": "10m", "timeSpentSeconds": 600, "id": "947412", "issueId": "13591355"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13591355/worklog/947868", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "comment": "anmolnar commented on PR #2185:\nURL: https://github.com/apache/zookeeper/pull/2185#issuecomment-2537053559\n\n   > We ran into perf issue when had sync on the ZookeeperServer object. Whenever snapshot was taken, the sync operations were queued up in the outstanding request queue and the sync() operation latency was largely increased. (edited) \r\n   > There was no synchronize between snapshotting and sync() before.\r\n   > The intention of adding the synchronized was to takeSnapshot() and restore() was to sync between the two operations. I didnâ€™t realize the sync() call also requires ZookeeperServer object lock.\r\n   \r\n   When has synchronized been added to take/restore snapshot?\r\n   Are you saying that `sync()` was already synchronized which should prevent multiple sync's running at the same time, but accidentally you introduced snapshotting into this lock?\n\n\n", "created": "2024-12-11T20:24:52.126+0000", "updated": "2024-12-11T20:24:52.126+0000", "started": "2024-12-11T20:24:52.126+0000", "timeSpent": "10m", "timeSpentSeconds": 600, "id": "947868", "issueId": "13591355"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13591355/worklog/948091", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "comment": "li4wang commented on PR #2185:\nURL: https://github.com/apache/zookeeper/pull/2185#issuecomment-2539818003\n\n   > When has synchronized been added to take/restore snapshot?\r\n   synchronized on the ZookeeperServer object  was added when we introduced remote backup and restore feature, specifically https://github.com/apache/zookeeper/pull/1943\r\n   \n\n\n", "created": "2024-12-12T19:14:31.430+0000", "updated": "2024-12-12T19:14:31.430+0000", "started": "2024-12-12T19:14:31.429+0000", "timeSpent": "10m", "timeSpentSeconds": 600, "id": "948091", "issueId": "13591355"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13591355/worklog/949198", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "comment": "anmolnar commented on PR #2185:\nURL: https://github.com/apache/zookeeper/pull/2185#issuecomment-2555077971\n\n   > LGTM\r\n   > \r\n   > > it causes lock contention on the ZookeeperServer object with the sync operation.\r\n   > \r\n   > Does anyone have any cue about why `sync` get `synchronized` ? I saw that `sync` is called only in one thread and `pendingSyncs` is concurrent safe.\r\n   \r\n   I have no idea either. I think we could remove synchronize from `sync()` too. Or remove it only from `sync()`.\n\n\n", "created": "2024-12-19T16:54:14.691+0000", "updated": "2024-12-19T16:54:14.691+0000", "started": "2024-12-19T16:54:14.690+0000", "timeSpent": "10m", "timeSpentSeconds": 600, "id": "949198", "issueId": "13591355"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13591355/worklog/949199", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "comment": "anmolnar commented on PR #2185:\nURL: https://github.com/apache/zookeeper/pull/2185#issuecomment-2555094540\n\n   [ZOOKEEPER-136](https://issues.apache.org/jira/browse/ZOOKEEPER-136) added synchronized to sync()\n\n\n", "created": "2024-12-19T16:57:17.834+0000", "updated": "2024-12-19T16:57:17.834+0000", "started": "2024-12-19T16:57:17.834+0000", "timeSpent": "10m", "timeSpentSeconds": 600, "id": "949199", "issueId": "13591355"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13591355/worklog/949499", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "comment": "li4wang commented on PR #2185:\nURL: https://github.com/apache/zookeeper/pull/2185#issuecomment-2557852989\n\n   Thanks @anmolnar and @kezhuw \r\n   \r\n   > > I saw that sync is called only in one thread and pendingSyncs is concurrent safe.\r\n   > I think we could remove synchronize from sync() too. Or remove it only from sync().\r\n   \r\n   `sync()` is synchronized on the `ZookeeperServer` object, which is accessed by multiple-threads.  Through inheritance and composition, the sync() operation is currently synchronized with following API calls. \r\n   \r\n   ```\r\n   ZookeeperServer.enqueueRequest(), \r\n   ZookeeperServer.submitRequestNow()\r\n   ZookeeperServer.startup()\r\n   ZookeeperServer.shutdown()\r\n   Learner.syncWithLeader()\r\n   ```\r\n   \r\n   `sync()` is used for strong consistency of not getting stale data in the read after write scenario. Not sure if it's safe to remove `synchronization` from it.\r\n   \n\n\n", "created": "2024-12-20T22:50:48.194+0000", "updated": "2024-12-20T22:50:48.194+0000", "started": "2024-12-20T22:50:48.194+0000", "timeSpent": "10m", "timeSpentSeconds": 600, "id": "949499", "issueId": "13591355"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13591355/worklog/949500", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "comment": "li4wang commented on PR #2185:\nURL: https://github.com/apache/zookeeper/pull/2185#issuecomment-2557855341\n\n   @anmolnar @kezhuw The PR is good for merge now, right?\n\n\n", "created": "2024-12-20T22:54:13.804+0000", "updated": "2024-12-20T22:54:13.804+0000", "started": "2024-12-20T22:54:13.804+0000", "timeSpent": "10m", "timeSpentSeconds": 600, "id": "949500", "issueId": "13591355"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13591355/worklog/949521", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "comment": "kezhuw merged PR #2185:\nURL: https://github.com/apache/zookeeper/pull/2185\n\n\n", "created": "2024-12-21T04:14:36.562+0000", "updated": "2024-12-21T04:14:36.562+0000", "started": "2024-12-21T04:14:36.562+0000", "timeSpent": "10m", "timeSpentSeconds": 600, "id": "949521", "issueId": "13591355"}]}, "archivedby": null, "customfield_12313920": null, "issuetype": {"self": "https://issues.apache.org/jira/rest/api/2/issuetype/1", "id": "1", "description": "A problem which impairs or prevents the functions of the product.", "iconUrl": "https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype", "name": "Bug", "subtask": false, "avatarId": 21133}, "timespent": 11400, "customfield_12314020": "{summaryBean=com.atlassian.jira.plugin.devstatus.rest.SummaryBean@25910f7d[summary={pullrequest=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@1cfbd664[overall=PullRequestOverallBean{stateCount=0, state='OPEN', details=PullRequestOverallDetails{openCount=0, mergedCount=0, declinedCount=0}},byInstanceType={}], build=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@62272c35[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BuildOverallBean@202d9ee3[failedBuildCount=0,successfulBuildCount=0,unknownBuildCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], review=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@480a2d10[overall=com.atlassian.jira.plugin.devstatus.summary.beans.ReviewsOverallBean@666a672[stateCount=0,state=<null>,dueDate=<null>,overDue=false,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], deployment-environment=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@5d7b740f[overall=com.atlassian.jira.plugin.devstatus.summary.beans.DeploymentOverallBean@11ed33c5[topEnvironments=[],showProjects=false,successfulCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], repository=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@896ee45[overall=com.atlassian.jira.plugin.devstatus.summary.beans.CommitOverallBean@3b709c13[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], branch=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@3dad4c7e[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BranchOverallBean@45262315[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}]},errors=[],configErrors=[]], devSummaryJson={\"cachedValue\":{\"errors\":[],\"configErrors\":[],\"summary\":{\"pullrequest\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":\"OPEN\",\"details\":{\"openCount\":0,\"mergedCount\":0,\"declinedCount\":0,\"total\":0},\"open\":true},\"byInstanceType\":{}},\"build\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"failedBuildCount\":0,\"successfulBuildCount\":0,\"unknownBuildCount\":0},\"byInstanceType\":{}},\"review\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":null,\"dueDate\":null,\"overDue\":false,\"completed\":false},\"byInstanceType\":{}},\"deployment-environment\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"topEnvironments\":[],\"showProjects\":false,\"successfulCount\":0},\"byInstanceType\":{}},\"repository\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}},\"branch\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}}}},\"isStale\":false}}", "customfield_12314141": null, "customfield_12314140": null, "project": {"self": "https://issues.apache.org/jira/rest/api/2/project/12310801", "id": "12310801", "key": "ZOOKEEPER", "name": "ZooKeeper", "projectTypeKey": "software", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/projectavatar?pid=12310801&avatarId=10011", "24x24": "https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310801&avatarId=10011", "16x16": "https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310801&avatarId=10011", "32x32": "https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310801&avatarId=10011"}, "projectCategory": {"self": "https://issues.apache.org/jira/rest/api/2/projectCategory/10484", "id": "10484", "description": "Apache ZooKeeper related", "name": "ZooKeeper"}}, "aggregatetimespent": 11400, "customfield_12312520": null, "customfield_12312521": "Sat Dec 21 04:15:52 UTC 2024", "customfield_12314422": null, "customfield_12314421": null, "customfield_12314146": null, "customfield_12314420": null, "customfield_12314145": null, "customfield_12314144": null, "customfield_12314143": null, "resolutiondate": "2024-12-21T04:15:52.000+0000", "workratio": -1, "customfield_12312923": null, "customfield_12312920": null, "customfield_12312921": null, "watches": {"self": "https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-4858/watchers", "watchCount": 1, "isWatching": false}, "created": "2024-09-07T01:49:39.000+0000", "customfield_12310192": null, "customfield_12310191": null, "customfield_12310230": null, "updated": "2025-08-29T21:29:01.000+0000", "timeoriginalestimate": null, "description": "Remove the synchronized keyword from Zookeeper.takeSnapshot() and  ZookeeperServer.restoreFromSnapshot() API, as it causes lock contention on the ZookeeperServer object with the sync operation. \r\n\r\nIn ZookeeperServer.java, we have the following\r\n{code:java}\r\n\r\n public synchronized File takeSnapshot(boolean syncSnap, boolean isSevere, boolean fastForwardFromEdits) throws IOException {\r\n....\r\n}\r\n{code}\r\n\r\nIn ObserverZookeeperServer.java and FollowerZookeeperServer.java, we have the following\r\n       \r\n{code:java}\r\npublic synchronized void sync() {\r\n     ...\r\n    }\r\n\r\n{code}\r\n\r\n\r\n", "customfield_10010": null, "timetracking": {"remainingEstimate": "0h", "timeSpent": "3h 10m", "remainingEstimateSeconds": 0, "timeSpentSeconds": 11400}, "customfield_12314523": null, "customfield_12314127": null, "customfield_12314522": null, "customfield_12314126": null, "customfield_12314521": null, "customfield_12314125": null, "customfield_12314520": null, "customfield_12314124": null, "customfield_12312340": null, "attachment": [], "customfield_12314123": null, "customfield_12312341": null, "customfield_12312220": null, "customfield_12314122": null, "customfield_12314121": null, "customfield_12314120": null, "customfield_12314129": null, "customfield_12314524": null, "customfield_12314128": null, "summary": "Remove the lock contention between snapshotting and the sync operation", "customfield_12314130": null, "customfield_12310291": null, "customfield_12310290": null, "customfield_12311024": null, "customfield_12314138": null, "customfield_12314137": null, "environment": null, "customfield_12314136": null, "customfield_12314135": null, "customfield_12311020": null, "customfield_12314134": null, "duedate": null, "customfield_12314132": null, "customfield_12314131": null, "comment": {"comments": [{"self": "https://issues.apache.org/jira/rest/api/2/issue/13591355/comment/17879993", "id": "17879993", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=li4wang", "name": "li4wang", "key": "JIRAUSER299380", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Li Wang", "active": true, "timeZone": "America/Los_Angeles"}, "body": "Will submit a patch for it.", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=li4wang", "name": "li4wang", "key": "JIRAUSER299380", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Li Wang", "active": true, "timeZone": "America/Los_Angeles"}, "created": "2024-09-07T01:54:13.370+0000", "updated": "2024-09-07T01:59:59.948+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13591355/comment/17907532", "id": "17907532", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=kezhuw", "name": "kezhuw", "key": "kezhuw", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=kezhuw&avatarId=37929", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kezhuw&avatarId=37929", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kezhuw&avatarId=37929", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kezhuw&avatarId=37929"}, "displayName": "Kezhu Wang", "active": true, "timeZone": "Etc/GMT-8"}, "body": "Issue resolved by pull request 2185\n[https://github.com/apache/zookeeper/pull/2185]", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=kezhuw", "name": "kezhuw", "key": "kezhuw", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=kezhuw&avatarId=37929", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kezhuw&avatarId=37929", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kezhuw&avatarId=37929", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kezhuw&avatarId=37929"}, "displayName": "Kezhu Wang", "active": true, "timeZone": "Etc/GMT-8"}, "created": "2024-12-21T04:15:52.260+0000", "updated": "2024-12-21T04:15:52.260+0000"}], "maxResults": 2, "total": 2, "startAt": 0}, "customfield_12311820": "0|z1ragw:", "customfield_12314139": null}}