{"expand": "operations,versionedRepresentations,editmeta,changelog,renderedFields", "id": "13587121", "self": "https://issues.apache.org/jira/rest/api/2/issue/13587121", "key": "ZOOKEEPER-4846", "fields": {"fixVersions": [{"self": "https://issues.apache.org/jira/rest/api/2/version/12353481", "id": "12353481", "name": "3.10.0", "archived": false, "released": false}, {"self": "https://issues.apache.org/jira/rest/api/2/version/12354431", "id": "12354431", "description": "", "name": "3.8.5", "archived": false, "released": true, "releaseDate": "2025-09-18"}, {"self": "https://issues.apache.org/jira/rest/api/2/version/12355230", "id": "12355230", "description": "", "name": "3.9.4", "archived": false, "released": true, "releaseDate": "2025-08-29"}], "resolution": {"self": "https://issues.apache.org/jira/rest/api/2/resolution/1", "id": "1", "description": "A fix for this issue is checked into the tree and tested.", "name": "Fixed"}, "customfield_12312322": null, "customfield_12312323": null, "customfield_12310420": "9223372036854775807", "customfield_12312320": null, "customfield_12312321": null, "customfield_12312328": null, "customfield_12312329": null, "customfield_12312326": null, "customfield_12310300": null, "customfield_12312327": null, "customfield_12312324": null, "customfield_12312720": null, "customfield_12312325": null, "lastViewed": null, "priority": {"self": "https://issues.apache.org/jira/rest/api/2/priority/1", "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/blocker.svg", "name": "Blocker", "id": "1"}, "labels": ["pull-request-available"], "customfield_12312333": null, "customfield_12312334": null, "customfield_12313422": "false", "customfield_12310310": "0.0", "customfield_12312331": null, "customfield_12312332": null, "aggregatetimeoriginalestimate": null, "timeestimate": 0, "customfield_12312330": null, "versions": [], "customfield_12311120": null, "customfield_12313826": null, "issuelinks": [{"id": "12690981", "self": "https://issues.apache.org/jira/rest/api/2/issueLink/12690981", "type": {"id": "10030", "name": "Reference", "inward": "is related to", "outward": "relates to", "self": "https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"}, "inwardIssue": {"id": "13595141", "key": "ZOOKEEPER-4874", "self": "https://issues.apache.org/jira/rest/api/2/issue/13595141", "fields": {"summary": "Avoid using fuzzy snapshots.", "status": {"self": "https://issues.apache.org/jira/rest/api/2/status/1", "description": "The issue is open and ready for the assignee to start work on it.", "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/open.png", "name": "Open", "id": "1", "statusCategory": {"self": "https://issues.apache.org/jira/rest/api/2/statuscategory/2", "id": 2, "key": "new", "colorName": "blue-gray", "name": "To Do"}}, "priority": {"self": "https://issues.apache.org/jira/rest/api/2/priority/3", "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/major.svg", "name": "Major", "id": "3"}, "issuetype": {"self": "https://issues.apache.org/jira/rest/api/2/issuetype/4", "id": "4", "description": "An improvement or enhancement to an existing feature or task.", "iconUrl": "https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21140&avatarType=issuetype", "name": "Improvement", "subtask": false, "avatarId": 21140}}}}], "customfield_12312339": null, "customfield_12313825": null, "assignee": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=ztzg", "name": "ztzg", "key": "ztzg", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=ztzg&avatarId=39828", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=ztzg&avatarId=39828", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=ztzg&avatarId=39828", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=ztzg&avatarId=39828"}, "displayName": "Damien Diederen", "active": true, "timeZone": "Europe/Berlin"}, "customfield_12312337": null, "customfield_12313823": null, "customfield_12312338": null, "customfield_12311920": null, "customfield_12313822": null, "customfield_12312335": null, "customfield_12313821": null, "customfield_12312336": null, "customfield_12313820": null, "status": {"self": "https://issues.apache.org/jira/rest/api/2/status/6", "description": "The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.", "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/closed.png", "name": "Closed", "id": "6", "statusCategory": {"self": "https://issues.apache.org/jira/rest/api/2/statuscategory/3", "id": 3, "key": "done", "colorName": "green", "name": "Done"}}, "components": [], "archiveddate": null, "customfield_12312026": null, "customfield_12312023": null, "customfield_12312024": null, "aggregatetimeestimate": 0, "customfield_12312022": null, "customfield_12310921": null, "customfield_12310920": "9223372036854775807", "customfield_12312823": null, "creator": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=ztzg", "name": "ztzg", "key": "ztzg", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=ztzg&avatarId=39828", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=ztzg&avatarId=39828", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=ztzg&avatarId=39828", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=ztzg&avatarId=39828"}, "displayName": "Damien Diederen", "active": true, "timeZone": "Europe/Berlin"}, "subtasks": [], "reporter": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=ztzg", "name": "ztzg", "key": "ztzg", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=ztzg&avatarId=39828", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=ztzg&avatarId=39828", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=ztzg&avatarId=39828", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=ztzg&avatarId=39828"}, "displayName": "Damien Diederen", "active": true, "timeZone": "Europe/Berlin"}, "aggregateprogress": {"progress": 7200, "total": 7200, "percent": 100}, "customfield_12313520": null, "customfield_12310250": null, "progress": {"progress": 7200, "total": 7200, "percent": 100}, "customfield_12313924": null, "votes": {"self": "https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-4846/votes", "votes": 0, "hasVoted": false}, "worklog": {"startAt": 0, "maxResults": 20, "total": 12, "worklogs": [{"self": "https://issues.apache.org/jira/rest/api/2/issue/13587121/worklog/932142", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "comment": "ztzg opened a new pull request, #2183:\nURL: https://github.com/apache/zookeeper/pull/2183\n\n   ZooKeeper snapshots are *fuzzy*, as the server does not stop processing requests while ACLs and nodes are being streamed to disk.\r\n   \r\n   ACLs, notably, are streamed *first*, as a mapping between the full serialized ACL and an \"ACL ID\" referenced by the node.\r\n   \r\n   Consequently, a snapshot can very well contain ACL IDs which do not exist in the mapping. Prior to ZOOKEEPER-4799, such situations would produce harmless (if annoying) \"Ignoring acl XYZ as it does not exist in the cache\" INFO entries in the server logs.\r\n   \r\n   With ZOOKEEPER-4799, we started \"eagerly\" fetching the referenced ACLs in `DataTree` operations such as `createNode`, `deleteNode`, etc.—as opposed to just fetching them from request processors.\r\n   \r\n   This can result in fatal errors during the `fastForwardFromEdits` phase of restoring a database, when transactions are processed on top of an inconsistent data tree—preventing the server from starting.\r\n   \r\n   The errors are thrown in this code path:\r\n   \r\n   ``` java\r\n   // ReferenceCountedACLCache.java:90\r\n   List<ACL> acls = longKeyMap.get(longVal);\r\n   if (acls == null) {\r\n       LOG.error(\"ERROR: ACL not available for long {}\", longVal);\r\n       throw new RuntimeException(\"Failed to fetch acls for \" + longVal);\r\n   }\r\n   ```\r\n   \r\n   Here is a scenario leading to such a failure:\r\n   \r\n   - An existing node `/foo`, sporting an unique ACL, is deleted. This is recorded in transaction log `$SNAP-1`; said ACL is also deallocated;\r\n   - Snapshot `$SNAP` is started;\r\n   - The ACL map is serialized to `$SNAP`;\r\n   - A new node `/foo` sporting the same unique ACL is created in a portion of the data tree which still has to be serialized;\r\n   - Node `/foo` is serialized to `$SNAP`—but its ACL isn't;\r\n   - The server is restarted;\r\n   - The `DataTree` is initialized from `$SNAP`, including node `/foo` with a dangling ACL reference;\r\n   - Transaction log `$SNAP-1` is being replayed, leading to a `deleteNode(\"/foo\")`;\r\n   - `getACL(node)` panics.\r\n   \n\n\n", "created": "2024-08-28T12:10:35.741+0000", "updated": "2024-08-28T12:10:35.741+0000", "started": "2024-08-28T12:10:35.741+0000", "timeSpent": "10m", "timeSpentSeconds": 600, "id": "932142", "issueId": "13587121"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13587121/worklog/955698", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "comment": "anmolnar commented on PR #2183:\nURL: https://github.com/apache/zookeeper/pull/2183#issuecomment-2638033144\n\n   hi @ztzg , are u still working on this patch?\r\n   \n\n\n", "created": "2025-02-05T21:12:56.533+0000", "updated": "2025-02-05T21:12:56.533+0000", "started": "2025-02-05T21:12:56.533+0000", "timeSpent": "10m", "timeSpentSeconds": 600, "id": "955698", "issueId": "13587121"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13587121/worklog/955823", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "comment": "ztzg commented on PR #2183:\nURL: https://github.com/apache/zookeeper/pull/2183#issuecomment-2639396703\n\n   Hi @anmolnar,\r\n   \r\n   > hi @ztzg , are u still working on this patch?\r\n   \r\n   We have been using it for a while without adverse effects.  I am not working on it, but some decisions in the patch are perhaps a bit controversial. I will \"undraft\" if it helps getting more reviews & comments :)\n\n\n", "created": "2025-02-06T10:18:02.031+0000", "updated": "2025-02-06T10:18:02.031+0000", "started": "2025-02-06T10:18:02.031+0000", "timeSpent": "10m", "timeSpentSeconds": 600, "id": "955823", "issueId": "13587121"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13587121/worklog/955967", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "comment": "anmolnar commented on PR #2183:\nURL: https://github.com/apache/zookeeper/pull/2183#issuecomment-2641341655\n\n   I've found the soluton. PTAL my comment in the Jira:\r\n   \r\n   https://issues.apache.org/jira/browse/ZOOKEEPER-4846?focusedCommentId=17924725&page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#comment-17924725\r\n   \n\n\n", "created": "2025-02-06T23:25:13.261+0000", "updated": "2025-02-06T23:25:13.261+0000", "started": "2025-02-06T23:25:13.261+0000", "timeSpent": "10m", "timeSpentSeconds": 600, "id": "955967", "issueId": "13587121"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13587121/worklog/956133", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "comment": "anmolnar opened a new pull request, #2222:\nURL: https://github.com/apache/zookeeper/pull/2222\n\n   In the scenario when ZooKeeper restore from fuzzy snapshot, there's possibility that we have a znode in the snapshot, but the attached ACL is missing from the ACL cache. In this case ZK will fast forward to the createTxn and replays is and while we skip re-creating the existing znode, we have a chance to fix the potentially wrong ACL reference.\n\n\n", "created": "2025-02-07T21:23:16.253+0000", "updated": "2025-02-07T21:23:16.253+0000", "started": "2025-02-07T21:23:16.252+0000", "timeSpent": "10m", "timeSpentSeconds": 600, "id": "956133", "issueId": "13587121"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13587121/worklog/956134", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "comment": "anmolnar commented on PR #2183:\nURL: https://github.com/apache/zookeeper/pull/2183#issuecomment-2644155384\n\n   Apols @ztzg , I quickly created the alternate patch to get feedback as soon as possible: #2222 \r\n   Don't wanna take the credit, so we should commit as yours eventually once we have agreement.\n\n\n", "created": "2025-02-07T21:24:31.097+0000", "updated": "2025-02-07T21:24:31.097+0000", "started": "2025-02-07T21:24:31.096+0000", "timeSpent": "10m", "timeSpentSeconds": 600, "id": "956134", "issueId": "13587121"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13587121/worklog/956135", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "comment": "anmolnar commented on PR #2222:\nURL: https://github.com/apache/zookeeper/pull/2222#issuecomment-2644156194\n\n   ping @ztzg @cnauroth \n\n\n", "created": "2025-02-07T21:25:00.779+0000", "updated": "2025-02-07T21:25:00.779+0000", "started": "2025-02-07T21:25:00.779+0000", "timeSpent": "10m", "timeSpentSeconds": 600, "id": "956135", "issueId": "13587121"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13587121/worklog/956470", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "comment": "ztzg commented on code in PR #2222:\nURL: https://github.com/apache/zookeeper/pull/2222#discussion_r1950277286\n\n\n##########\nzookeeper-server/src/main/java/org/apache/zookeeper/server/DataTree.java:\n##########\n@@ -462,8 +462,9 @@ public void createNode(final String path, byte[] data, List<ACL> acl, long ephem\n             // we did for the global sessions.\n             Long acls = aclCache.convertAcls(acl);\n \n-            Set<String> children = parent.getChildren();\n-            if (children.contains(childName)) {\n+            DataNode existingChild = nodes.get(path);\n+            if (existingChild != null) {\n+                existingChild.acl = acls;\n\nReview Comment:\n   I have not had a chance to play with this, but: this means we are relying on `PrepRequestProcessor` to prevent `OpCode.create*` operations from being abused as `OpCode.setACL`, right? (Just thinking out loud.)\n\n\n\n", "created": "2025-02-11T06:10:15.313+0000", "updated": "2025-02-11T06:10:15.313+0000", "started": "2025-02-11T06:10:15.312+0000", "timeSpent": "10m", "timeSpentSeconds": 600, "id": "956470", "issueId": "13587121"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13587121/worklog/956579", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "comment": "anmolnar commented on code in PR #2222:\nURL: https://github.com/apache/zookeeper/pull/2222#discussion_r1951123453\n\n\n##########\nzookeeper-server/src/main/java/org/apache/zookeeper/server/DataTree.java:\n##########\n@@ -462,8 +462,9 @@ public void createNode(final String path, byte[] data, List<ACL> acl, long ephem\n             // we did for the global sessions.\n             Long acls = aclCache.convertAcls(acl);\n \n-            Set<String> children = parent.getChildren();\n-            if (children.contains(childName)) {\n+            DataNode existingChild = nodes.get(path);\n+            if (existingChild != null) {\n+                existingChild.acl = acls;\n\nReview Comment:\n   I'm not sure to be honest and not sure if I understand your question.\n\n\n\n", "created": "2025-02-11T15:58:46.289+0000", "updated": "2025-02-11T15:58:46.289+0000", "started": "2025-02-11T15:58:46.288+0000", "timeSpent": "10m", "timeSpentSeconds": 600, "id": "956579", "issueId": "13587121"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13587121/worklog/956585", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "comment": "anmolnar merged PR #2222:\nURL: https://github.com/apache/zookeeper/pull/2222\n\n\n", "created": "2025-02-11T16:43:23.232+0000", "updated": "2025-02-11T16:43:23.232+0000", "started": "2025-02-11T16:43:23.231+0000", "timeSpent": "10m", "timeSpentSeconds": 600, "id": "956585", "issueId": "13587121"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13587121/worklog/956587", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "comment": "anmolnar closed pull request #2183: ZOOKEEPER-4846: Failure to reload database due to missing ACL\nURL: https://github.com/apache/zookeeper/pull/2183\n\n\n", "created": "2025-02-11T16:49:43.087+0000", "updated": "2025-02-11T16:49:43.087+0000", "started": "2025-02-11T16:49:43.087+0000", "timeSpent": "10m", "timeSpentSeconds": 600, "id": "956587", "issueId": "13587121"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13587121/worklog/956588", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "comment": "anmolnar commented on PR #2183:\nURL: https://github.com/apache/zookeeper/pull/2183#issuecomment-2651428917\n\n   Superseded by #2222 \n\n\n", "created": "2025-02-11T16:49:43.905+0000", "updated": "2025-02-11T16:49:43.905+0000", "started": "2025-02-11T16:49:43.904+0000", "timeSpent": "10m", "timeSpentSeconds": 600, "id": "956588", "issueId": "13587121"}]}, "archivedby": null, "customfield_12313920": null, "issuetype": {"self": "https://issues.apache.org/jira/rest/api/2/issuetype/1", "id": "1", "description": "A problem which impairs or prevents the functions of the product.", "iconUrl": "https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype", "name": "Bug", "subtask": false, "avatarId": 21133}, "timespent": 7200, "customfield_12314020": "{summaryBean=com.atlassian.jira.plugin.devstatus.rest.SummaryBean@1a7987d1[summary={pullrequest=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@567b37aa[overall=PullRequestOverallBean{stateCount=0, state='OPEN', details=PullRequestOverallDetails{openCount=0, mergedCount=0, declinedCount=0}},byInstanceType={}], build=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@1893b318[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BuildOverallBean@175a01c7[failedBuildCount=0,successfulBuildCount=0,unknownBuildCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], review=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@54fd82ee[overall=com.atlassian.jira.plugin.devstatus.summary.beans.ReviewsOverallBean@d36d8b5[stateCount=0,state=<null>,dueDate=<null>,overDue=false,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], deployment-environment=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@838a178[overall=com.atlassian.jira.plugin.devstatus.summary.beans.DeploymentOverallBean@4f2bcd81[topEnvironments=[],showProjects=false,successfulCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], repository=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@7779dc78[overall=com.atlassian.jira.plugin.devstatus.summary.beans.CommitOverallBean@4c314152[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], branch=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@1cf1acd[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BranchOverallBean@109988b0[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}]},errors=[],configErrors=[]], devSummaryJson={\"cachedValue\":{\"errors\":[],\"configErrors\":[],\"summary\":{\"pullrequest\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":\"OPEN\",\"details\":{\"openCount\":0,\"mergedCount\":0,\"declinedCount\":0,\"total\":0},\"open\":true},\"byInstanceType\":{}},\"build\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"failedBuildCount\":0,\"successfulBuildCount\":0,\"unknownBuildCount\":0},\"byInstanceType\":{}},\"review\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":null,\"dueDate\":null,\"overDue\":false,\"completed\":false},\"byInstanceType\":{}},\"deployment-environment\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"topEnvironments\":[],\"showProjects\":false,\"successfulCount\":0},\"byInstanceType\":{}},\"repository\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}},\"branch\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}}}},\"isStale\":false}}", "customfield_12314141": null, "customfield_12314140": null, "project": {"self": "https://issues.apache.org/jira/rest/api/2/project/12310801", "id": "12310801", "key": "ZOOKEEPER", "name": "ZooKeeper", "projectTypeKey": "software", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/projectavatar?pid=12310801&avatarId=10011", "24x24": "https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310801&avatarId=10011", "16x16": "https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310801&avatarId=10011", "32x32": "https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310801&avatarId=10011"}, "projectCategory": {"self": "https://issues.apache.org/jira/rest/api/2/projectCategory/10484", "id": "10484", "description": "Apache ZooKeeper related", "name": "ZooKeeper"}}, "aggregatetimespent": 7200, "customfield_12312520": null, "customfield_12312521": "Tue Feb 11 16:49:08 UTC 2025", "customfield_12314422": null, "customfield_12314421": null, "customfield_12314146": null, "customfield_12314420": null, "customfield_12314145": null, "customfield_12314144": null, "customfield_12314143": null, "resolutiondate": "2025-02-11T16:49:08.000+0000", "workratio": -1, "customfield_12312923": null, "customfield_12312920": null, "customfield_12312921": null, "watches": {"self": "https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-4846/watchers", "watchCount": 4, "isWatching": false}, "created": "2024-07-28T10:51:12.000+0000", "customfield_12310192": null, "customfield_12310191": null, "customfield_12310230": null, "updated": "2025-08-29T21:28:59.000+0000", "timeoriginalestimate": null, "description": "ZooKeeper snapshots are {_}fuzzy{_}, as the server does not stop processing requests while ACLs and nodes are being streamed to disk.\r\n\r\nACLs, notably, are streamed {_}first{_}, as a mapping between the full serialized ACL and an \"ACL ID\" referenced by the node.\r\n\r\nConsequently, a snapshot can very well contain ACL IDs which do not exist in the mapping. Prior to ZOOKEEPER-4799, such situations would produce harmless (if annoying) \"Ignoring acl XYZ as it does not exist in the cache\" INFO entries in the server logs.\r\n\r\nWith ZOOKEEPER-4799, we started \"eagerly\" fetching the referenced ACLs in {{DataTree}} operations such as {{{}createNode{}}}, {{{}deleteNode{}}}, etc.—as opposed to just fetching them from request processors.\r\n\r\nThis can result in fatal errors during the {{fastForwardFromEdits}} phase of restoring a database, when transactions are processed on top of an inconsistent data tree—preventing the server from starting.\r\n\r\nThe errors are thrown in this code path:\r\n{code:java}\r\n// ReferenceCountedACLCache.java:90\r\nList<ACL> acls = longKeyMap.get(longVal);\r\nif (acls == null) {\r\n    LOG.error(\"ERROR: ACL not available for long {}\", longVal);\r\n    throw new RuntimeException(\"Failed to fetch acls for \" + longVal);\r\n}\r\n{code}\r\nHere is a scenario leading to such a failure:\r\n * An existing node {{{}/foo{}}}, sporting an unique ACL, is deleted. This is recorded in transaction log {{{}$SNAP-1{}}}; said ACL is also deallocated;\r\n * Snapshot {{$SNAP}} is started;\r\n * The ACL map is serialized to {{{}$SNAP{}}};\r\n * A new node {{/foo}} sporting the same unique ACL is created in a portion of the data tree which still has to be serialized;\r\n * Node {{/foo}} is serialized to {{{}$SNAP{}}}—but its ACL isn't;\r\n * The server is restarted;\r\n * The {{DataTree}} is initialized from {{{}$SNAP{}}}, including node {{/foo}} with a dangling ACL reference;\r\n * Transaction log {{$SNAP-1}} is being replayed, leading to a {{{}deleteNode(\"/foo\"){}}};\r\n * {{getACL(node)}} panics, preventing a successful restart.", "customfield_10010": null, "timetracking": {"remainingEstimate": "0h", "timeSpent": "2h", "remainingEstimateSeconds": 0, "timeSpentSeconds": 7200}, "customfield_12314523": null, "customfield_12314127": null, "customfield_12314522": null, "customfield_12314126": null, "customfield_12314521": null, "customfield_12314125": null, "customfield_12314520": null, "customfield_12314124": null, "customfield_12312340": null, "attachment": [], "customfield_12314123": null, "customfield_12312341": null, "customfield_12312220": null, "customfield_12314122": null, "customfield_12314121": null, "customfield_12314120": null, "customfield_12314129": null, "customfield_12314524": null, "customfield_12314128": null, "summary": "Failure to reload database due to missing ACL", "customfield_12314130": null, "customfield_12310291": null, "customfield_12310290": null, "customfield_12311024": null, "customfield_12314138": null, "customfield_12314137": null, "environment": null, "customfield_12314136": null, "customfield_12314135": null, "customfield_12311020": null, "customfield_12314134": null, "duedate": null, "customfield_12314132": null, "customfield_12314131": null, "comment": {"comments": [{"self": "https://issues.apache.org/jira/rest/api/2/issue/13587121/comment/17924680", "id": "17924680", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=andor", "name": "andor", "key": "andorm", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=andorm&avatarId=32935", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andorm&avatarId=32935", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andorm&avatarId=32935", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andorm&avatarId=32935"}, "displayName": "Andor Molnar", "active": true, "timeZone": "Europe/Budapest"}, "body": "Example stack trace.\r\n{noformat}\r\n2025-02-05 16:07:20,312 ERROR org.apache.zookeeper.server.ZooKeeperServerMain: Unexpected exception, exiting abnormally\r\njava.lang.RuntimeException: Failed to fetch acls for 7382\r\n        at org.apache.zookeeper.server.ReferenceCountedACLCache.convertLong(ReferenceCountedACLCache.java:93)\r\n        at org.apache.zookeeper.server.DataTree.getACL(DataTree.java:801)\r\n        at org.apache.zookeeper.server.DataTree.createNode(DataTree.java:455)\r\n        at org.apache.zookeeper.server.DataTree.processTxn(DataTree.java:881)\r\n        at org.apache.zookeeper.server.DataTree.processTxn(DataTree.java:864)\r\n        at org.apache.zookeeper.server.persistence.FileTxnSnapLog.processTransaction(FileTxnSnapLog.java:442)\r\n        at org.apache.zookeeper.server.persistence.FileTxnSnapLog.fastForwardFromEdits(FileTxnSnapLog.java:350)\r\n        at org.apache.zookeeper.server.persistence.FileTxnSnapLog.lambda$restore$0(FileTxnSnapLog.java:267)\r\n        at org.apache.zookeeper.server.persistence.FileTxnSnapLog.restore(FileTxnSnapLog.java:312)\r\n        at org.apache.zookeeper.server.ZKDatabase.loadDataBase(ZKDatabase.java:285)\r\n        at org.apache.zookeeper.server.ZooKeeperServer.loadData(ZooKeeperServer.java:531)\r\n        at org.apache.zookeeper.server.ZooKeeperServer.startdata(ZooKeeperServer.java:704)\r\n        at org.apache.zookeeper.server.NettyServerCnxnFactory.startup(NettyServerCnxnFactory.java:745)\r\n        at org.apache.zookeeper.server.ServerCnxnFactory.startup(ServerCnxnFactory.java:130)\r\n        at org.apache.zookeeper.server.ZooKeeperServerMain.runFromConfig(ZooKeeperServerMain.java:161)\r\n        at org.apache.zookeeper.server.ZooKeeperServerMain.initializeAndRun(ZooKeeperServerMain.java:113)\r\n        at org.apache.zookeeper.server.ZooKeeperServerMain.main(ZooKeeperServerMain.java:68)\r\n        at org.apache.zookeeper.server.quorum.QuorumPeerMain.initializeAndRun(QuorumPeerMain.java:141)\r\n        at org.apache.zookeeper.server.quorum.QuorumPeerMain.main(QuorumPeerMain.java:91){noformat}\r\nIt indicates that problem happens when trying to execute createTxn a znode whose *parent* doesn't have a valid ACL.", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=andor", "name": "andor", "key": "andorm", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=andorm&avatarId=32935", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andorm&avatarId=32935", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andorm&avatarId=32935", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andorm&avatarId=32935"}, "displayName": "Andor Molnar", "active": true, "timeZone": "Europe/Budapest"}, "created": "2025-02-06T19:49:33.856+0000", "updated": "2025-02-06T19:49:33.856+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13587121/comment/17924725", "id": "17924725", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=andor", "name": "andor", "key": "andorm", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=andorm&avatarId=32935", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andorm&avatarId=32935", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andorm&avatarId=32935", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andorm&avatarId=32935"}, "displayName": "Andor Molnar", "active": true, "timeZone": "Europe/Budapest"}, "body": "Found a solution. It's super simple. ZooKeeper actually doesn't lose that txn gap, it's in the previous logfile and it iterates over it.\r\n\r\nLook at this log snippet: \r\n{noformat}\r\n2025-02-06 17:12:40,818 [myid:] - INFO  [main:FileSnap@85] - Reading snapshot /home/andor/tmp/zookeeper/version-2/snapshot.674c0\r\n2025-02-06 17:12:40,845 [myid:] - INFO  [main:ReferenceCountedACLCache@174] - Ignoring acl 7382 as it does not exist in the cache\r\n2025-02-06 17:12:40,847 [myid:] - INFO  [main:DataTree@1719] - The digest in the snapshot has digest version of 2, with zxid as 0x674c1, and digest value as 8282470946294\r\n2025-02-06 17:12:40,858 [myid:] - INFO  [main:FileTxnLog$FileTxnIterator@693] - Going to next log file /home/andor/tmp/zookeeper/version-2/log.5a1df\r\n2025-02-06 17:12:40,924 [myid:] - INFO  [main:FileTxnSnapLog@351] - Processing zxid 0x674c1: 0x674c1\r\n2025-02-06 17:12:40,924 [myid:] - INFO  [main:DataTree@469] - Creating node /cloudera_manager_zookeeper_canary with acl 6\r\n2025-02-06 17:12:40,928 [myid:] - INFO  [main:FileTxnLog$FileTxnIterator@693] - Going to next log file /home/andor/tmp/zookeeper/version-2/log.674c2\r\n2025-02-06 17:12:40,928 [myid:] - INFO  [main:FileTxnSnapLog@351] - Processing zxid 0x674c2: 0x674c2\r\n2025-02-06 17:12:40,928 [myid:] - INFO  [main:FileTxnSnapLog@351] - Processing zxid 0x674c3: 0x674c3\r\n2025-02-06 17:12:40,929 [myid:] - ERROR [main:ReferenceCountedACLCache@92] - ERROR: ACL not available for long 7382\r\n2025-02-06 17:12:40,929 [myid:] - ERROR [main:ZooKeeperServerMain@91] - Unexpected exception, exiting abnormally\r\njava.lang.RuntimeException: Failed to fetch acls for 7382\r\n        at org.apache.zookeeper.server.ReferenceCountedACLCache.convertLong(ReferenceCountedACLCache.java:93)\r\n{noformat}\r\nSnapshot zxid is {*}0x674c0{*}, so ZK goes to txn logfile *0x5a1df* first and fast forward to txn zxid {*}0x674c1{*}, so actually processing the txn where the parent znode was created. Clearly the ACL id is different in the cache and the data tree: 6 <> 7382\r\n\r\nLook at the code where we process the txn:\r\n{code:java}\r\nsynchronized (parent) {\r\n    parentAcl = getACL(parent);    // Add the ACL to ACL cache first, to avoid the ACL not being\r\n    // created race condition during fuzzy snapshot sync.\r\n    //\r\n    // This is the simplest fix, which may add ACL reference count\r\n    // again if it's already counted in in the ACL map of fuzzy\r\n    // snapshot, which might also happen for deleteNode txn, but\r\n    // at least it won't cause the ACL not exist issue.\r\n    //\r\n    // Later we can audit and delete all non-referenced ACLs from\r\n    // ACL map when loading the snapshot/txns from disk, like what\r\n    // we did for the global sessions.\r\n    Long longval = aclCache.convertAcls(acl);   <---- we re-create the ACL in the ACL cache, but potentially with different id             \r\n    Set<String> children = parent.getChildren();\r\n    if (children.contains(childName)) {\r\n        throw new KeeperException.NodeExistsException();    <---- znode already exists in DataTree, so we skip\r\n    }\r\n...  {code}\r\nThe only thing that we need to do here is to get a reference to the existing znode and fix the ACL reference.\r\n{code:java}\r\nif (children.contains(childName)) {\r\n    DataNode child = nodes.get(path);\r\n    child.acl = longval;\r\n    throw new KeeperException.NodeExistsException();\r\n} {code}\r\nor maybe something more elegant.\r\n\r\nWe don't lose the ACL information.", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=andor", "name": "andor", "key": "andorm", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=andorm&avatarId=32935", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andorm&avatarId=32935", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andorm&avatarId=32935", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andorm&avatarId=32935"}, "displayName": "Andor Molnar", "active": true, "timeZone": "Europe/Budapest"}, "created": "2025-02-06T23:21:35.126+0000", "updated": "2025-02-06T23:21:57.157+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13587121/comment/17924952", "id": "17924952", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=cnauroth", "name": "cnauroth", "key": "cnauroth", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=cnauroth&avatarId=11432", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cnauroth&avatarId=11432", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cnauroth&avatarId=11432", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cnauroth&avatarId=11432"}, "displayName": "Chris Nauroth", "active": true, "timeZone": "America/Los_Angeles"}, "body": "[~andor] , nice, I think that makes sense!", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=cnauroth", "name": "cnauroth", "key": "cnauroth", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=cnauroth&avatarId=11432", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cnauroth&avatarId=11432", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cnauroth&avatarId=11432", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cnauroth&avatarId=11432"}, "displayName": "Chris Nauroth", "active": true, "timeZone": "America/Los_Angeles"}, "created": "2025-02-07T16:36:25.600+0000", "updated": "2025-02-07T16:36:25.600+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13587121/comment/17926062", "id": "17926062", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=andor", "name": "andor", "key": "andorm", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=andorm&avatarId=32935", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andorm&avatarId=32935", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andorm&avatarId=32935", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andorm&avatarId=32935"}, "displayName": "Andor Molnar", "active": true, "timeZone": "Europe/Budapest"}, "body": "Issue resolved by pull request 2222\n[https://github.com/apache/zookeeper/pull/2222]", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=andor", "name": "andor", "key": "andorm", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=andorm&avatarId=32935", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andorm&avatarId=32935", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andorm&avatarId=32935", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andorm&avatarId=32935"}, "displayName": "Andor Molnar", "active": true, "timeZone": "Europe/Budapest"}, "created": "2025-02-11T16:49:08.691+0000", "updated": "2025-02-11T16:49:08.691+0000"}], "maxResults": 4, "total": 4, "startAt": 0}, "customfield_12311820": "0|z1qkdc:", "customfield_12314139": null}}