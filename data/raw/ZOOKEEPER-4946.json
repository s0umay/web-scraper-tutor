{"expand": "operations,versionedRepresentations,editmeta,changelog,renderedFields", "id": "13622286", "self": "https://issues.apache.org/jira/rest/api/2/issue/13622286", "key": "ZOOKEEPER-4946", "fields": {"fixVersions": [], "resolution": null, "customfield_12312322": null, "customfield_12312323": null, "customfield_12310420": "9223372036854775807", "customfield_12312320": null, "customfield_12312321": null, "customfield_12312328": null, "customfield_12312329": null, "customfield_12312326": null, "customfield_12310300": null, "customfield_12312327": null, "customfield_12312324": null, "customfield_12312720": null, "customfield_12312325": null, "lastViewed": null, "priority": {"self": "https://issues.apache.org/jira/rest/api/2/priority/2", "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/critical.svg", "name": "Critical", "id": "2"}, "labels": [], "customfield_12312333": null, "customfield_12312334": null, "customfield_12313422": "false", "customfield_12310310": "1.0", "customfield_12312331": null, "customfield_12312332": null, "aggregatetimeoriginalestimate": null, "timeestimate": null, "customfield_12312330": null, "versions": [{"self": "https://issues.apache.org/jira/rest/api/2/version/12349434", "id": "12349434", "name": "3.5.10", "archived": false, "released": true, "releaseDate": "2022-06-04"}, {"self": "https://issues.apache.org/jira/rest/api/2/version/12350076", "id": "12350076", "description": "Fix release against 3.6 branch", "name": "3.6.4", "archived": false, "released": true, "releaseDate": "2022-12-22"}, {"self": "https://issues.apache.org/jira/rest/api/2/version/12351732", "id": "12351732", "description": "Fix release against 3.7 branch", "name": "3.7.2", "archived": false, "released": true, "releaseDate": "2023-10-09"}, {"self": "https://issues.apache.org/jira/rest/api/2/version/12353693", "id": "12353693", "description": "", "name": "3.8.4", "archived": false, "released": true, "releaseDate": "2024-03-05"}, {"self": "https://issues.apache.org/jira/rest/api/2/version/12354432", "id": "12354432", "description": "", "name": "3.9.3", "archived": false, "released": true, "releaseDate": "2024-10-24"}], "customfield_12311120": null, "customfield_12313826": null, "issuelinks": [], "customfield_12312339": null, "customfield_12313825": null, "assignee": null, "customfield_12312337": null, "customfield_12313823": null, "customfield_12312338": null, "customfield_12311920": null, "customfield_12313822": null, "customfield_12312335": null, "customfield_12313821": null, "customfield_12312336": null, "customfield_12313820": null, "status": {"self": "https://issues.apache.org/jira/rest/api/2/status/10002", "description": "A patch for this issue has been uploaded to JIRA by a contributor.", "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/document.png", "name": "Patch Available", "id": "10002", "statusCategory": {"self": "https://issues.apache.org/jira/rest/api/2/statuscategory/4", "id": 4, "key": "indeterminate", "colorName": "yellow", "name": "In Progress"}}, "components": [{"self": "https://issues.apache.org/jira/rest/api/2/component/12312382", "id": "12312382", "name": "server", "description": "General issues with the ZooKeeper server."}], "archiveddate": null, "customfield_12312026": null, "customfield_12312023": null, "customfield_12312024": null, "aggregatetimeestimate": null, "customfield_12312022": null, "customfield_12310921": null, "customfield_12310920": "9223372036854775807", "customfield_12312823": null, "creator": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=zhanglu153", "name": "zhanglu153", "key": "JIRAUSER298392", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34046", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34046", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34046", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34046"}, "displayName": "zhanglu153", "active": true, "timeZone": "Etc/UTC"}, "subtasks": [], "reporter": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=zhanglu153", "name": "zhanglu153", "key": "JIRAUSER298392", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34046", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34046", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34046", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34046"}, "displayName": "zhanglu153", "active": true, "timeZone": "Etc/UTC"}, "aggregateprogress": {"progress": 0, "total": 0}, "customfield_12313520": null, "customfield_12310250": null, "progress": {"progress": 0, "total": 0}, "customfield_12313924": null, "votes": {"self": "https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-4946/votes", "votes": 0, "hasVoted": false}, "worklog": {"startAt": 0, "maxResults": 20, "total": 0, "worklogs": []}, "archivedby": null, "customfield_12313920": null, "issuetype": {"self": "https://issues.apache.org/jira/rest/api/2/issuetype/1", "id": "1", "description": "A problem which impairs or prevents the functions of the product.", "iconUrl": "https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype", "name": "Bug", "subtask": false, "avatarId": 21133}, "timespent": null, "customfield_12314020": "{summaryBean=com.atlassian.jira.plugin.devstatus.rest.SummaryBean@19daf8f1[summary={pullrequest=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@7ba97c64[overall=PullRequestOverallBean{stateCount=0, state='OPEN', details=PullRequestOverallDetails{openCount=0, mergedCount=0, declinedCount=0}},byInstanceType={}], build=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@7bb1cc6b[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BuildOverallBean@4b4bc525[failedBuildCount=0,successfulBuildCount=0,unknownBuildCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], review=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@49f9e91e[overall=com.atlassian.jira.plugin.devstatus.summary.beans.ReviewsOverallBean@6901bf70[stateCount=0,state=<null>,dueDate=<null>,overDue=false,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], deployment-environment=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@1ca6e4af[overall=com.atlassian.jira.plugin.devstatus.summary.beans.DeploymentOverallBean@9d178f3[topEnvironments=[],showProjects=false,successfulCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], repository=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@fe6c1ce[overall=com.atlassian.jira.plugin.devstatus.summary.beans.CommitOverallBean@6bf8057d[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], branch=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@40d00731[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BranchOverallBean@42c4f938[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}]},errors=[],configErrors=[]], devSummaryJson={\"cachedValue\":{\"errors\":[],\"configErrors\":[],\"summary\":{\"pullrequest\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":\"OPEN\",\"details\":{\"openCount\":0,\"mergedCount\":0,\"declinedCount\":0,\"total\":0},\"open\":true},\"byInstanceType\":{}},\"build\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"failedBuildCount\":0,\"successfulBuildCount\":0,\"unknownBuildCount\":0},\"byInstanceType\":{}},\"review\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":null,\"dueDate\":null,\"overDue\":false,\"completed\":false},\"byInstanceType\":{}},\"deployment-environment\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"topEnvironments\":[],\"showProjects\":false,\"successfulCount\":0},\"byInstanceType\":{}},\"repository\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}},\"branch\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}}}},\"isStale\":false}}", "customfield_12314141": null, "customfield_12314140": null, "project": {"self": "https://issues.apache.org/jira/rest/api/2/project/12310801", "id": "12310801", "key": "ZOOKEEPER", "name": "ZooKeeper", "projectTypeKey": "software", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/projectavatar?pid=12310801&avatarId=10011", "24x24": "https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310801&avatarId=10011", "16x16": "https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310801&avatarId=10011", "32x32": "https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310801&avatarId=10011"}, "projectCategory": {"self": "https://issues.apache.org/jira/rest/api/2/projectCategory/10484", "id": "10484", "description": "Apache ZooKeeper related", "name": "ZooKeeper"}}, "aggregatetimespent": null, "customfield_12312520": null, "customfield_12312521": "Wed Jul 02 02:51:53 UTC 2025", "customfield_12314422": null, "customfield_12314421": null, "customfield_12314146": null, "customfield_12314420": null, "customfield_12314145": null, "customfield_12314144": null, "customfield_12314143": null, "resolutiondate": null, "workratio": -1, "customfield_12312923": null, "customfield_12312920": null, "customfield_12312921": null, "watches": {"self": "https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-4946/watchers", "watchCount": 1, "isWatching": false}, "created": "2025-07-02T02:15:16.000+0000", "customfield_12310192": null, "customfield_12310191": null, "customfield_12310230": null, "updated": "2025-07-02T03:30:46.000+0000", "timeoriginalestimate": null, "description": "Call org.apache.zookeeper.client.ZooKeeperSaslClient#shutdown method in sendThread to close the zooKeeperSaslClient, that is, shutdown Login thread. Although the t.interrupt method was called, the run method of the Login thread did not detect the thread being interrupted. For example, when the Login thread enters the while loop of reLogin, there may be a situation where the Login thread cannot interrupt.\r\n\r\nThis will cause the t.join method to remain blocked, resulting in the sendThread thread being blocked and unabled to complete execution. This may result in many zk requests being unable to be released, such as possible deadlocks, due to sendThread being blocked in lower versions of zk, such as 3.5 and 3.6. Higher versions of zk, such as 3.8 and 3.9, have leaked sendThread threads.", "customfield_10010": null, "timetracking": {}, "customfield_12314523": null, "customfield_12314127": null, "customfield_12314522": null, "customfield_12314126": null, "customfield_12314521": null, "customfield_12314125": null, "customfield_12314520": null, "customfield_12314124": null, "customfield_12312340": null, "attachment": [{"self": "https://issues.apache.org/jira/rest/api/2/attachment/13077280", "id": "13077280", "filename": "0001-Login.patch", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=zhanglu153", "name": "zhanglu153", "key": "JIRAUSER298392", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34046", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34046", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34046", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34046"}, "displayName": "zhanglu153", "active": true, "timeZone": "Etc/UTC"}, "created": "2025-07-02T03:30:44.116+0000", "size": 3559, "mimeType": "text/plain", "content": "https://issues.apache.org/jira/secure/attachment/13077280/0001-Login.patch"}], "customfield_12314123": null, "customfield_12312341": null, "customfield_12312220": null, "customfield_12314122": null, "customfield_12314121": null, "customfield_12314120": null, "customfield_12314129": null, "customfield_12314524": null, "customfield_12314128": null, "summary": "Login thread failed to shutdown successfully, causing SendThead to be blocked", "customfield_12314130": null, "customfield_12310291": null, "customfield_12310290": null, "customfield_12311024": null, "customfield_12314138": null, "customfield_12314137": null, "environment": null, "customfield_12314136": null, "customfield_12314135": null, "customfield_12311020": null, "customfield_12314134": null, "duedate": null, "customfield_12314132": null, "customfield_12314131": null, "comment": {"comments": [{"self": "https://issues.apache.org/jira/rest/api/2/issue/13622286/comment/17987313", "id": "17987313", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=zhanglu153", "name": "zhanglu153", "key": "JIRAUSER298392", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34046", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34046", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34046", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34046"}, "displayName": "zhanglu153", "active": true, "timeZone": "Etc/UTC"}, "body": "Call org.apache.zookeeper.client.ZooKeeperSaslClient#shutdown method, which is the shutdown Login thread.\r\n{code:java}\r\npublic void shutdown() {\r\n    if ((t != null) && (t.isAlive())) {\r\n        t.interrupt();\r\n        try {\r\n            t.join();\r\n        } catch (InterruptedException e) {\r\n            LOG.warn(\"error while waiting for Login thread to shutdown: \" + e);\r\n        }\r\n    }\r\n} {code}\r\nAfter calling t.interrupt, if the Login thread is not executing the Thread.sleep method, other code blocks cannot perceive that the thread has been interrupted and still ger stuck in a dead loop. This will cause the t.join method to consistently block the sendThread.\r\n\r\nFor example, when there is a failure in kerberos, the reLogin method call throws an exception. After retry has been set to 0, the reLogin method will be repeatedly called until successful. If the t.interrupt method is called at this time, the Login thread cannot be successfully interrupted. t.join method will block the sendThread method.\r\n{code:java}\r\ntry {\r\n    int retry = 1;\r\n    while (retry >= 0) {\r\n        try {\r\n            reLogin();\r\n            break;\r\n        } catch (LoginException le) {\r\n            if (retry > 0) {\r\n                --retry;\r\n                // sleep for 10 seconds.\r\n                try {\r\n                    sleepBeforeRetryFailedRefresh();\r\n                } catch (InterruptedException e) {\r\n                    LOG.error(\"Interrupted during login retry after LoginException:\", le);\r\n                    throw le;\r\n                }\r\n            } else {\r\n                LOG.error(\"Could not refresh TGT for principal: {}.\", principal, le);\r\n            }\r\n        }\r\n    }\r\n} catch (LoginException le) {\r\n    LOG.error(\"Failed to refresh TGT: refresh thread exiting now.\", le);\r\n    break;\r\n}{code}", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=zhanglu153", "name": "zhanglu153", "key": "JIRAUSER298392", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34046", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34046", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34046", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34046"}, "displayName": "zhanglu153", "active": true, "timeZone": "Etc/UTC"}, "created": "2025-07-02T02:51:53.788+0000", "updated": "2025-07-02T02:51:53.788+0000"}], "maxResults": 1, "total": 1, "startAt": 0}, "customfield_12311820": "0|z1wkf4:", "customfield_12314139": null}}