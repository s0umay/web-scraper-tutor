{"expand": "operations,versionedRepresentations,editmeta,changelog,renderedFields", "id": "13598616", "self": "https://issues.apache.org/jira/rest/api/2/issue/13598616", "key": "ZOOKEEPER-4885", "fields": {"fixVersions": [], "resolution": null, "customfield_12312322": null, "customfield_12312323": null, "customfield_12310420": "9223372036854775807", "customfield_12312320": null, "customfield_12312321": null, "customfield_12312328": null, "customfield_12312329": null, "customfield_12312326": null, "customfield_12310300": null, "customfield_12312327": null, "customfield_12312324": null, "customfield_12312720": null, "customfield_12312325": null, "lastViewed": null, "priority": {"self": "https://issues.apache.org/jira/rest/api/2/priority/3", "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/major.svg", "name": "Major", "id": "3"}, "labels": [], "customfield_12312333": null, "customfield_12312334": null, "customfield_12313422": "false", "customfield_12310310": "0.0", "customfield_12312331": null, "customfield_12312332": null, "aggregatetimeoriginalestimate": null, "timeestimate": null, "customfield_12312330": null, "versions": [{"self": "https://issues.apache.org/jira/rest/api/2/version/12343587", "id": "12343587", "name": "3.4.14", "archived": false, "released": true, "releaseDate": "2019-04-02"}, {"self": "https://issues.apache.org/jira/rest/api/2/version/12350076", "id": "12350076", "description": "Fix release against 3.6 branch", "name": "3.6.4", "archived": false, "released": true, "releaseDate": "2022-12-22"}, {"self": "https://issues.apache.org/jira/rest/api/2/version/12354432", "id": "12354432", "description": "", "name": "3.9.3", "archived": false, "released": true, "releaseDate": "2024-10-24"}], "customfield_12311120": null, "customfield_12313826": null, "issuelinks": [{"id": "12692432", "self": "https://issues.apache.org/jira/rest/api/2/issueLink/12692432", "type": {"id": "12310361", "name": "Blocked", "inward": "Blocked", "outward": "Blocked", "self": "https://issues.apache.org/jira/rest/api/2/issueLinkType/12310361"}, "inwardIssue": {"id": "13598717", "key": "CURATOR-722", "self": "https://issues.apache.org/jira/rest/api/2/issue/13598717", "fields": {"summary": "Zookeeper connection leak after session expiration", "status": {"self": "https://issues.apache.org/jira/rest/api/2/status/1", "description": "The issue is open and ready for the assignee to start work on it.", "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/open.png", "name": "Open", "id": "1", "statusCategory": {"self": "https://issues.apache.org/jira/rest/api/2/statuscategory/2", "id": 2, "key": "new", "colorName": "blue-gray", "name": "To Do"}}, "priority": {"self": "https://issues.apache.org/jira/rest/api/2/priority/3", "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/major.svg", "name": "Major", "id": "3"}, "issuetype": {"self": "https://issues.apache.org/jira/rest/api/2/issuetype/1", "id": "1", "description": "A problem which impairs or prevents the functions of the product.", "iconUrl": "https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype", "name": "Bug", "subtask": false, "avatarId": 21133}}}}], "customfield_12312339": null, "customfield_12313825": null, "assignee": null, "customfield_12312337": null, "customfield_12313823": null, "customfield_12312338": null, "customfield_12311920": null, "customfield_12313822": null, "customfield_12312335": null, "customfield_12313821": null, "customfield_12312336": null, "customfield_12313820": null, "status": {"self": "https://issues.apache.org/jira/rest/api/2/status/1", "description": "The issue is open and ready for the assignee to start work on it.", "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/open.png", "name": "Open", "id": "1", "statusCategory": {"self": "https://issues.apache.org/jira/rest/api/2/statuscategory/2", "id": 2, "key": "new", "colorName": "blue-gray", "name": "To Do"}}, "components": [], "archiveddate": null, "customfield_12312026": null, "customfield_12312023": null, "customfield_12312024": null, "aggregatetimeestimate": null, "customfield_12312022": null, "customfield_12310921": null, "customfield_12310920": "9223372036854775807", "customfield_12312823": null, "creator": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=xinchen147", "name": "xinchen147", "key": "JIRAUSER298666", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=JIRAUSER298666&avatarId=52277", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=JIRAUSER298666&avatarId=52277", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=JIRAUSER298666&avatarId=52277", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=JIRAUSER298666&avatarId=52277"}, "displayName": "Xin Chen", "active": true, "timeZone": "Asia/Shanghai"}, "subtasks": [], "reporter": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=xinchen147", "name": "xinchen147", "key": "JIRAUSER298666", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=JIRAUSER298666&avatarId=52277", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=JIRAUSER298666&avatarId=52277", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=JIRAUSER298666&avatarId=52277", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=JIRAUSER298666&avatarId=52277"}, "displayName": "Xin Chen", "active": true, "timeZone": "Asia/Shanghai"}, "aggregateprogress": {"progress": 0, "total": 0}, "customfield_12313520": null, "customfield_12310250": null, "progress": {"progress": 0, "total": 0}, "customfield_12313924": null, "votes": {"self": "https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-4885/votes", "votes": 0, "hasVoted": false}, "worklog": {"startAt": 0, "maxResults": 20, "total": 0, "worklogs": []}, "archivedby": null, "customfield_12313920": null, "issuetype": {"self": "https://issues.apache.org/jira/rest/api/2/issuetype/4", "id": "4", "description": "An improvement or enhancement to an existing feature or task.", "iconUrl": "https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21140&avatarType=issuetype", "name": "Improvement", "subtask": false, "avatarId": 21140}, "timespent": null, "customfield_12314020": "{summaryBean=com.atlassian.jira.plugin.devstatus.rest.SummaryBean@619cc5a8[summary={pullrequest=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@24720292[overall=PullRequestOverallBean{stateCount=0, state='OPEN', details=PullRequestOverallDetails{openCount=0, mergedCount=0, declinedCount=0}},byInstanceType={}], build=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@577a34c[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BuildOverallBean@31a557e2[failedBuildCount=0,successfulBuildCount=0,unknownBuildCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], review=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@7a384968[overall=com.atlassian.jira.plugin.devstatus.summary.beans.ReviewsOverallBean@74cee1c9[stateCount=0,state=<null>,dueDate=<null>,overDue=false,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], deployment-environment=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@4c1b41df[overall=com.atlassian.jira.plugin.devstatus.summary.beans.DeploymentOverallBean@579a05f9[topEnvironments=[],showProjects=false,successfulCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], repository=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@6fd1756b[overall=com.atlassian.jira.plugin.devstatus.summary.beans.CommitOverallBean@6c1211f1[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], branch=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@7a11b015[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BranchOverallBean@7d23c763[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}]},errors=[],configErrors=[]], devSummaryJson={\"cachedValue\":{\"errors\":[],\"configErrors\":[],\"summary\":{\"pullrequest\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":\"OPEN\",\"details\":{\"openCount\":0,\"mergedCount\":0,\"declinedCount\":0,\"total\":0},\"open\":true},\"byInstanceType\":{}},\"build\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"failedBuildCount\":0,\"successfulBuildCount\":0,\"unknownBuildCount\":0},\"byInstanceType\":{}},\"review\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":null,\"dueDate\":null,\"overDue\":false,\"completed\":false},\"byInstanceType\":{}},\"deployment-environment\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"topEnvironments\":[],\"showProjects\":false,\"successfulCount\":0},\"byInstanceType\":{}},\"repository\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}},\"branch\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}}}},\"isStale\":false}}", "customfield_12314141": null, "customfield_12314140": null, "project": {"self": "https://issues.apache.org/jira/rest/api/2/project/12310801", "id": "12310801", "key": "ZOOKEEPER", "name": "ZooKeeper", "projectTypeKey": "software", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/projectavatar?pid=12310801&avatarId=10011", "24x24": "https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310801&avatarId=10011", "16x16": "https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310801&avatarId=10011", "32x32": "https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310801&avatarId=10011"}, "projectCategory": {"self": "https://issues.apache.org/jira/rest/api/2/projectCategory/10484", "id": "10484", "description": "Apache ZooKeeper related", "name": "ZooKeeper"}}, "aggregatetimespent": null, "customfield_12312520": null, "customfield_12312521": "Thu Nov 14 07:59:53 UTC 2024", "customfield_12314422": null, "customfield_12314421": null, "customfield_12314146": null, "customfield_12314420": null, "customfield_12314145": null, "customfield_12314144": null, "customfield_12314143": null, "resolutiondate": null, "workratio": -1, "customfield_12312923": null, "customfield_12312920": null, "customfield_12312921": null, "watches": {"self": "https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-4885/watchers", "watchCount": 1, "isWatching": false}, "created": "2024-11-13T12:16:28.000+0000", "customfield_12310192": null, "customfield_12310191": null, "customfield_12310230": null, "updated": "2024-11-14T09:10:01.000+0000", "timeoriginalestimate": null, "description": "About  ZOOKEEPER-2139 & ZOOKEEPER-2323, it just avoids ZooKeeper clients into infinite AuthFailedException. Noauth Exception still exists! \r\n\r\nLoginException was thrown through each login, but at this point, a zkclient without Kerberos SASL authentication was created. Non SASL Znodes can be operated on in the future. However, when Kerberos recovers from network disconnections and other anomalies, the previously created zkclient without SASL authentication is still being used without rebuilding the login or recreating a saslclient. If it is used to operate on ACL Znodes at this time, an error will always be reported: \r\n{code:java}\r\nKeeperErrorCode = NoAuth for /zookeeper\r\nor\r\nKeeperErrorCode = AuthFailed for /zookeeper\r\nor\r\nKeeperErrorCode = InvalidACL for /zookeeper{code}\r\nIsn't this a question that should be considered?  And I also met this issue in ZK-3.6.4，It seems that this issue has not been considered in the updated version. ", "customfield_10010": null, "timetracking": {}, "customfield_12314523": null, "customfield_12314127": null, "customfield_12314522": null, "customfield_12314126": null, "customfield_12314521": null, "customfield_12314125": null, "customfield_12314520": null, "customfield_12314124": null, "customfield_12312340": null, "attachment": [], "customfield_12314123": null, "customfield_12312341": null, "customfield_12312220": null, "customfield_12314122": null, "customfield_12314121": null, "customfield_12314120": null, "customfield_12314129": null, "customfield_12314524": null, "customfield_12314128": null, "summary": "Can Non-SASL-Clients automatically recover with the recovery of kerberos communication？", "customfield_12314130": null, "customfield_12310291": null, "customfield_12310290": null, "customfield_12311024": null, "customfield_12314138": null, "customfield_12314137": null, "environment": null, "customfield_12314136": null, "customfield_12314135": null, "customfield_12311020": null, "customfield_12314134": null, "duedate": null, "customfield_12314132": null, "customfield_12314131": null, "comment": {"comments": [{"self": "https://issues.apache.org/jira/rest/api/2/issue/13598616/comment/17897903", "id": "17897903", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=xinchen147", "name": "xinchen147", "key": "JIRAUSER298666", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=JIRAUSER298666&avatarId=52277", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=JIRAUSER298666&avatarId=52277", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=JIRAUSER298666&avatarId=52277", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=JIRAUSER298666&avatarId=52277"}, "displayName": "Xin Chen", "active": true, "timeZone": "Asia/Shanghai"}, "body": "LoginException was thrown through each login, about code：\r\n{code:java}\r\nif (ZooKeeperSaslClient.isEnabled()) {\r\n    try {\r\n        if (zooKeeperSaslClient != null) {\r\n            zooKeeperSaslClient.shutdown();\r\n        }\r\n        zooKeeperSaslClient = new ZooKeeperSaslClient(SaslServerPrincipal.getServerPrincipal(addr));\r\n    } catch (LoginException e) {\r\n        // An authentication error occurred when the SASL client tried to initialize:\r\n        // for Kerberos this means that the client failed to authenticate with the KDC.\r\n        // This is different from an authentication error that occurs during communication\r\n        // with the Zookeeper server, which is handled below.\r\n        LOG.warn(\"SASL configuration failed: \" + e + \" Will continue connection to Zookeeper server without \"\r\n          + \"SASL authentication, if Zookeeper server allows it.\");\r\n        eventThread.queueEvent(new WatchedEvent(\r\n          Watcher.Event.EventType.None,\r\n          Watcher.Event.KeeperState.AuthFailed, null));\r\n        saslLoginFailed = true;\r\n    }\r\n} {code}\r\nClients enter AuthFailed state from the following code：\r\n{code:java}\r\nif (zooKeeperSaslClient != null) {\r\n    boolean sendAuthEvent = false;\r\n    if (zooKeeperSaslClient.getSaslState() == ZooKeeperSaslClient.SaslState.INITIAL) {\r\n        try {\r\n            zooKeeperSaslClient.initialize(ClientCnxn.this);\r\n        } catch (SaslException e) {\r\n           LOG.error(\"SASL authentication with Zookeeper Quorum member failed: \" + e);\r\n            state = States.AUTH_FAILED;\r\n            sendAuthEvent = true;\r\n        }\r\n    }\r\n    KeeperState authState = zooKeeperSaslClient.getKeeperState();\r\n    if (authState != null) {\r\n        if (authState == KeeperState.AuthFailed) {\r\n            // An authentication error occurred during authentication with the Zookeeper Server.\r\n            state = States.AUTH_FAILED;\r\n            sendAuthEvent = true;\r\n        } else {\r\n            if (authState == KeeperState.SaslAuthenticated) {\r\n                sendAuthEvent = true;\r\n            }\r\n        }\r\n    }\r\n\r\n    if (sendAuthEvent == true) {\r\n        eventThread.queueEvent(new WatchedEvent(\r\n              Watcher.Event.EventType.None,\r\n              authState,null));\r\n        if (state == States.AUTH_FAILED) {\r\n            eventThread.queueEventOfDeath();\r\n        }\r\n    }\r\n}{code}\r\n     I want to know if the community thinks that this kind of issue needs to be considered by client-users, and the server only needs to ensure that in the event of a failure to authenticate with kerberos, a client that can operate on no sasl znode can be created normally.  Is that correct？This problem is equivalent to another scenario:\r\n\r\n     *When creating a zkClient, the Kerberos is no longer online, and the created client can only operate on the Znode of no SASL. After the subsequent recovery of the Kerberos, it still remains the same, and cannot operate on the Znode of SASL, nor does it trigger the reconstruction of the client.*\r\n\r\n    Isn't this a question that should be considered?  And I also met this issue in ZK-3.6.4，It seems that this issue has not been considered in the updated version. \r\n\r\n \r\n\r\n ", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=xinchen147", "name": "xinchen147", "key": "JIRAUSER298666", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=JIRAUSER298666&avatarId=52277", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=JIRAUSER298666&avatarId=52277", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=JIRAUSER298666&avatarId=52277", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=JIRAUSER298666&avatarId=52277"}, "displayName": "Xin Chen", "active": true, "timeZone": "Asia/Shanghai"}, "created": "2024-11-13T12:24:31.686+0000", "updated": "2024-11-13T12:24:31.686+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13598616/comment/17898105", "id": "17898105", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=xinchen147", "name": "xinchen147", "key": "JIRAUSER298666", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=JIRAUSER298666&avatarId=52277", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=JIRAUSER298666&avatarId=52277", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=JIRAUSER298666&avatarId=52277", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=JIRAUSER298666&avatarId=52277"}, "displayName": "Xin Chen", "active": true, "timeZone": "Asia/Shanghai"}, "body": "1.        So {*}there is a real scenario in the production environment{*}:\r\n\r\nWhen a *Curator Client* used to create a EphemeralNode，like code in HiveServer2：\r\n\r\n \r\n{code:java}\r\nzooKeeperClient =\r\n    CuratorFrameworkFactory.builder().connectString(zooKeeperEnsemble).sessionTimeoutMs(sessionTimeout).aclProvider(zooKeeperAclProvider).retryPolicy(new ExponentialBackoffRetry(baseSleepTime, maxRetries)).build();\r\nzooKeeperClient.start();\r\n\r\nPersistentEphemeralNode znode = new PersistentEphemeralNode(zooKeeperClient, PersistentEphemeralNode.Mode.EPHEMERAL_SEQUENTIAL, pathPrefix, znodeDataUTF8);\r\nznode.start();{code}\r\nThere is a callback function in PersistentEphemeralNode：\r\n{code:java}\r\nbackgroundCallback = new BackgroundCallback()\r\n{\r\n    @Override\r\n    public void processResult(CuratorFramework client, CuratorEvent event) throws Exception\r\n    {\r\n        String path = null;\r\n        if ( event.getResultCode() == KeeperException.Code.NODEEXISTS.intValue() )\r\n        {\r\n            path = event.getPath();\r\n        }\r\n        else if ( event.getResultCode() == KeeperException.Code.OK.intValue() )\r\n        {\r\n            path = event.getName();\r\n        }\r\n        if ( path != null )\r\n        {\r\n            nodePath.set(path);\r\n            watchNode();\r\n\r\n            CountDownLatch localLatch = initialCreateLatch.getAndSet(null);\r\n            if ( localLatch != null )\r\n            {\r\n                localLatch.countDown();\r\n            }\r\n        }\r\n        else\r\n        {\r\n            createNode();\r\n        }\r\n    }\r\n};\r\n\r\n// createNode() registers this backgroundCallback again：\r\ncreateMethod.withMode(mode.getCreateMode(existingPath != null)).inBackground(backgroundCallback).forPath(createPath, data.get());{code}\r\nWhen HiveServer2 is disconnected from the Zookeeper and then network reconnected, Curator automatically rebuilds the client. Coincidentally, the login to kerberos fails at this time, and a non SASL authenticated client is created. The Curator uses this client to rebuild PersistentEphemeralNode under “/hive”.  There will be an error message in creating: \r\n{code:java}\r\nKeeperErrorCode = InvalidACL for /hive/hiveserver2-0... {code}\r\nand only the judgment for NODEEXISTS and OK will be made in {*}backgroundCallback#processResult{*}. In this case, it will received InvaldACL as 'event.getResultCode()' and repeatedly call creatNode() and register backgroundcallback. After the error callback, it will call creatNode() and register backgroundcallback again. So it enters a dead loop, due to the callback processing within the Curator, the zk client of hiveserver2 is completely unaware, while the server will frantically brush InvalidACL logs due to the fast call of creatNode(). The CPU pressure on the zk server will also increase dramatically. \r\n\r\n*From here, it can be seen that neither the Curator nor Zookeeper wants to automatically rebuild the client for scenarios where Kerberos ACL authentication fails.*\r\n\r\nIf we don't modify the Curator code, a solution is proposed for this scenario, which involves monitoring the event on the Hiveserver2 side. When the zk client sends an Authfailed event, the current Curator client is closed and rebuilt, and the ephemeral node is recreated until it is successfully created.\r\n\r\nHowever, there is another issue with this modification. When the authfailed event occurs, rebuilding the Curator client. If the zk server is disconnected for a period of time and the reconnection may generates an expire event, the expire event will occur after the authfailed event and trigger automatic reconstruction within the Curator. At this point, there will be an additional connection between hiveserver2 and the zk server, as well as an additional zk client, which is considered a {*}client leak{*}.\r\n{code:java}\r\n// Expired event trigger Curator to Reset()\r\norg.apache.curator.ConnectionState#checkState case Expired:\r\n{\r\n    isConnected = false;\r\n    checkNewConnectionString = false;\r\n    handleExpiredSession();\r\n    break;\r\n}\r\n\r\norg.apache.curator.ConnectionState#handleExpiredSession\r\nprivate void handleExpiredSession()\r\n{\r\n    log.warn(\"Session expired event received\");\r\n    tracer.get().addCount(\"session-expired\", 1);\r\n\r\n    try\r\n    {\r\n        reset();\r\n    }\r\n    catch ( Exception e )\r\n    {\r\n        queueBackgroundException(e);\r\n    }\r\n}\r\n\r\n//========== reset() will rebuild Zookeeper Client =================\r\norg.apache.curator.ConnectionState#reset\r\nprivate synchronized void reset() throws Exception\r\n{\r\n    log.debug(\"reset\");\r\n\r\n    instanceIndex.incrementAndGet();\r\n\r\n    isConnected.set(false);\r\n    connectionStartMs = System.currentTimeMillis();\r\n    zooKeeper.closeAndReset();\r\n    zooKeeper.getZooKeeper();   // initiate connection\r\n}{code}\r\n \r\n\r\n{*}In order to solve the problem of client leak in this scheme{*}, it is proposed to synchronously modify the Zookeeper client code(ClientCnxn.java). The purpose of the modification is to avoid generating expired events after authfailed events, so that the Curator side will not trigger handleExpirdSession() and reset(). This is customized for some clients that need to set SASL permission znode. The client process needs to carry an environment variable (newly added)：\r\n\r\n \r\n{code:java}\r\nzookeeper.sasl.kerberos.client=true{code}\r\n \r\n\r\nWhen creating such a client, after the authfailed event generated during login, Zookeeper. state can be set to AuthFailed, so exit the retry connection with the zk server, and close the event thread in the same time. In this way, because the zk client has disconnected from the server internally, the expired event will not be triggered again. We can actively initiate the reconstruction of the client and znode in HiveServer2, the leakage problem should not occur again. The modification is as follows:\r\n{code:java}\r\n// org.apache.zookeeper.ClientCnxn.SendThread#startConnect\r\nprivate void startConnect(InetSocketAddress addr) throws IOException {\r\n    // initializing it for new connection\r\n    saslLoginFailed = false;\r\n    state = States.CONNECTING;\r\n\r\n    setName(getName().replaceAll(\"\\\\(.*\\\\)\",\r\n            \"(\" + addr.getHostName() + \":\" + addr.getPort() + \")\"));\r\n    if (ZooKeeperSaslClient.isEnabled()) {\r\n        try {\r\n            if (zooKeeperSaslClient != null) {\r\n                zooKeeperSaslClient.shutdown();\r\n            }\r\n            zooKeeperSaslClient = new ZooKeeperSaslClient(SaslServerPrincipal.getServerPrincipal(addr));\r\n        } catch (LoginException e) {\r\n            // An authentication error occurred when the SASL client tried to initialize:\r\n            // for Kerberos this means that the client failed to authenticate with the KDC.\r\n            // This is different from an authentication error that occurs during communication\r\n            // with the Zookeeper server, which is handled below.\r\n            eventThread.queueEvent(new WatchedEvent(\r\n              Watcher.Event.EventType.None,\r\n              Watcher.Event.KeeperState.AuthFailed, null));\r\n            saslLoginFailed = true;\r\n\r\n// =====================modification==========================\r\n            if (ZooKeeperSaslClient.isKerberosBind()) {\r\n                state = States.AUTH_FAILED;\r\n\r\n                LOG.warn(\"Kerberos is bind but LoginException occurs, Zookeeper client will go to AuthFailed state \"\r\n                        + \"and will not continue connection to Zookeeper server.\");\r\n                throw new SaslException(e.getMessage());\r\n            } else {\r\n                LOG.warn(\"SASL configuration failed: \" + e + \" Will continue connection to Zookeeper server without \"\r\n                        + \"SASL authentication, if Zookeeper server allows it.\");\r\n            }\r\n        }\r\n    }\r\n    logStartConnect(addr);\r\n\r\n    clientCnxnSocket.connect(addr);\r\n}\r\n\r\n\r\n// org.apache.zookeeper.ClientCnxn.SendThread#run\r\nif (state.isConnected()) {\r\n    // determine whether we need to send an AuthFailed event.\r\n    if (zooKeeperSaslClient != null) {\r\n        boolean sendAuthEvent = false;\r\n        if (zooKeeperSaslClient.getSaslState() == ZooKeeperSaslClient.SaslState.INITIAL) {\r\n            try {\r\n                zooKeeperSaslClient.initialize(ClientCnxn.this);\r\n            } catch (SaslException e) {\r\n               LOG.error(\"SASL authentication with Zookeeper Quorum member failed: \" + e);\r\n                state = States.AUTH_FAILED;\r\n                sendAuthEvent = true;\r\n            }\r\n        }\r\n        KeeperState authState = zooKeeperSaslClient.getKeeperState();\r\n        if (authState != null) {\r\n            if (authState == KeeperState.AuthFailed) {\r\n                // An authentication error occurred during authentication with the Zookeeper Server.\r\n                state = States.AUTH_FAILED;\r\n                sendAuthEvent = true;\r\n            } else {\r\n                if (authState == KeeperState.SaslAuthenticated) {\r\n                    sendAuthEvent = true;\r\n                }\r\n            }\r\n        }\r\n\r\n        if (sendAuthEvent == true) {\r\n            eventThread.queueEvent(new WatchedEvent(\r\n                  Watcher.Event.EventType.None,\r\n                  authState,null));\r\n            if (state == States.AUTH_FAILED) {\r\n                eventThread.queueEventOfDeath();\r\n\r\n// =====================modification==========================\r\n                if (ZooKeeperSaslClient.isKerberosBind()) {\r\n                    LOG.warn(\"Kerberos is bind but auth failed, Zookeeper client will go to AuthFailed state \"\r\n                            + \"and will not continue connection to Zookeeper server.\");\r\n                    throw new SaslException(\"zooKeeperSaslClient.State is AuthFailed.\");\r\n                }\r\n            }\r\n        }\r\n    }\r\n    to = readTimeout - clientCnxnSocket.getIdleRecv();\r\n}\r\n\r\n\r\n\r\n// org.apache.zookeeper.client.ZooKeeperSaslClient\r\n// =====================modification==========================\r\npublic static final String ENABLE_CLIENT_KERBEROS_BIND_KEY = \"zookeeper.sasl.kerberos.client\";\r\npublic static final String ENABLE_CLIENT_KERBEROS_BIND_DEFAULT = \"false\";\r\n\r\npublic static boolean isKerberosBind() {\r\n    return Boolean.valueOf(System.getProperty(ENABLE_CLIENT_KERBEROS_BIND_KEY, ENABLE_CLIENT_KERBEROS_BIND_DEFAULT));\r\n}{code}", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=xinchen147", "name": "xinchen147", "key": "JIRAUSER298666", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=JIRAUSER298666&avatarId=52277", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=JIRAUSER298666&avatarId=52277", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=JIRAUSER298666&avatarId=52277", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=JIRAUSER298666&avatarId=52277"}, "displayName": "Xin Chen", "active": true, "timeZone": "Asia/Shanghai"}, "created": "2024-11-14T02:11:00.466+0000", "updated": "2024-11-14T07:59:08.890+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13598616/comment/17898169", "id": "17898169", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=xinchen147", "name": "xinchen147", "key": "JIRAUSER298666", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=JIRAUSER298666&avatarId=52277", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=JIRAUSER298666&avatarId=52277", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=JIRAUSER298666&avatarId=52277", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=JIRAUSER298666&avatarId=52277"}, "displayName": "Xin Chen", "active": true, "timeZone": "Asia/Shanghai"}, "body": "2.        Also, {*}there is another real scenario in the production environment{*}:\r\n\r\nAnother zk client of Hive is responsible for establishing persistent nodes. Due to abnormal Kereros interaction during creation, a non SASL authenticated Zookeeper client was obtained, It may report an error when creating SASL Znode：\r\n{code:java}\r\norg.apache.zookeeper.KeeperException.NoAuthException\r\norg.apache.zookeeper.KeeperException.InvalidACLException\r\norg.apache.zookeeper.KeeperException.AuthFailedException{code}\r\nSimilarly, after the recovery of kerberos, using this client to continuously create znodes also results in continuous error messages. So the solution provided is to *consider actively rebuilding a client in the user code every time these three exceptions are encountered.*\r\n{code:java}\r\n// user code demo \r\n\r\ntry {\r\n                createZNode(zookeeperClient, c);\r\n            } catch (Exception e) {\r\n                e.printStackTrace();\r\n                c++;\r\n                if (e instanceof org.apache.zookeeper.KeeperException.AuthFailedException || e instanceof org.apache.zookeeper.KeeperException.NoAuthException || e instanceof org.apache.zookeeper.KeeperException.InvalidACLException) {\r\n                    System.out.println(\"Warn: zkclient need construct, state: \" + zooKeeper.getState() + \" zkException: \" + e.getClass());                                                      \r\n                    zooKeeperClient.close();\r\n                    Thread.sleep(5000);\r\n// Proactively rebuild client objects       \r\n                zooKeeper = new ZooKeeper(\"localhost:2181\", 120000, new ZkClientKerberos()); \r\n                } else {\r\n                    throw e; // Other exceptions are thrown directly \r\n}{code}\r\n \r\n\r\n \r\n\r\n ", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=xinchen147", "name": "xinchen147", "key": "JIRAUSER298666", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=JIRAUSER298666&avatarId=52277", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=JIRAUSER298666&avatarId=52277", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=JIRAUSER298666&avatarId=52277", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=JIRAUSER298666&avatarId=52277"}, "displayName": "Xin Chen", "active": true, "timeZone": "Asia/Shanghai"}, "created": "2024-11-14T07:59:53.156+0000", "updated": "2024-11-14T09:10:01.152+0000"}], "maxResults": 3, "total": 3, "startAt": 0}, "customfield_12311820": "0|z1sj5k:", "customfield_12314139": null}}