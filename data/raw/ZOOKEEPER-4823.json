{"expand": "operations,versionedRepresentations,editmeta,changelog,renderedFields", "id": "13574540", "self": "https://issues.apache.org/jira/rest/api/2/issue/13574540", "key": "ZOOKEEPER-4823", "fields": {"fixVersions": [], "resolution": null, "customfield_12312322": null, "customfield_12312323": null, "customfield_12310420": "9223372036854775807", "customfield_12312320": null, "customfield_12312321": null, "customfield_12312328": null, "customfield_12312329": null, "customfield_12312326": null, "customfield_12310300": null, "customfield_12312327": null, "customfield_12312324": null, "customfield_12312720": null, "customfield_12312325": null, "lastViewed": null, "priority": {"self": "https://issues.apache.org/jira/rest/api/2/priority/3", "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/major.svg", "name": "Major", "id": "3"}, "labels": [], "customfield_12312333": null, "customfield_12312334": null, "customfield_12313422": "false", "customfield_12310310": "0.0", "customfield_12312331": null, "customfield_12312332": null, "aggregatetimeoriginalestimate": null, "timeestimate": null, "customfield_12312330": null, "versions": [], "customfield_12311120": null, "customfield_12313826": null, "issuelinks": [], "customfield_12312339": null, "customfield_12313825": null, "assignee": null, "customfield_12312337": null, "customfield_12313823": null, "customfield_12312338": null, "customfield_12311920": null, "customfield_12313822": null, "customfield_12312335": null, "customfield_12313821": null, "customfield_12312336": null, "customfield_12313820": null, "status": {"self": "https://issues.apache.org/jira/rest/api/2/status/1", "description": "The issue is open and ready for the assignee to start work on it.", "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/open.png", "name": "Open", "id": "1", "statusCategory": {"self": "https://issues.apache.org/jira/rest/api/2/statuscategory/2", "id": 2, "key": "new", "colorName": "blue-gray", "name": "To Do"}}, "components": [], "archiveddate": null, "customfield_12312026": null, "customfield_12312023": null, "customfield_12312024": null, "aggregatetimeestimate": null, "customfield_12312022": null, "customfield_12310921": null, "customfield_12310920": "9223372036854775807", "customfield_12312823": null, "creator": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=ouyang", "name": "ouyang", "key": "ouyang", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34045", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34045", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34045", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34045"}, "displayName": "Sirius", "active": true, "timeZone": "Asia/Shanghai"}, "subtasks": [], "reporter": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=ouyang", "name": "ouyang", "key": "ouyang", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34045", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34045", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34045", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34045"}, "displayName": "Sirius", "active": true, "timeZone": "Asia/Shanghai"}, "aggregateprogress": {"progress": 0, "total": 0}, "customfield_12313520": null, "customfield_12310250": null, "progress": {"progress": 0, "total": 0}, "customfield_12313924": null, "votes": {"self": "https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-4823/votes", "votes": 0, "hasVoted": false}, "worklog": {"startAt": 0, "maxResults": 20, "total": 0, "worklogs": []}, "archivedby": null, "customfield_12313920": null, "issuetype": {"self": "https://issues.apache.org/jira/rest/api/2/issuetype/4", "id": "4", "description": "An improvement or enhancement to an existing feature or task.", "iconUrl": "https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21140&avatarType=issuetype", "name": "Improvement", "subtask": false, "avatarId": 21140}, "timespent": null, "customfield_12314020": "{summaryBean=com.atlassian.jira.plugin.devstatus.rest.SummaryBean@44587b26[summary={pullrequest=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@33700341[overall=PullRequestOverallBean{stateCount=0, state='OPEN', details=PullRequestOverallDetails{openCount=0, mergedCount=0, declinedCount=0}},byInstanceType={}], build=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@6d4764d8[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BuildOverallBean@5e9e183a[failedBuildCount=0,successfulBuildCount=0,unknownBuildCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], review=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@51ec7233[overall=com.atlassian.jira.plugin.devstatus.summary.beans.ReviewsOverallBean@36d56db8[stateCount=0,state=<null>,dueDate=<null>,overDue=false,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], deployment-environment=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@6062ae1e[overall=com.atlassian.jira.plugin.devstatus.summary.beans.DeploymentOverallBean@4e9325e0[topEnvironments=[],showProjects=false,successfulCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], repository=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@7cdcbbeb[overall=com.atlassian.jira.plugin.devstatus.summary.beans.CommitOverallBean@61f9a165[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], branch=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@141ef11a[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BranchOverallBean@43756a5c[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}]},errors=[],configErrors=[]], devSummaryJson={\"cachedValue\":{\"errors\":[],\"configErrors\":[],\"summary\":{\"pullrequest\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":\"OPEN\",\"details\":{\"openCount\":0,\"mergedCount\":0,\"declinedCount\":0,\"total\":0},\"open\":true},\"byInstanceType\":{}},\"build\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"failedBuildCount\":0,\"successfulBuildCount\":0,\"unknownBuildCount\":0},\"byInstanceType\":{}},\"review\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":null,\"dueDate\":null,\"overDue\":false,\"completed\":false},\"byInstanceType\":{}},\"deployment-environment\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"topEnvironments\":[],\"showProjects\":false,\"successfulCount\":0},\"byInstanceType\":{}},\"repository\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}},\"branch\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}}}},\"isStale\":false}}", "customfield_12314141": null, "customfield_12314140": null, "project": {"self": "https://issues.apache.org/jira/rest/api/2/project/12310801", "id": "12310801", "key": "ZOOKEEPER", "name": "ZooKeeper", "projectTypeKey": "software", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/projectavatar?pid=12310801&avatarId=10011", "24x24": "https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310801&avatarId=10011", "16x16": "https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310801&avatarId=10011", "32x32": "https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310801&avatarId=10011"}, "projectCategory": {"self": "https://issues.apache.org/jira/rest/api/2/projectCategory/10484", "id": "10484", "description": "Apache ZooKeeper related", "name": "ZooKeeper"}}, "aggregatetimespent": null, "customfield_12312520": null, "customfield_12312521": "2024-04-04 02:52:29.0", "customfield_12314422": null, "customfield_12314421": null, "customfield_12314146": null, "customfield_12314420": null, "customfield_12314145": null, "customfield_12314144": null, "customfield_12314143": null, "resolutiondate": null, "workratio": -1, "customfield_12312923": null, "customfield_12312920": null, "customfield_12312921": null, "watches": {"self": "https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-4823/watchers", "watchCount": 3, "isWatching": false}, "created": "2024-04-04T02:52:29.000+0000", "customfield_12310192": null, "customfield_12310191": null, "customfield_12310230": null, "updated": "2024-04-04T03:57:20.000+0000", "timeoriginalestimate": null, "description": "As ZooKeeper evolves these years, its code implementation deviates the design of [Zab 1.0 (wiki)|https://cwiki.apache.org/confluence/display/ZOOKEEPER/Zab1.0] in several aspects.\r\n\r\nOne critical deviation lies in the _atomic actions_ upon a follower receives NEWLEADER (see 2.{*}f{*} in Phase 2). The protocol requires that the follower \" _*atomically*_ applies the new state and sets {*}f{*}.currentEpoch = {_}e{_}\". However, the atomicity is not guaranteed with the current code implementation. Asynchronous logging and committing by multi-threads with node crash can interrupt this process and lead to possible data loss (see {-}ZOOKEEPER-3911{-}, ZOOKEEPER-4643, ZOOKEEPER-4646, {-}ZOOKEEPER-4785{-}).\r\n\r\nOn the other hand, to implement atomicity is expensive and affecting performance. It is reasonable to adopt an implementation without requiring atomic updates in this step. It is highly recommended to update the design of Zab without requiring atomicity in Step 2.{*}f{*} and make it more precise and practical to guide the code implementation.\r\nh3. Update Step 2.{*}f{*} by removing the requirement of atomicity\r\n\r\nHere provides a possible design of Step 2.{*}f{*} in Phase 2 with the removal of atomicity requirement.\r\nh4. Phase 2: Sync with followers\r\n # *l* ...\r\n # *f* The follower syncs with the leader, but doesn't modify its state until it receives the NEWLEADER({_}e{_}) packet. Once it receives NEWLEADER({_}e{_}), -_it atomically applies the new state, and then sets f.currentEpoch = e. It then sends ACK(e << 32)._- *it executes the following actions sequentially:*\r\n\r\n * *2.1. applies the new state;*\r\n * *2.2. sets f.currentEpoch = e;*\r\n * *2.3. sends ACK(e << 32).*\r\n\r\n      3. *l* ...\r\n\r\n \r\n\r\nNote:\r\n * To ensure the correctness without requiring atomicity, the follower must persist and sync the data before it updates its currentEpoch and replies NEWLEADER ack (See the analysis in ZOOKEEPER-4643 & ZOOKEEPER-4785)\r\n\r\n * This new design conforms to the code implementation in current latest code version (ZooKeeper v3.9.2). This code version has fixed the known data loss issues that stay unresolved for a long time due to non-atomic executions in Step 2.{*}f{*} , including {-}ZOOKEEPER-3911{-}, ZOOKEEPER-4643, ZOOKEEPER-4646 & {-}ZOOKEEPER-4785{-}. (see the code fixes in [PR-2111|https://github.com/apache/zookeeper/pull/2111] & [PR-2152|https://github.com/apache/zookeeper/pull/2152]).\r\n\r\n * The correctness of this new design has been verified with the TLA+ specifications of Zab at different abstraction levels, including the [high-level protocol specification|https://github.com/AlphaCanisMajoris/zookeeper-tla-spec/blob/main/Zab_new.tla] (developed based on the original [protocol spec|https://github.com/apache/zookeeper/blob/master/zookeeper-specifications/protocol-spec/Zab.tla]) & the [multi-threading-level specification|https://github.com/AlphaCanisMajoris/zookeeper-tla-spec/blob/main/zk_pr_2152.tla] (developed based on the original [system spec.|https://github.com/apache/zookeeper/blob/master/zookeeper-specifications/system-spec/zk-3.7/ZkV3_7_0.tla] This spec is implemented by [PR-2152|https://github.com/apache/zookeeper/pull/2152], an effort to fix more known issues in Phase 2). In the verification, the TLC model checker checks whether the new design satisfies the properties given by the Zab paper. No violation is found during the checking with various configurations.\r\n\r\n \r\n\r\nWe sincerely hope that the above update of the protocol design can be presented at the wiki page, and make it guide the future code implementation better!\r\n\r\n \r\n\r\nAbout us:\r\n\r\nWe are a research team using TLA+ to verify the correctness of distributed systems.\r\n\r\nLooking forward to receiving feedback from the ZooKeeper community!", "customfield_10010": null, "timetracking": {}, "customfield_12314523": null, "customfield_12314127": null, "customfield_12314522": null, "customfield_12314126": null, "customfield_12314521": null, "customfield_12314125": null, "customfield_12314520": null, "customfield_12314124": null, "customfield_12312340": null, "attachment": [], "customfield_12314123": null, "customfield_12312341": null, "customfield_12312220": null, "customfield_12314122": null, "customfield_12314121": null, "customfield_12314120": null, "customfield_12314129": null, "customfield_12314524": null, "customfield_12314128": null, "summary": "Proposal: Update the wiki / design of Zab 1.0 (Phase 2) to make it more precise and practical for the implementation", "customfield_12314130": null, "customfield_12310291": null, "customfield_12310290": null, "customfield_12311024": null, "customfield_12314138": null, "customfield_12314137": null, "environment": null, "customfield_12314136": null, "customfield_12314135": null, "customfield_12311020": null, "customfield_12314134": null, "duedate": null, "customfield_12314132": null, "customfield_12314131": null, "comment": {"comments": [], "maxResults": 0, "total": 0, "startAt": 0}, "customfield_12311820": "0|z1ofag:", "customfield_12314139": null}}