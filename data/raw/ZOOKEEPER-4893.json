{"expand": "operations,versionedRepresentations,editmeta,changelog,renderedFields", "id": "13607169", "self": "https://issues.apache.org/jira/rest/api/2/issue/13607169", "key": "ZOOKEEPER-4893", "fields": {"fixVersions": [], "resolution": null, "customfield_12312322": null, "customfield_12312323": null, "customfield_12310420": "9223372036854775807", "customfield_12312320": null, "customfield_12312321": null, "customfield_12312328": null, "customfield_12312329": null, "customfield_12312326": null, "customfield_12310300": null, "customfield_12312327": null, "customfield_12312324": null, "customfield_12312720": null, "customfield_12312325": null, "lastViewed": null, "priority": {"self": "https://issues.apache.org/jira/rest/api/2/priority/3", "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/major.svg", "name": "Major", "id": "3"}, "labels": [], "customfield_12312333": null, "customfield_12312334": null, "customfield_12313422": "false", "customfield_12310310": "0.0", "customfield_12312331": null, "customfield_12312332": null, "aggregatetimeoriginalestimate": null, "timeestimate": null, "customfield_12312330": null, "versions": [{"self": "https://issues.apache.org/jira/rest/api/2/version/12354432", "id": "12354432", "description": "", "name": "3.9.3", "archived": false, "released": true, "releaseDate": "2024-10-24"}], "customfield_12311120": null, "customfield_12313826": null, "issuelinks": [], "customfield_12312339": null, "customfield_12313825": null, "assignee": null, "customfield_12312337": null, "customfield_12313823": null, "customfield_12312338": null, "customfield_12311920": null, "customfield_12313822": null, "customfield_12312335": null, "customfield_12313821": null, "customfield_12312336": null, "customfield_12313820": null, "status": {"self": "https://issues.apache.org/jira/rest/api/2/status/1", "description": "The issue is open and ready for the assignee to start work on it.", "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/open.png", "name": "Open", "id": "1", "statusCategory": {"self": "https://issues.apache.org/jira/rest/api/2/statuscategory/2", "id": 2, "key": "new", "colorName": "blue-gray", "name": "To Do"}}, "components": [{"self": "https://issues.apache.org/jira/rest/api/2/component/12312381", "id": "12312381", "name": "java client", "description": "The java client interface for ZooKeeper"}], "archiveddate": null, "customfield_12312026": null, "customfield_12312023": null, "customfield_12312024": null, "aggregatetimeestimate": null, "customfield_12312022": null, "customfield_12310921": null, "customfield_12310920": "9223372036854775807", "customfield_12312823": null, "creator": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=patrikivarsson", "name": "patrikivarsson", "key": "JIRAUSER308579", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Patrik Ivarsson", "active": true, "timeZone": "Etc/UTC"}, "subtasks": [], "reporter": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=patrikivarsson", "name": "patrikivarsson", "key": "JIRAUSER308579", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Patrik Ivarsson", "active": true, "timeZone": "Etc/UTC"}, "aggregateprogress": {"progress": 0, "total": 0}, "customfield_12313520": null, "customfield_12310250": null, "progress": {"progress": 0, "total": 0}, "customfield_12313924": null, "votes": {"self": "https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-4893/votes", "votes": 0, "hasVoted": false}, "worklog": {"startAt": 0, "maxResults": 20, "total": 0, "worklogs": []}, "archivedby": null, "customfield_12313920": null, "issuetype": {"self": "https://issues.apache.org/jira/rest/api/2/issuetype/4", "id": "4", "description": "An improvement or enhancement to an existing feature or task.", "iconUrl": "https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21140&avatarType=issuetype", "name": "Improvement", "subtask": false, "avatarId": 21140}, "timespent": null, "customfield_12314020": "{summaryBean=com.atlassian.jira.plugin.devstatus.rest.SummaryBean@2b5dacee[summary={pullrequest=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@3f34af85[overall=PullRequestOverallBean{stateCount=0, state='OPEN', details=PullRequestOverallDetails{openCount=0, mergedCount=0, declinedCount=0}},byInstanceType={}], build=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@6b8e89fe[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BuildOverallBean@715c5b8d[failedBuildCount=0,successfulBuildCount=0,unknownBuildCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], review=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@45d613d1[overall=com.atlassian.jira.plugin.devstatus.summary.beans.ReviewsOverallBean@7bc9c0f3[stateCount=0,state=<null>,dueDate=<null>,overDue=false,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], deployment-environment=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@6497670d[overall=com.atlassian.jira.plugin.devstatus.summary.beans.DeploymentOverallBean@7784d821[topEnvironments=[],showProjects=false,successfulCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], repository=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@2b9159b[overall=com.atlassian.jira.plugin.devstatus.summary.beans.CommitOverallBean@37c29367[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], branch=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@68b2359d[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BranchOverallBean@3926bd7a[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}]},errors=[],configErrors=[]], devSummaryJson={\"cachedValue\":{\"errors\":[],\"configErrors\":[],\"summary\":{\"pullrequest\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":\"OPEN\",\"details\":{\"openCount\":0,\"mergedCount\":0,\"declinedCount\":0,\"total\":0},\"open\":true},\"byInstanceType\":{}},\"build\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"failedBuildCount\":0,\"successfulBuildCount\":0,\"unknownBuildCount\":0},\"byInstanceType\":{}},\"review\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":null,\"dueDate\":null,\"overDue\":false,\"completed\":false},\"byInstanceType\":{}},\"deployment-environment\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"topEnvironments\":[],\"showProjects\":false,\"successfulCount\":0},\"byInstanceType\":{}},\"repository\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}},\"branch\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}}}},\"isStale\":false}}", "customfield_12314141": null, "customfield_12314140": null, "project": {"self": "https://issues.apache.org/jira/rest/api/2/project/12310801", "id": "12310801", "key": "ZOOKEEPER", "name": "ZooKeeper", "projectTypeKey": "software", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/projectavatar?pid=12310801&avatarId=10011", "24x24": "https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310801&avatarId=10011", "16x16": "https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310801&avatarId=10011", "32x32": "https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310801&avatarId=10011"}, "projectCategory": {"self": "https://issues.apache.org/jira/rest/api/2/projectCategory/10484", "id": "10484", "description": "Apache ZooKeeper related", "name": "ZooKeeper"}}, "aggregatetimespent": null, "customfield_12312520": null, "customfield_12312521": "2025-02-03 19:30:43.0", "customfield_12314422": null, "customfield_12314421": null, "customfield_12314146": null, "customfield_12314420": null, "customfield_12314145": null, "customfield_12314144": null, "customfield_12314143": null, "resolutiondate": null, "workratio": -1, "customfield_12312923": null, "customfield_12312920": null, "customfield_12312921": null, "watches": {"self": "https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-4893/watchers", "watchCount": 1, "isWatching": false}, "created": "2025-02-03T19:30:43.000+0000", "customfield_12310192": null, "customfield_12310191": null, "customfield_12310230": null, "updated": "2025-02-03T19:30:43.000+0000", "timeoriginalestimate": null, "description": "*Description*\r\nI'll try to explain our issue as clearly as I can.\r\nSome clients take too long to reconnect to a ZooKeeper cluster after a minor downtime. We have identified two hardcoded sleep intervals in the client connection logic that contribute to this issue, but they cannot be configured. Spending several seconds in this disconnected state, even though the cluster is up and healthy is an issue in our setup.\r\n\r\n*These are the two Thread.sleep() which I am referring to*\r\n1. Random sleep (0-1000ms) before attempting a new connection:\r\n    * [ClientCnxn.java#L1138 (release-3.9.3)|https://github.com/apache/zookeeper/blob/release-3.9.3/zookeeper-server/src/main/java/org/apache/zookeeper/ClientCnxn.java#L1138]\r\n2. Fixed 1000ms sleep before reconnecting to the last known server:\r\n    * [StaticHostProvider#L363 (release-3.9.3)|https://github.com/apache/zookeeper/blob/release-3.9.3/zookeeper-server/src/main/java/org/apache/zookeeper/client/StaticHostProvider.java#L362]\r\n\r\n*Example Scenario*\r\nConsider a three-node ZooKeeper cluster (node01, node02, node03) where node01 is currently the leader.\r\n1. Event: Node01 is temporarily taken down for short maintenance (e.g. for security patching).\r\n2. Result: The remaining nodes (node02 and node03) elect a new leader, completing within ~1000ms.\r\n3. Client (that was connected to node01) behavior (worst-case scenario):\r\n    * Connection to node01 is lost → client enters a suspended state.\r\n    * Waits 500ms, attempts connection to node02 → fails (cluster not ready).\r\n    * Waits 499ms, attempts connection to node03 → fails (cluster still not ready).\r\n    * Waits 1000ms as we are now back to original node01 (sleep #2 in the list above)\r\n    * Waits 1000ms before connecting to node01 -> fails (this node is down for maintenance)\r\n    * Waits 1000ms before retrying node02 → finally succeeds.\r\n4. Total reconnection time: ~4 seconds, despite the cluster being available after just 1 second.\r\n\r\n*Impact*\r\n* Clients remain in a suspended state longer than necessary, leading to degraded service availability.\r\n* The reconnection delay is artificially inflated due to hardcoded sleeps.\r\n\r\n*Suggested improvement*\r\n* Give the user an option to provide our own logic for how long we should sleep before retry. It could be making these sleep intervals configurable, but even better would be to be able to provide our own implementation of the waiting logic.\r\n\r\n*Offer to contribute*\r\nWe would be happy to submit a pull request to address this issue if that would be helpful. Please let us know if a contribution would be welcomed and if you have any guidance on the preferred approach.\r\nWould appreciate any insights from the maintainers. Thanks!\r\n\r\n ", "customfield_10010": null, "timetracking": {}, "customfield_12314523": null, "customfield_12314127": null, "customfield_12314522": null, "customfield_12314126": null, "customfield_12314521": null, "customfield_12314125": null, "customfield_12314520": null, "customfield_12314124": null, "customfield_12312340": null, "attachment": [], "customfield_12314123": null, "customfield_12312341": null, "customfield_12312220": null, "customfield_12314122": null, "customfield_12314121": null, "customfield_12314120": null, "customfield_12314129": null, "customfield_12314524": null, "customfield_12314128": null, "summary": "Excessive reconection delays due to hardcoded sleep intervals", "customfield_12314130": null, "customfield_12310291": null, "customfield_12310290": null, "customfield_12311024": null, "customfield_12314138": null, "customfield_12314137": null, "environment": null, "customfield_12314136": null, "customfield_12314135": null, "customfield_12311020": null, "customfield_12314134": null, "duedate": null, "customfield_12314132": null, "customfield_12314131": null, "comment": {"comments": [], "maxResults": 0, "total": 0, "startAt": 0}, "customfield_12311820": "0|z1tzmg:", "customfield_12314139": null}}