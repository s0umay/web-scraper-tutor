{"expand": "operations,versionedRepresentations,editmeta,changelog,renderedFields", "id": "13625569", "self": "https://issues.apache.org/jira/rest/api/2/issue/13625569", "key": "ZOOKEEPER-4956", "fields": {"fixVersions": [], "resolution": null, "customfield_12312322": null, "customfield_12312323": null, "customfield_12310420": "9223372036854775807", "customfield_12312320": null, "customfield_12312321": null, "customfield_12312328": null, "customfield_12312329": null, "customfield_12312326": null, "customfield_12310300": null, "customfield_12312327": null, "customfield_12312324": null, "customfield_12312720": null, "customfield_12312325": null, "lastViewed": null, "priority": {"self": "https://issues.apache.org/jira/rest/api/2/priority/3", "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/major.svg", "name": "Major", "id": "3"}, "labels": ["pull-request-available"], "customfield_12312333": null, "customfield_12312334": null, "customfield_12313422": "false", "customfield_12310310": "0.0", "customfield_12312331": null, "customfield_12312332": null, "aggregatetimeoriginalestimate": null, "timeestimate": 0, "customfield_12312330": null, "versions": [], "customfield_12311120": null, "customfield_12313826": null, "issuelinks": [], "customfield_12312339": null, "customfield_12313825": null, "assignee": null, "customfield_12312337": null, "customfield_12313823": null, "customfield_12312338": null, "customfield_12311920": null, "customfield_12313822": null, "customfield_12312335": null, "customfield_12313821": null, "customfield_12312336": null, "customfield_12313820": null, "status": {"self": "https://issues.apache.org/jira/rest/api/2/status/1", "description": "The issue is open and ready for the assignee to start work on it.", "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/open.png", "name": "Open", "id": "1", "statusCategory": {"self": "https://issues.apache.org/jira/rest/api/2/statuscategory/2", "id": 2, "key": "new", "colorName": "blue-gray", "name": "To Do"}}, "components": [{"self": "https://issues.apache.org/jira/rest/api/2/component/12312381", "id": "12312381", "name": "java client", "description": "The java client interface for ZooKeeper"}], "archiveddate": null, "customfield_12312026": null, "customfield_12312023": null, "customfield_12312024": null, "aggregatetimeestimate": 0, "customfield_12312022": null, "customfield_12310921": null, "customfield_12310920": "9223372036854775807", "customfield_12312823": null, "creator": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=liwang", "name": "liwang", "key": "liwang", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34044", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34044", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34044", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34044"}, "displayName": "Li Wang", "active": true, "timeZone": "America/Los_Angeles"}, "subtasks": [], "reporter": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=liwang", "name": "liwang", "key": "liwang", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34044", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34044", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34044", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34044"}, "displayName": "Li Wang", "active": true, "timeZone": "America/Los_Angeles"}, "aggregateprogress": {"progress": 2400, "total": 2400, "percent": 100}, "customfield_12313520": null, "customfield_12310250": null, "progress": {"progress": 2400, "total": 2400, "percent": 100}, "customfield_12313924": null, "votes": {"self": "https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-4956/votes", "votes": 0, "hasVoted": false}, "worklog": {"startAt": 0, "maxResults": 20, "total": 4, "worklogs": [{"self": "https://issues.apache.org/jira/rest/api/2/issue/13625569/worklog/984842", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "comment": "li4wang opened a new pull request, #2320:\nURL: https://github.com/apache/zookeeper/pull/2320\n\n   (no comment)\n\n\n", "created": "2025-09-27T04:24:06.467+0000", "updated": "2025-09-27T04:24:06.467+0000", "started": "2025-09-27T04:24:06.467+0000", "timeSpent": "10m", "timeSpentSeconds": 600, "id": "984842", "issueId": "13625569"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13625569/worklog/987397", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "comment": "anmolnar commented on code in PR #2320:\nURL: https://github.com/apache/zookeeper/pull/2320#discussion_r2433725664\n\n\n##########\nzookeeper-server/src/main/java/org/apache/zookeeper/client/HostConnectionManager.java:\n##########\n@@ -0,0 +1,391 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.zookeeper.client;\n+\n+import java.net.InetAddress;\n+import java.net.InetSocketAddress;\n+import java.net.UnknownHostException;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Random;\n+import org.apache.yetus.audience.InterfaceAudience;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * HostConnectionManager handles the complex connection management and reconfiguration logic\n\nReview Comment:\n   I'd rather explain the connection management logic in detail in Javadoc. \"handles complex logic\" is meaningless.\n\n\n\n##########\nzookeeper-server/src/main/java/org/apache/zookeeper/client/DnsSrvHostProvider.java:\n##########\n@@ -0,0 +1,383 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.zookeeper.client;\n+\n+import java.io.IOException;\n+import java.net.InetSocketAddress;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Timer;\n+import java.util.TimerTask;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+import java.util.concurrent.atomic.AtomicReference;\n+import org.apache.yetus.audience.InterfaceAudience;\n+import org.apache.zookeeper.common.StringUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.xbill.DNS.Lookup;\n+import org.xbill.DNS.Name;\n+import org.xbill.DNS.Record;\n+import org.xbill.DNS.SRVRecord;\n+import org.xbill.DNS.Type;\n+\n+/**\n+ * DNS SRV-based HostProvider that dynamically resolves host port names from DNS SRV records.\n+ *\n+ * <p>This implementation periodically refreshes the server list by querying DNS SRV records\n+ * and uses HostConnectionManager for all connection management and reconfiguration logic.</p>\n+ *\n+ *\n+ * <p><strong>Two-Phase Update Strategy:</strong></p>\n+ * <ul>\n+ * <li><strong>Phase 1 (Background):</strong> Timer thread detects DNS changes without blocking</li>\n+ * <li><strong>Phase 2 (Connection-time):</strong> Changes applied during actual connection attempts</li>\n+ * </ul>\n+ */\n+@InterfaceAudience.Public\n+public final class DnsSrvHostProvider implements HostProvider {\n+\n+    public interface DnsResolver {\n+        /**\n+         * Performs a DNS SRV lookup for the specified name.\n+         *\n+         * @param name the DNS name to look up\n+         * @return array of SRV records, empty array if no records found\n+         * @throws IOException if DNS lookup encounters an error\n+         */\n+        SRVRecord[] lookupSrvRecords(String name) throws IOException;\n+    }\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(DnsSrvHostProvider.class);\n+\n+    private final String dnsName;\n+    private final DnsResolver dnsResolver;\n+    private final long refreshIntervalMs;\n+    private final Timer dnsRefreshTimer;\n+    private HostConnectionManager connectionManager;\n+\n+    // Track the current connected host for accurate load balancing decisions\n+    private final AtomicReference<InetSocketAddress> currentConnectedHost = new AtomicReference<>();\n+    // Track the previous server list to detect changes\n+    private volatile List<InetSocketAddress> previousServerList = new ArrayList<>();\n+    private volatile List<InetSocketAddress> latestServerList = null;\n+    private final AtomicBoolean serverListChanged = new AtomicBoolean(false);\n+\n+    /**\n+     * Constructs a DnsSrvHostProvider with the given DNS name.\n+     *\n+     * @param dnsName the DNS name to query for SRV records\n+     * @throws IllegalArgumentException if dnsName is null or empty or invalid\n+     */\n+    public DnsSrvHostProvider(final String dnsName) {\n+        this(dnsName, System.currentTimeMillis() ^ dnsName.hashCode());\n+    }\n+\n+    /**\n+     * Constructs a DnsSrvHostProvider with deterministic randomness seed\n+     *\n+     * @param dnsName the DNS name to query for SRV records\n+     * @param randomnessSeed seed for randomization\n+     * @throws IllegalArgumentException if dnsName is null or empty or invalid\n+     */\n+    DnsSrvHostProvider(final String dnsName, final long randomnessSeed) {\n+        this(dnsName, randomnessSeed, new DefaultDnsResolver());\n+    }\n+\n+    /**\n+     * Constructs a DnsSrvHostProvider with the given DNS name, randomization seed and DNS resolver\n+     *\n+     * @param dnsName the DNS name to query for SRV records\n+     * @param randomnessSeed seed for randomization\n+     * @param dnsResolver custom DNS resolver for testing\n+     * @throws IllegalArgumentException if dnsName is null or empty or invalid\n+     */\n+    public DnsSrvHostProvider(final String dnsName, final long randomnessSeed, final DnsResolver dnsResolver) {\n+        this.dnsName = validateDnsName(dnsName);\n+        this.dnsResolver = dnsResolver;\n+        this.refreshIntervalMs = validateRefreshInterval();\n+        this.dnsRefreshTimer = initializeDnsRefreshTimer();\n+\n+        init(randomnessSeed);\n+    }\n+\n+    @Override\n+    public int size() {\n+        return connectionManager.size();\n+    }\n+\n+    @Override\n+    public InetSocketAddress next(long spinDelay) {\n+        applyPendingServerListUpdate();\n+        return connectionManager.next(spinDelay);\n+    }\n+\n+    @Override\n+    public void onConnected() {\n+        currentConnectedHost.set(connectionManager.getServerAtCurrentIndex());\n+        connectionManager.onConnected();\n+    }\n+\n+    @Override\n+    public boolean updateServerList(Collection<InetSocketAddress> serverAddresses, InetSocketAddress currentHost) {\n+        return connectionManager.updateServerList(serverAddresses, currentHost);\n+    }\n+\n+    @Override\n+    public void close() {\n+        if (dnsRefreshTimer != null) {\n+            dnsRefreshTimer.cancel();\n+        }\n+    }\n+\n+    @Override\n+    public ConnectionType getSupportedConnectionType() {\n+        return ConnectionType.DNS_SRV;\n+    }\n+\n+    /**\n+     * Validates and processes the DNS name.\n+     *\n+     * @param dnsName the DNS name to validate\n+     * @return the trimmed and validated DNS name\n+     * @throws IllegalArgumentException if dnsName is null, empty, or invalid\n+     */\n+    private String validateDnsName(final String dnsName) {\n+        if (StringUtils.isBlank(dnsName)) {\n+            throw new IllegalArgumentException(\"DNS name cannot be null or empty\");\n+        }\n+\n+        final String trimmedDnsName = dnsName.trim();\n+        // Ensure DNS name is absolute (ends with dot) for proper DNS resolution\n+        final String absoluteDnsName = trimmedDnsName.endsWith(\".\") ? trimmedDnsName : trimmedDnsName + \".\";\n+\n+        try {\n+            Name.fromString(absoluteDnsName);\n\nReview Comment:\n   You can do a lookup immediately in order to validate that the DNS name has valid SRV record.\n\n\n\n##########\nzookeeper-server/src/main/java/org/apache/zookeeper/client/DnsSrvHostProvider.java:\n##########\n@@ -0,0 +1,383 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.zookeeper.client;\n+\n+import java.io.IOException;\n+import java.net.InetSocketAddress;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Timer;\n+import java.util.TimerTask;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+import java.util.concurrent.atomic.AtomicReference;\n+import org.apache.yetus.audience.InterfaceAudience;\n+import org.apache.zookeeper.common.StringUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.xbill.DNS.Lookup;\n+import org.xbill.DNS.Name;\n+import org.xbill.DNS.Record;\n+import org.xbill.DNS.SRVRecord;\n+import org.xbill.DNS.Type;\n+\n+/**\n+ * DNS SRV-based HostProvider that dynamically resolves host port names from DNS SRV records.\n+ *\n+ * <p>This implementation periodically refreshes the server list by querying DNS SRV records\n+ * and uses HostConnectionManager for all connection management and reconfiguration logic.</p>\n+ *\n+ *\n+ * <p><strong>Two-Phase Update Strategy:</strong></p>\n+ * <ul>\n+ * <li><strong>Phase 1 (Background):</strong> Timer thread detects DNS changes without blocking</li>\n+ * <li><strong>Phase 2 (Connection-time):</strong> Changes applied during actual connection attempts</li>\n+ * </ul>\n+ */\n+@InterfaceAudience.Public\n+public final class DnsSrvHostProvider implements HostProvider {\n+\n+    public interface DnsResolver {\n+        /**\n+         * Performs a DNS SRV lookup for the specified name.\n+         *\n+         * @param name the DNS name to look up\n+         * @return array of SRV records, empty array if no records found\n+         * @throws IOException if DNS lookup encounters an error\n+         */\n+        SRVRecord[] lookupSrvRecords(String name) throws IOException;\n+    }\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(DnsSrvHostProvider.class);\n+\n+    private final String dnsName;\n+    private final DnsResolver dnsResolver;\n+    private final long refreshIntervalMs;\n+    private final Timer dnsRefreshTimer;\n+    private HostConnectionManager connectionManager;\n+\n+    // Track the current connected host for accurate load balancing decisions\n+    private final AtomicReference<InetSocketAddress> currentConnectedHost = new AtomicReference<>();\n+    // Track the previous server list to detect changes\n+    private volatile List<InetSocketAddress> previousServerList = new ArrayList<>();\n+    private volatile List<InetSocketAddress> latestServerList = null;\n+    private final AtomicBoolean serverListChanged = new AtomicBoolean(false);\n+\n+    /**\n+     * Constructs a DnsSrvHostProvider with the given DNS name.\n+     *\n+     * @param dnsName the DNS name to query for SRV records\n+     * @throws IllegalArgumentException if dnsName is null or empty or invalid\n+     */\n+    public DnsSrvHostProvider(final String dnsName) {\n+        this(dnsName, System.currentTimeMillis() ^ dnsName.hashCode());\n+    }\n+\n+    /**\n+     * Constructs a DnsSrvHostProvider with deterministic randomness seed\n+     *\n+     * @param dnsName the DNS name to query for SRV records\n+     * @param randomnessSeed seed for randomization\n+     * @throws IllegalArgumentException if dnsName is null or empty or invalid\n+     */\n+    DnsSrvHostProvider(final String dnsName, final long randomnessSeed) {\n+        this(dnsName, randomnessSeed, new DefaultDnsResolver());\n+    }\n+\n+    /**\n+     * Constructs a DnsSrvHostProvider with the given DNS name, randomization seed and DNS resolver\n+     *\n+     * @param dnsName the DNS name to query for SRV records\n+     * @param randomnessSeed seed for randomization\n+     * @param dnsResolver custom DNS resolver for testing\n+     * @throws IllegalArgumentException if dnsName is null or empty or invalid\n+     */\n+    public DnsSrvHostProvider(final String dnsName, final long randomnessSeed, final DnsResolver dnsResolver) {\n+        this.dnsName = validateDnsName(dnsName);\n+        this.dnsResolver = dnsResolver;\n+        this.refreshIntervalMs = validateRefreshInterval();\n+        this.dnsRefreshTimer = initializeDnsRefreshTimer();\n+\n+        init(randomnessSeed);\n+    }\n+\n+    @Override\n+    public int size() {\n+        return connectionManager.size();\n+    }\n+\n+    @Override\n+    public InetSocketAddress next(long spinDelay) {\n+        applyPendingServerListUpdate();\n+        return connectionManager.next(spinDelay);\n+    }\n+\n+    @Override\n+    public void onConnected() {\n+        currentConnectedHost.set(connectionManager.getServerAtCurrentIndex());\n+        connectionManager.onConnected();\n+    }\n+\n+    @Override\n+    public boolean updateServerList(Collection<InetSocketAddress> serverAddresses, InetSocketAddress currentHost) {\n+        return connectionManager.updateServerList(serverAddresses, currentHost);\n+    }\n+\n+    @Override\n+    public void close() {\n+        if (dnsRefreshTimer != null) {\n+            dnsRefreshTimer.cancel();\n+        }\n+    }\n+\n+    @Override\n+    public ConnectionType getSupportedConnectionType() {\n+        return ConnectionType.DNS_SRV;\n+    }\n+\n+    /**\n+     * Validates and processes the DNS name.\n+     *\n+     * @param dnsName the DNS name to validate\n+     * @return the trimmed and validated DNS name\n+     * @throws IllegalArgumentException if dnsName is null, empty, or invalid\n+     */\n+    private String validateDnsName(final String dnsName) {\n+        if (StringUtils.isBlank(dnsName)) {\n+            throw new IllegalArgumentException(\"DNS name cannot be null or empty\");\n+        }\n+\n+        final String trimmedDnsName = dnsName.trim();\n+        // Ensure DNS name is absolute (ends with dot) for proper DNS resolution\n+        final String absoluteDnsName = trimmedDnsName.endsWith(\".\") ? trimmedDnsName : trimmedDnsName + \".\";\n+\n+        try {\n+            Name.fromString(absoluteDnsName);\n+        } catch (final Exception e) {\n+            throw new IllegalArgumentException(\"Invalid DNS name format: \" + absoluteDnsName, e);\n+        }\n+        return absoluteDnsName;\n+    }\n+\n+    /**\n+     * Validates and returns the refresh interval\n+     *\n+     * @return the validated refresh interval in milliseconds\n+     */\n+    private long validateRefreshInterval() {\n+        final long defaultInterval = ZKClientConfig.DNS_SRV_REFRESH_INTERVAL_MS_DEFAULT;\n+\n+        final long interval = Long.getLong(ZKClientConfig.DNS_SRV_REFRESH_INTERVAL_MS, defaultInterval);\n+        if (interval < 0) {\n+            LOG.warn(\"Invalid refresh interval {}, using default {}\", interval, defaultInterval);\n+            return defaultInterval;\n+        }\n+        if (interval == 0) {\n+            LOG.info(\"DNS refresh disabled (interval = 0) for {}\", dnsName);\n+        }\n+        return interval;\n+    }\n+\n+\n+    /**\n+     * Initializes the DNS refresh timer if refresh interval is greater than 0.\n+     *\n+     * @return the initialized Timer or null if refresh interval is 0 or negative\n+     */\n+    private Timer initializeDnsRefreshTimer() {\n\nReview Comment:\n   I don't think you need this internal caching thing at all in ZooKeeper. DNS has its own multi-layer caching logic in the IP stack of the operating system and at the DNS resolver servers. Just query the SRV entry every time you run out of available servers and DNS will take care of the rest. There's not much benefit in caching something which is already cached in the host's memory.\n\n\n\n", "created": "2025-10-15T19:40:01.444+0000", "updated": "2025-10-15T19:40:01.444+0000", "started": "2025-10-15T19:40:01.443+0000", "timeSpent": "10m", "timeSpentSeconds": 600, "id": "987397", "issueId": "13625569"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13625569/worklog/987398", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "comment": "anmolnar commented on code in PR #2320:\nURL: https://github.com/apache/zookeeper/pull/2320#discussion_r2433741896\n\n\n##########\nzookeeper-server/pom.xml:\n##########\n@@ -190,6 +190,11 @@\n       <artifactId>commons-io</artifactId>\n       <scope>compile</scope>\n     </dependency>\n+    <dependency>\n+      <groupId>dnsjava</groupId>\n\nReview Comment:\n   Isn't there standard Java API for this which is not third party?\n\n\n\n", "created": "2025-10-15T19:43:32.308+0000", "updated": "2025-10-15T19:43:32.308+0000", "started": "2025-10-15T19:43:32.307+0000", "timeSpent": "10m", "timeSpentSeconds": 600, "id": "987398", "issueId": "13625569"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13625569/worklog/987399", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot", "name": "githubbot", "key": "githubbot", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "ASF GitHub Bot", "active": true, "timeZone": "Etc/UTC"}, "comment": "anmolnar commented on code in PR #2320:\nURL: https://github.com/apache/zookeeper/pull/2320#discussion_r2433749619\n\n\n##########\nzookeeper-server/src/main/java/org/apache/zookeeper/client/HostConnectionManager.java:\n##########\n@@ -0,0 +1,391 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.zookeeper.client;\n+\n+import java.net.InetAddress;\n+import java.net.InetSocketAddress;\n+import java.net.UnknownHostException;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Random;\n+import org.apache.yetus.audience.InterfaceAudience;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * HostConnectionManager handles the complex connection management and reconfiguration logic\n+ */\n+@InterfaceAudience.Private\n+public final class HostConnectionManager {\n\nReview Comment:\n   This could be the common abstract class for both implementations. Doing it with simple inheritance might be simpler than this composition where you just forward the calls to Connection Manager.\n\n\n\n##########\nzookeeper-server/src/main/java/org/apache/zookeeper/client/HostConnectionManager.java:\n##########\n@@ -0,0 +1,391 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.zookeeper.client;\n+\n+import java.net.InetAddress;\n+import java.net.InetSocketAddress;\n+import java.net.UnknownHostException;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Random;\n+import org.apache.yetus.audience.InterfaceAudience;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * HostConnectionManager handles the complex connection management and reconfiguration logic\n+ */\n+@InterfaceAudience.Private\n+public final class HostConnectionManager {\n\nReview Comment:\n   This could be the common abstract class for both implementations. Doing it with inheritance might be simpler than this composition where you just forward the calls to Connection Manager.\n\n\n\n", "created": "2025-10-15T19:46:48.403+0000", "updated": "2025-10-15T19:46:48.403+0000", "started": "2025-10-15T19:46:48.402+0000", "timeSpent": "10m", "timeSpentSeconds": 600, "id": "987399", "issueId": "13625569"}]}, "archivedby": null, "customfield_12313920": null, "issuetype": {"self": "https://issues.apache.org/jira/rest/api/2/issuetype/2", "id": "2", "description": "A new feature of the product, which has yet to be developed.", "iconUrl": "https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21141&avatarType=issuetype", "name": "New Feature", "subtask": false, "avatarId": 21141}, "timespent": 2400, "customfield_12314020": "{summaryBean=com.atlassian.jira.plugin.devstatus.rest.SummaryBean@302fb7b4[summary={pullrequest=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@55e84f2[overall=PullRequestOverallBean{stateCount=0, state='OPEN', details=PullRequestOverallDetails{openCount=0, mergedCount=0, declinedCount=0}},byInstanceType={}], build=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@7ab3897a[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BuildOverallBean@bbbebca[failedBuildCount=0,successfulBuildCount=0,unknownBuildCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], review=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@511eecc0[overall=com.atlassian.jira.plugin.devstatus.summary.beans.ReviewsOverallBean@674617d[stateCount=0,state=<null>,dueDate=<null>,overDue=false,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], deployment-environment=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@606ad090[overall=com.atlassian.jira.plugin.devstatus.summary.beans.DeploymentOverallBean@345b82ec[topEnvironments=[],showProjects=false,successfulCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], repository=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@1205004b[overall=com.atlassian.jira.plugin.devstatus.summary.beans.CommitOverallBean@375fe4ff[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], branch=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@1874cd4[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BranchOverallBean@69a3f2ea[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}]},errors=[],configErrors=[]], devSummaryJson={\"cachedValue\":{\"errors\":[],\"configErrors\":[],\"summary\":{\"pullrequest\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":\"OPEN\",\"details\":{\"openCount\":0,\"mergedCount\":0,\"declinedCount\":0,\"total\":0},\"open\":true},\"byInstanceType\":{}},\"build\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"failedBuildCount\":0,\"successfulBuildCount\":0,\"unknownBuildCount\":0},\"byInstanceType\":{}},\"review\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":null,\"dueDate\":null,\"overDue\":false,\"completed\":false},\"byInstanceType\":{}},\"deployment-environment\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"topEnvironments\":[],\"showProjects\":false,\"successfulCount\":0},\"byInstanceType\":{}},\"repository\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}},\"branch\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}}}},\"isStale\":false}}", "customfield_12314141": null, "customfield_12314140": null, "project": {"self": "https://issues.apache.org/jira/rest/api/2/project/12310801", "id": "12310801", "key": "ZOOKEEPER", "name": "ZooKeeper", "projectTypeKey": "software", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/projectavatar?pid=12310801&avatarId=10011", "24x24": "https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310801&avatarId=10011", "16x16": "https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310801&avatarId=10011", "32x32": "https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310801&avatarId=10011"}, "projectCategory": {"self": "https://issues.apache.org/jira/rest/api/2/projectCategory/10484", "id": "10484", "description": "Apache ZooKeeper related", "name": "ZooKeeper"}}, "aggregatetimespent": 2400, "customfield_12312520": null, "customfield_12312521": "Tue Aug 05 18:01:10 UTC 2025", "customfield_12314422": null, "customfield_12314421": null, "customfield_12314146": null, "customfield_12314420": null, "customfield_12314145": null, "customfield_12314144": null, "customfield_12314143": null, "resolutiondate": null, "workratio": -1, "customfield_12312923": null, "customfield_12312920": null, "customfield_12312921": null, "watches": {"self": "https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-4956/watchers", "watchCount": 1, "isWatching": false}, "created": "2025-08-05T17:49:02.000+0000", "customfield_12310192": null, "customfield_12310191": null, "customfield_12310230": null, "updated": "2025-10-15T19:46:48.000+0000", "timeoriginalestimate": null, "description": "Currently, ZooKeeper clients use static configuration of server endpoints through connection strings. This creates operational challenges in dynamic environments like cloud deployments, container orchestration platforms, and auto-scaling scenarios. \r\n\r\nFor example, server topology change requires updating all client configurations and potentially restarting al client applications.\r\n\r\n\r\nThis ticket provides a `DnsSrvHostProvider` that leverages DNS SRV records for dynamic service discovery, allowing clients to automatically discover ZooKeeper servers without hardcoded configuration.", "customfield_10010": null, "timetracking": {"remainingEstimate": "0h", "timeSpent": "40m", "remainingEstimateSeconds": 0, "timeSpentSeconds": 2400}, "customfield_12314523": null, "customfield_12314127": null, "customfield_12314522": null, "customfield_12314126": null, "customfield_12314521": null, "customfield_12314125": null, "customfield_12314520": null, "customfield_12314124": null, "customfield_12312340": null, "attachment": [], "customfield_12314123": null, "customfield_12312341": null, "customfield_12312220": null, "customfield_12314122": null, "customfield_12314121": null, "customfield_12314120": null, "customfield_12314129": null, "customfield_12314524": null, "customfield_12314128": null, "summary": "Provide a HostProvider that uses DNS SRV record for dynamic server discovery", "customfield_12314130": null, "customfield_12310291": null, "customfield_12310290": null, "customfield_12311024": null, "customfield_12314138": null, "customfield_12314137": null, "environment": "* ", "customfield_12314136": null, "customfield_12314135": null, "customfield_12311020": null, "customfield_12314134": null, "duedate": null, "customfield_12314132": null, "customfield_12314131": null, "comment": {"comments": [{"self": "https://issues.apache.org/jira/rest/api/2/issue/13625569/comment/18012185", "id": "18012185", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=liwang", "name": "liwang", "key": "liwang", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34044", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34044", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34044", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34044"}, "displayName": "Li Wang", "active": true, "timeZone": "America/Los_Angeles"}, "body": "This ticket is for Java implementation.", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=liwang", "name": "liwang", "key": "liwang", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34044", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34044", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34044", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34044"}, "displayName": "Li Wang", "active": true, "timeZone": "America/Los_Angeles"}, "created": "2025-08-05T18:01:10.207+0000", "updated": "2025-08-05T18:01:10.207+0000"}], "maxResults": 1, "total": 1, "startAt": 0}, "customfield_12311820": "0|z1x494:", "customfield_12314139": null}}